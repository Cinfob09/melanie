This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.bolt/
  config.json
  prompt
.github/
  workflows/
    main.yml
netlify/
  functions/
    auth.js
src/
  components/
    Admin/
      AdminDashboard.tsx
    Analytics/
      Analytics.tsx
      ExpenseStats.tsx
      MonthlyAnalysis.tsx
      RevenueStats.tsx
      TaxCalculator.tsx
    Calendar/
      AppointmentCard.tsx
      AppointmentModal.tsx
      Calendar.tsx
    Clients/
      AddressInput.tsx
      ClientList.tsx
      ClientModal.tsx
    Dashboard/
      Dashboard.tsx
    Expenses/
      ExpenseList.tsx
      ExpenseModal.tsx
      Expenses.tsx
    Layout/
      Sidebar.tsx
    MyDay/
      MyDay.tsx
    Notifications/
      Notifications.tsx
    Payment/
      PaymentWarningModal.tsx
    Preferences/
      Preferences.tsx
    Settings/
      PasskeyModal.tsx
      Settings.tsx
    Toast/
      ToastContainer.tsx
    Users/
      Toast/
        ToastContainer.tsx
      UserManagement.tsx
      UserModal.tsx
    LoginForm.tsx
  hooks/
    useActivityLogs.ts
    useAppointments.ts
    useAuth.ts
    useClients.ts
    useExpenses.ts
    useNotificationGenerator.ts
    usePreferences.ts
    useServices.ts
    useToast.ts
  lib/
    supabase.ts
  pages/
    loginPage.tsx
  types/
    index.ts
    toast.ts
  utils/
    statistics.ts
  App.tsx
  index.css
  index.tsx
  main.tsx
  vite-env.d.ts
supabase/
  migrations/
    20250803171015_misty_cliff.sql
    20250907175927_broad_heart.sql
    20251116030201_20250802123729_dusty_water.sql
    20251116030215_20250907175927_broad_heart.sql
    20251116030222_create_activity_logs_table.sql
    20260104032659_create_expenses_table.sql
.gitignore
eslint.config.js
index.html
package.json
postcss.config.js
tailwind.config.js
tsconfig.app.json
tsconfig.json
tsconfig.node.json
vite.config.ts
vite.config.ts.timestamp-1768313357344-fd5005d808a2a8.mjs
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="src/hooks/useNotificationGenerator.ts">
import { useEffect } from 'react';
import { supabase } from '../lib/supabase';
import { Appointment, Client } from '../types';
import { usePreferences } from './usePreferences';

export const useNotificationGenerator = (
  appointments: Appointment[],
  clients: Client[],
  isLoading: boolean // <--- NOUVEAU : On doit savoir si ça charge encore
) => {
  const { preferences } = usePreferences();

  useEffect(() => {
    const generate = async () => {
      // 1. SÉCURITÉ : Si ça charge ou si pas de données, on touche à rien !
      if (isLoading || !preferences || clients.length === 0) return;

      // 2. ÉCONOMIE DE REQUÊTES : On vérifie si on a déjà fait le check aujourd'hui
      const today = new Date().toISOString().split('T')[0];
      const lastCheck = localStorage.getItem('notification_last_check');
      const currentUserId = (await supabase.auth.getUser()).data.user?.id;

      // Si on a déjà checké aujourd'hui pour cet user, on arrête tout.
      if (lastCheck === `${currentUserId}_${today}`) {
        console.log("Notifications déjà vérifiées aujourd'hui. Stop.");
        return;
      }

      if (!currentUserId) return;

      console.log("Génération des notifications en cours...");
      const notificationsToUpsert = [];

      try {
        // --- A. Rendez-vous à venir (Upcoming) ---
        if (preferences.show_upcoming_appointments) {
          const daysAhead = preferences.upcoming_appointments_days || 1;
          const futureDate = new Date();
          futureDate.setDate(futureDate.getDate() + daysAhead);
          const futureDateStr = futureDate.toISOString().split('T')[0];

          const upcoming = appointments.filter(
            (apt) =>
              apt.date >= today &&
              apt.date <= futureDateStr &&
              apt.status === 'scheduled'
          );

          if (upcoming.length > 0) {
            notificationsToUpsert.push({
              user_id: currentUserId,
              type: 'upcoming_appointment',
              title: daysAhead === 1 ? "Rendez-vous aujourd'hui" : `Rendez-vous dans ${daysAhead} jours`,
              message: `Vous avez ${upcoming.length} rendez-vous prévu(s)`,
              date: new Date().toISOString(),
              priority: daysAhead === 1 ? 'high' : 'medium',
              completed: false,
              client_id: null, // Pas lié à un client spécifique
            });
          }
        }

        // --- B. Logique Clients (Manquants & Fréquence) ---
        if (preferences.show_frequency_reminders) {
          for (const client of clients) {
            const clientApts = appointments.filter(a => a.client_id === client.id);

            // Cas 1 : Jamais de RDV (Missing)
            if (clientApts.length === 0) {
               // ATTENTION : C'est ici que ça buggait avant si appointments était vide à cause du chargement
               notificationsToUpsert.push({
                user_id: currentUserId,
                type: 'missing_appointment',
                title: 'Aucun rendez-vous planifié',
                message: `${client.name} n'a jamais eu de rendez-vous`,
                date: new Date().toISOString(),
                priority: 'medium',
                completed: false,
                client_id: client.id,
                client_name: client.name,
              });
            } 
            // Cas 2 : Fréquence (Reminder)
            else {
              // Trouver le dernier RDV
              const lastApt = clientApts.reduce((latest, current) => {
                return new Date(current.date) > new Date(latest.date) ? current : latest;
              });

              const daysSince = Math.floor(
                (new Date().getTime() - new Date(lastApt.date).getTime()) / (1000 * 60 * 60 * 24)
              );

              // Calcul de la fréquence cible
              let freqDays = 30;
              if (client.frequency === 'custom') {
                freqDays = client.customFrequencyDays || 30;
              } else {
                const opt = preferences.frequency_options.find((o: any) => o.value === client.frequency);
                if (opt) freqDays = opt.days;
              }

              if (daysSince > freqDays) {
                notificationsToUpsert.push({
                  user_id: currentUserId,
                  type: 'frequency_reminder',
                  title: 'Rappel de fréquence',
                  message: `${client.name} : dernier rendez-vous il y a ${daysSince} jours (fréquence : ${freqDays} jours)`,
                  date: new Date().toISOString(),
                  priority: 'low',
                  completed: false,
                  client_id: client.id,
                  client_name: client.name,
                });
              }
            }
          }
        }

        // --- C. ENVOI UNIQUE (BATCH) ---
        if (notificationsToUpsert.length > 0) {
          const { error } = await supabase
            .from('notifications')
            .upsert(notificationsToUpsert, { 
              onConflict: 'user_id, client_id, type', // L'index SQL fait le travail ici
              ignoreDuplicates: true 
            });

          if (error) console.error("Erreur save notifs:", error);
          else console.log(`${notificationsToUpsert.length} notifications traitées.`);
        }

        // Marquer comme fait pour aujourd'hui dans le navigateur
        localStorage.setItem('notification_last_check', `${currentUserId}_${today}`);

      } catch (err) {
        console.error("Erreur générateur notifs:", err);
      }
    };

    generate();
    // On relance UNIQUEMENT si isLoading passe de true à false, ou si les données changent
  }, [isLoading, appointments.length, clients.length, preferences]); 
};
</file>

<file path=".bolt/config.json">
{
  "template": "bolt-vite-react-ts"
}
</file>

<file path=".bolt/prompt">
For all designs I ask you to make, have them be beautiful, not cookie cutter. Make webpages that are fully featured and worthy for production.

By default, this template supports JSX syntax with Tailwind CSS classes, React hooks, and Lucide React for icons. Do not install other packages for UI themes, icons, etc unless absolutely necessary or I request them.

Use icons from lucide-react for logos.
</file>

<file path="netlify/functions/auth.js">
const { createClient } = require('@supabase/supabase-js');
const jwt = require('jsonwebtoken');

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_KEY // Use service key on backend
);

exports.handler = async (event, context) => {
  if (event.httpMethod !== 'POST') {
    return {
      statusCode: 405,
      body: JSON.stringify({ error: 'Method not allowed' })
    };
  }

  try {
    const { action, email, password } = JSON.parse(event.body);

    switch (action) {
      case 'login':
        // Authenticate with Supabase
        const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
          email,
          password
        });

        if (authError) {
          return {
            statusCode: 401,
            body: JSON.stringify({ success: false, error: 'Invalid credentials' })
          };
        }

        // Get user profile from your auth.users table or public.user_profiles
        const { data: userProfile, error: profileError } = await supabase
          .from('auth.users') // or 'user_profiles' if you create one in public schema
          .select('*')
          .eq('id', authData.user.id)
          .single();

        // Create a JWT token for frontend use
        const token = jwt.sign(
          { 
            userId: authData.user.id, 
            email: authData.user.email,
            role: userProfile?.role || 'user'
          },
          process.env.JWT_SECRET,
          { expiresIn: '24h' }
        );

        return {
          statusCode: 200,
          body: JSON.stringify({
            success: true,
            token,
            user: {
              id: authData.user.id,
              email: authData.user.email,
              role: userProfile?.role || 'user'
            }
          })
        };

      case 'register':
        // Handle registration
        const { data: newUser, error: regError } = await supabase.auth.signUp({
          email,
          password
        });

        if (regError) {
          return {
            statusCode: 400,
            body: JSON.stringify({ success: false, error: regError.message })
          };
        }

        return {
          statusCode: 200,
          body: JSON.stringify({ success: true, user: newUser })
        };

      default:
        return {
          statusCode: 400,
          body: JSON.stringify({ error: 'Invalid action' })
        };
    }

  } catch (error) {
    console.error('Auth function error:', error);
    return {
      statusCode: 500,
      body: JSON.stringify({ error: 'Internal server error' })
    };
  }
</file>

<file path="src/components/Admin/AdminDashboard.tsx">
import React, { useState, useEffect } from 'react';
import {
  Users,
  CheckCircle,
  XCircle,
  DollarSign,
  Search,
  Mail,
  Edit,
  Trash2,
  UserPlus,
  BarChart3,
  Loader2,
  AlertTriangle,
  X,
  CreditCard,
  FileText,
} from 'lucide-react';
import { supabase } from '../../lib/supabase';

// --- INTERFACES ADAPTÉES À VOTRE SCHÉMA ---
interface Client {
  id: string;
  name: string; // user_profiles.full_name
  email: string; // user_profiles.email
  // phone retiré car absent de la DB
  plan: 'basic' | 'pro' | 'enterprise'; // user_profiles.subscription_status
  status: 'active' | 'inactive' | 'suspended'; // user_profiles.payment_status
  createdAt: string; // user_profiles.created_at
}

interface Payment {
  id: string;
  clientId: string;
  amount: number;
  date: string;
  method: string;
  status: 'completed' | 'pending' | 'failed';
  notes?: string;
}

interface Toast {
  id: number;
  message: string;
  type: 'success' | 'error' | 'info';
}

interface AdminDashboardProps {
  onLogout?: () => void;
  onMenuToggle?: () => void;
}

const AdminDashboard: React.FC<AdminDashboardProps> = ({ onLogout }) => {
  const [clients, setClients] = useState<Client[]>([]);
  const [payments, setPayments] = useState<Payment[]>([]);
  const [loading, setLoading] = useState(true);

  const [searchTerm, setSearchTerm] = useState('');
  const [filterStatus, setFilterStatus] = useState<
    'all' | 'active' | 'inactive'
  >('all');
  const [selectedTab, setSelectedTab] = useState<
    'overview' | 'clients' | 'payments'
  >('overview');

  // Modals
  const [showAddModal, setShowAddModal] = useState(false);
  const [editingClient, setEditingClient] = useState<Client | null>(null);
  const [clientToDelete, setClientToDelete] = useState<Client | null>(null);
  const [toasts, setToasts] = useState<Toast[]>([]);

  const [newClient, setNewClient] = useState({
    name: '',
    email: '',
    plan: 'basic' as 'basic' | 'pro' | 'enterprise',
  });

  // --- NOTIFICATIONS ---
  const addToast = (
    message: string,
    type: 'success' | 'error' | 'info' = 'success'
  ) => {
    const id = Date.now();
    setToasts((prev) => [...prev, { id, message, type }]);
    setTimeout(() => removeToast(id), 4000);
  };

  const removeToast = (id: number) => {
    setToasts((prev) => prev.filter((t) => t.id !== id));
  };

  // --- CHARGEMENT ---
  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    setLoading(true);
    try {
      // 1. Récupération Clients
      const { data: profilesData, error: profilesError } = await supabase
        .from('user_profiles')
        .select('*')
        .neq('role', 'admin')
        .order('created_at', { ascending: false });

      if (profilesError) throw profilesError;

      // 2. Récupération Historique Paiements
      const { data: paymentsData, error: paymentsError } = await supabase
        .from('payment_history')
        .select('*')
        .order('payment_date', { ascending: false });

      if (paymentsError) throw paymentsError;

      // 3. Mapping Clients (Sans Phone, avec subscription_status)
      const formattedClients: Client[] = (profilesData || []).map((p) => ({
        id: p.id,
        name: p.full_name || 'Sans nom',
        email: p.email || '',
        plan: p.subscription_status || 'basic', // <--- CORRECTION ICI
        status: (p.payment_status as any) || 'inactive',
        createdAt: p.created_at,
      }));

      // 4. Mapping Paiements
      const formattedPayments: Payment[] = (paymentsData || []).map((p) => ({
        id: p.id,
        clientId: p.user_id,
        amount: p.amount,
        date: p.payment_date,
        method: p.payment_method || 'Inconnu',
        status: p.status,
        notes: p.notes,
      }));

      setClients(formattedClients);
      setPayments(formattedPayments);
    } catch (error: any) {
      console.error('Erreur data:', error);
      addToast('Erreur chargement: ' + error.message, 'error');
    } finally {
      setLoading(false);
    }
  };

  // --- ACTIONS CRUD ---

  const handleAddClient = async () => {
    if (!newClient.name || !newClient.email) {
      addToast('Nom et email requis', 'error');
      return;
    }

    try {
      // CORRECTION : Pas de colonne 'phone', mapping correct des champs
      const { data, error } = await supabase
        .from('user_profiles')
        .insert([
          {
            full_name: newClient.name,
            email: newClient.email,
            subscription_status: newClient.plan, // <--- CORRECTION ICI
            payment_status: 'inactive',
            // Pas de phone ici
          },
        ])
        .select()
        .single();

      if (error) throw error;

      const createdClient: Client = {
        id: data.id,
        name: data.full_name,
        email: data.email,
        plan: data.subscription_status,
        status: data.payment_status,
        createdAt: data.created_at,
      };

      setClients([createdClient, ...clients]);
      setNewClient({ name: '', email: '', plan: 'basic' });
      setShowAddModal(false);
      addToast('Client ajouté (DB)', 'success');
    } catch (error: any) {
      console.error('Erreur ajout:', error);
      addToast('Erreur ajout: ' + error.message, 'error');
    }
  };

  const handleUpdateClient = async () => {
    if (!editingClient) return;

    try {
      // CORRECTION : Pas de phone, utilisation de subscription_status
      const { error } = await supabase
        .from('user_profiles')
        .update({
          full_name: editingClient.name,
          email: editingClient.email,
          subscription_status: editingClient.plan, // <--- CORRECTION ICI
        })
        .eq('id', editingClient.id);

      if (error) throw error;

      setClients(
        clients.map((c) => (c.id === editingClient.id ? editingClient : c))
      );
      setEditingClient(null);
      addToast('Client mis à jour', 'success');
    } catch (error: any) {
      addToast('Erreur modif: ' + error.message, 'error');
    }
  };

  const toggleClientStatus = async (client: Client) => {
    const newStatus = client.status === 'active' ? 'inactive' : 'active';

    try {
      const { error } = await supabase
        .from('user_profiles')
        .update({ payment_status: newStatus })
        .eq('id', client.id);

      if (error) throw error;

      setClients(
        clients.map((c) =>
          c.id === client.id ? { ...c, status: newStatus } : c
        )
      );
      addToast(`Statut changé: ${newStatus}`, 'info');
    } catch (error: any) {
      addToast('Erreur statut: ' + error.message, 'error');
    }
  };

  const confirmDeleteClient = async () => {
    if (!clientToDelete) return;

    try {
      await supabase
        .from('payment_history')
        .delete()
        .eq('user_id', clientToDelete.id);

      const { error } = await supabase
        .from('user_profiles')
        .delete()
        .eq('id', clientToDelete.id);

      if (error) throw error;

      setClients(clients.filter((c) => c.id !== clientToDelete.id));
      setPayments(payments.filter((p) => p.clientId !== clientToDelete.id));

      addToast('Client supprimé', 'success');
      setClientToDelete(null);
    } catch (error: any) {
      addToast('Erreur suppression: ' + error.message, 'error');
    }
  };

  // --- FILTRES SÉCURISÉS ---
  const filteredClients = clients.filter((client) => {
    const name = client.name || '';
    const email = client.email || '';
    const term = searchTerm || '';

    const matchesSearch =
      name.toLowerCase().includes(term.toLowerCase()) ||
      email.toLowerCase().includes(term.toLowerCase());
    const matchesFilter =
      filterStatus === 'all' || client.status === filterStatus;
    return matchesSearch && matchesFilter;
  });

  const stats = {
    totalClients: clients.length,
    activeClients: clients.filter((c) => c.status === 'active').length,
    totalRevenue: payments.reduce((sum, p) => sum + p.amount, 0),
    monthlyRevenue: payments
      .filter((p) => {
        const d = new Date(p.date);
        const now = new Date();
        return (
          d.getMonth() === now.getMonth() &&
          d.getFullYear() === now.getFullYear()
        );
      })
      .reduce((sum, p) => sum + p.amount, 0),
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 relative">
      {/* TOASTS */}
      <div className="fixed bottom-4 right-4 z-50 flex flex-col gap-2">
        {toasts.map((t) => (
          <div
            key={t.id}
            className={`flex items-center p-4 rounded-lg shadow-lg text-white min-w-[300px] animate-slide-up ${
              t.type === 'success'
                ? 'bg-green-600'
                : t.type === 'error'
                ? 'bg-red-600'
                : 'bg-blue-600'
            }`}
          >
            {t.type === 'success' && <CheckCircle className="w-5 h-5 mr-3" />}
            {t.type === 'error' && <XCircle className="w-5 h-5 mr-3" />}
            {t.type === 'info' && <AlertTriangle className="w-5 h-5 mr-3" />}
            <span className="flex-1 text-sm font-medium">{t.message}</span>
            <button
              onClick={() => removeToast(t.id)}
              className="ml-3 hover:opacity-80"
            >
              <X className="w-4 h-4" />
            </button>
          </div>
        ))}
      </div>

      {/* HEADER */}
      <header className="bg-white border-b sticky top-0 z-10 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-4">
            <div className="flex items-center space-x-3">
              <div className="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center">
                <Users className="w-6 h-6 text-white" />
              </div>
              <div>
                <h1 className="text-2xl font-bold text-gray-900">
                  Admin Dashboard
                </h1>
                <p className="text-sm text-gray-500">Supabase Connected</p>
              </div>
            </div>

            <button
              onClick={onLogout}
              className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"
            >
              Déconnexion
            </button>
          </div>
        </div>
      </header>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* TABS */}
        <div className="mb-6 border-b border-gray-200">
          <nav className="flex space-x-8">
            {[
              { id: 'overview', label: "Vue d'ensemble", icon: BarChart3 },
              { id: 'clients', label: 'Clients', icon: Users },
              { id: 'payments', label: 'Paiements', icon: DollarSign },
            ].map((tab) => (
              <button
                key={tab.id}
                onClick={() => setSelectedTab(tab.id as any)}
                className={`flex items-center space-x-2 py-4 px-1 border-b-2 font-medium text-sm transition ${
                  selectedTab === tab.id
                    ? 'border-indigo-500 text-indigo-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
              >
                <tab.icon className="w-5 h-5" />
                <span>{tab.label}</span>
              </button>
            ))}
          </nav>
        </div>

        {/* OVERVIEW */}
        {selectedTab === 'overview' && (
          <div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
              <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600">
                      Total Clients
                    </p>
                    <p className="text-3xl font-bold text-gray-900 mt-2">
                      {stats.totalClients}
                    </p>
                  </div>
                  <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <Users className="w-6 h-6 text-blue-600" />
                  </div>
                </div>
              </div>
              <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600">
                      Revenus ce mois
                    </p>
                    <p className="text-3xl font-bold text-gray-900 mt-2">
                      {stats.monthlyRevenue.toFixed(2)}€
                    </p>
                  </div>
                  <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <DollarSign className="w-6 h-6 text-purple-600" />
                  </div>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
              <h3 className="text-lg font-semibold mb-4">Activité récente</h3>
              <div className="space-y-4">
                {payments.slice(0, 5).map((payment) => {
                  const client = clients.find((c) => c.id === payment.clientId);
                  return (
                    <div
                      key={payment.id}
                      className="flex items-center justify-between py-3 border-b last:border-0"
                    >
                      <div className="flex items-center space-x-4">
                        <div className="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                          <DollarSign className="w-5 h-5 text-green-600" />
                        </div>
                        <div>
                          <p className="font-medium text-gray-900">
                            {client?.name || 'Inconnu'}
                          </p>
                          <div className="flex items-center gap-2 text-sm text-gray-500">
                            <CreditCard className="w-3 h-3" />
                            {payment.method}
                          </div>
                        </div>
                      </div>
                      <div className="text-right">
                        <p className="font-semibold text-gray-900">
                          {payment.amount}€
                        </p>
                        <p className="text-sm text-gray-500">
                          {new Date(payment.date).toLocaleDateString('fr-FR')}
                        </p>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}

        {/* CLIENTS */}
        {selectedTab === 'clients' && (
          <div>
            <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
              <div className="flex flex-col sm:flex-row gap-4 items-center justify-between">
                <div className="flex-1 w-full sm:max-w-md">
                  <div className="relative">
                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                    <input
                      type="text"
                      placeholder="Rechercher (nom ou email)..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                  </div>
                </div>
                <div className="flex gap-3 w-full sm:w-auto">
                  <select
                    value={filterStatus}
                    onChange={(e) => setFilterStatus(e.target.value as any)}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  >
                    <option value="all">Tous</option>
                    <option value="active">Actifs</option>
                    <option value="inactive">Inactifs</option>
                  </select>
                  <button
                    onClick={() => setShowAddModal(true)}
                    className="flex items-center space-x-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
                  >
                    <UserPlus className="w-5 h-5" />
                    <span>Ajouter</span>
                  </button>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50 border-b border-gray-200">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Client
                      </th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Email
                      </th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Plan
                      </th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Statut
                      </th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Créé le
                      </th>
                      <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Actions
                      </th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {filteredClients.map((client) => (
                      <tr
                        key={client.id}
                        className="hover:bg-gray-50 transition"
                      >
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center">
                            <div className="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
                              <span className="text-indigo-600 font-semibold">
                                {(client.name || '?').charAt(0).toUpperCase()}
                              </span>
                            </div>
                            <div className="ml-4">
                              <div className="text-sm font-medium text-gray-900">
                                {client.name || 'Inconnu'}
                              </div>
                            </div>
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center text-sm text-gray-500">
                            <Mail className="w-4 h-4 mr-2" />
                            {client.email || '-'}
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span className="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            {client.plan}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span
                            className={`flex items-center ${
                              client.status === 'active'
                                ? 'text-green-600'
                                : 'text-red-600'
                            }`}
                          >
                            {client.status === 'active' ? (
                              <CheckCircle className="w-5 h-5 mr-1" />
                            ) : (
                              <XCircle className="w-5 h-5 mr-1" />
                            )}
                            {client.status === 'active' ? 'Actif' : 'Inactif'}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          {client.createdAt
                            ? new Date(client.createdAt).toLocaleDateString(
                                'fr-FR'
                              )
                            : '-'}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                          <div className="flex items-center justify-end space-x-2">
                            <button
                              onClick={() => toggleClientStatus(client)}
                              className={`px-3 py-1 rounded-lg text-white transition ${
                                client.status === 'active'
                                  ? 'bg-yellow-500 hover:bg-yellow-600'
                                  : 'bg-green-500 hover:bg-green-600'
                              }`}
                            >
                              {client.status === 'active'
                                ? 'Désactiver'
                                : 'Activer'}
                            </button>
                            <button
                              onClick={() => setEditingClient(client)}
                              className="p-2 text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition"
                            >
                              <Edit className="w-4 h-4" />
                            </button>
                            <button
                              onClick={() => setClientToDelete(client)}
                              className="p-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}

        {/* PAYMENTS */}
        {selectedTab === 'payments' && (
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Client
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Méthode
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Montant
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Date
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Statut
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Notes
                    </th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {payments.map((payment) => {
                    const client = clients.find(
                      (c) => c.id === payment.clientId
                    );
                    return (
                      <tr
                        key={payment.id}
                        className="hover:bg-gray-50 transition"
                      >
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="text-sm font-medium text-gray-900">
                            {client?.name || 'Inconnu'}
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center text-sm text-gray-600">
                            <CreditCard className="w-4 h-4 mr-2" />
                            {payment.method}
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                          {payment.amount.toFixed(2)}€
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          {new Date(payment.date).toLocaleDateString('fr-FR')}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span
                            className={`px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                              payment.status === 'completed'
                                ? 'bg-green-100 text-green-800'
                                : 'bg-red-100 text-red-800'
                            }`}
                          >
                            {payment.status}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          {payment.notes && (
                            <div className="group relative">
                              <FileText className="w-4 h-4 cursor-pointer text-gray-400 hover:text-indigo-600" />
                              <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 bg-gray-900 text-white text-xs p-2 rounded hidden group-hover:block z-20">
                                {payment.notes}
                              </div>
                            </div>
                          )}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </div>

      {/* ADD MODAL */}
      {showAddModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 animate-fade-in">
          <div className="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 animate-scale-up">
            <h2 className="text-2xl font-bold mb-6">Ajouter un client</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Nom complet *
                </label>
                <input
                  type="text"
                  value={newClient.name}
                  onChange={(e) =>
                    setNewClient({ ...newClient, name: e.target.value })
                  }
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Email *
                </label>
                <input
                  type="email"
                  value={newClient.email}
                  onChange={(e) =>
                    setNewClient({ ...newClient, email: e.target.value })
                  }
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              {/* Pas de champ téléphone */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Plan
                </label>
                <select
                  value={newClient.plan}
                  onChange={(e) =>
                    setNewClient({ ...newClient, plan: e.target.value as any })
                  }
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                >
                  <option value="basic">Basic</option>
                  <option value="pro">Pro</option>
                  <option value="enterprise">Enterprise</option>
                </select>
              </div>
            </div>
            <div className="flex space-x-3 mt-6">
              <button
                onClick={() => setShowAddModal(false)}
                className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
              >
                Annuler
              </button>
              <button
                onClick={handleAddClient}
                className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
              >
                Ajouter DB
              </button>
            </div>
          </div>
        </div>
      )}

      {/* EDIT MODAL */}
      {editingClient && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 animate-fade-in">
          <div className="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 animate-scale-up">
            <h2 className="text-2xl font-bold mb-6">Modifier le client</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Nom complet
                </label>
                <input
                  type="text"
                  value={editingClient.name}
                  onChange={(e) =>
                    setEditingClient({ ...editingClient, name: e.target.value })
                  }
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Email
                </label>
                <input
                  type="email"
                  value={editingClient.email}
                  onChange={(e) =>
                    setEditingClient({
                      ...editingClient,
                      email: e.target.value,
                    })
                  }
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              {/* Pas de champ téléphone */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Plan
                </label>
                <select
                  value={editingClient.plan}
                  onChange={(e) =>
                    setEditingClient({
                      ...editingClient,
                      plan: e.target.value as any,
                    })
                  }
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                >
                  <option value="basic">Basic</option>
                  <option value="pro">Pro</option>
                  <option value="enterprise">Enterprise</option>
                </select>
              </div>
            </div>
            <div className="flex space-x-3 mt-6">
              <button
                onClick={() => setEditingClient(null)}
                className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
              >
                Annuler
              </button>
              <button
                onClick={handleUpdateClient}
                className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
              >
                Sauvegarder
              </button>
            </div>
          </div>
        </div>
      )}

      {/* DELETE MODAL */}
      {clientToDelete && (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[60] animate-fade-in backdrop-blur-sm">
          <div className="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 animate-scale-up border-t-4 border-red-500">
            <div className="flex flex-col items-center text-center">
              <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-4">
                <AlertTriangle className="w-6 h-6 text-red-600" />
              </div>
              <h2 className="text-xl font-bold text-gray-900 mb-2">
                Confirmer la suppression
              </h2>
              <p className="text-gray-500 mb-6">
                Êtes-vous sûr de vouloir supprimer{' '}
                <strong>{clientToDelete.name}</strong> ?
                <br />
                <br />
                <span className="text-xs bg-red-50 text-red-700 px-2 py-1 rounded">
                  Cette action est irréversible.
                </span>
              </p>
              <div className="flex space-x-3 w-full">
                <button
                  onClick={() => setClientToDelete(null)}
                  className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition font-medium"
                >
                  Annuler
                </button>
                <button
                  onClick={confirmDeleteClient}
                  className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium shadow-sm"
                >
                  Supprimer
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default AdminDashboard;
</file>

<file path="src/components/Analytics/Analytics.tsx">
import React, { useEffect, useState } from 'react';
import {
  BarChart3,
  TrendingUp,
  DollarSign,
  AlertCircle,
  Menu,
} from 'lucide-react';
import { useAppointments } from '../../hooks/useAppointments';
import { useExpenses } from '../../hooks/useExpenses';
import RevenueStats from './RevenueStats';
import ExpenseStats from './ExpenseStats';
import TaxCalculator from './TaxCalculator';
import MonthlyAnalysis from './MonthlyAnalysis';

interface AnalyticsProps {
  onMenuToggle: () => void;
}

const Analytics: React.FC<AnalyticsProps> = ({ onMenuToggle }) => {
  const { appointments, loading: appointmentsLoading } = useAppointments();
  const {
    expenses,
    loading: expensesLoading,
    getTotalExpenses,
  } = useExpenses();
  const [totalRevenue, setTotalRevenue] = useState(0);
  const [netIncome, setNetIncome] = useState(0);

  useEffect(() => {
    const completedAppointments = appointments.filter(
      (a) => a.status === 'completed' && a.price
    );
    const revenue = completedAppointments.reduce(
      (sum, a) => sum + (a.price || 0),
      0
    );
    const totalExpenses = getTotalExpenses();

    setTotalRevenue(revenue);
    setNetIncome(revenue - totalExpenses);
  }, [appointments, expenses]);

  const loading = appointmentsLoading || expensesLoading;

  if (loading) {
    return (
      <div className="flex-1 overflow-auto">
        <div className="p-6 flex items-center justify-center min-h-screen">
          <div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        </div>
      </div>
    );
  }

  return (
    <div className="flex-1 overflow-auto">
      {/* Mobile Header */}
      <div className="lg:hidden bg-white shadow-sm border-b border-gray-200 px-4 py-4 flex items-center justify-between sticky top-0 z-30">
        <button
          onClick={onMenuToggle}
          className="p-3 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 active:bg-gray-200 transition-colors"
        >
          <Menu className="h-6 w-6" />
        </button>
        <h1 className="text-xl font-semibold text-gray-900">Analytiques</h1>
        <div className="w-12"></div>
      </div>

      <div className="p-4 md:p-6 space-y-6">
        {/* Header */}
        <div className="flex items-center gap-4">
          <button
            onClick={onMenuToggle}
            className="hidden lg:flex p-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-colors"
          >
            <Menu className="h-6 w-6" />
          </button>
          <div>
            <h1 className="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center gap-3 hidden lg:flex">
              <BarChart3 className="w-8 h-8 text-blue-600" />
              Analyse financière
            </h1>
            <p className="text-gray-600 lg:hidden">
              Aperçu de vos revenus et dépenses
            </p>
            <p className="text-gray-600 mt-1 hidden lg:block">
              Aperçu complet de vos revenus, dépenses et analyses fiscales
            </p>
          </div>
        </div>

        {/* Summary Cards */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
          <div className="bg-white rounded-lg shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600 font-medium">
                  Revenus totaux
                </p>
                <p className="text-2xl sm:text-3xl font-bold text-gray-900 mt-2">
                  ${totalRevenue.toFixed(2)}
                </p>
              </div>
              <TrendingUp className="w-8 h-8 text-green-600 opacity-20" />
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600 font-medium">
                  Dépenses totales
                </p>
                <p className="text-2xl sm:text-3xl font-bold text-gray-900 mt-2">
                  ${getTotalExpenses().toFixed(2)}
                </p>
              </div>
              <DollarSign className="w-8 h-8 text-red-600 opacity-20" />
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600 font-medium">Revenu net</p>
                <p
                  className={`text-2xl sm:text-3xl font-bold mt-2 ${
                    netIncome >= 0 ? 'text-green-600' : 'text-red-600'
                  }`}
                >
                  ${netIncome.toFixed(2)}
                </p>
              </div>
              <BarChart3
                className="w-8 h-8 opacity-20"
                style={{ color: netIncome >= 0 ? '#16a34a' : '#dc2626' }}
              />
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow">
            <div>
              <p className="text-sm text-gray-600 font-medium">
                Rendez-vous complétés
              </p>
              <p className="text-2xl sm:text-3xl font-bold text-gray-900 mt-2">
                {appointments.filter((a) => a.status === 'completed').length}
              </p>
            </div>
          </div>
        </div>

        {/* Main Analytics */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
          <div className="lg:col-span-2">
            <RevenueStats appointments={appointments} />
          </div>
          <div>
            <ExpenseStats
              expenses={expenses}
              getTotalExpenses={getTotalExpenses}
            />
          </div>
        </div>

        {/* Monthly & Quarterly Analysis */}
        <MonthlyAnalysis appointments={appointments} expenses={expenses} />

        {/* Tax Calculator */}
        <TaxCalculator appointments={appointments} expenses={expenses} />

        {/* Tax Info Banner */}
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 flex gap-3">
          <AlertCircle className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
          <div className="text-sm text-blue-800">
            <p className="font-medium">Note sur les taxes du Québec</p>
            <p className="mt-1">
              Les calculs incluent la TPS (5%) et la TVQ (9.975%). Ces montants
              sont à titre informatif seulement. Consultez un comptable pour vos
              obligations fiscales réelles.
            </p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Analytics;
</file>

<file path="src/components/Analytics/ExpenseStats.tsx">
import React from 'react';
import { Expense } from '../../hooks/useExpenses';

interface ExpenseStatsProps {
  expenses: Expense[];
  getTotalExpenses: () => number;
}

const categoryLabels: Record<string, string> = {
  supplies: 'Fournitures',
  equipment: 'Équipement',
  transportation: 'Transport',
  utilities: 'Services',
  services: 'Prestataires',
  other: 'Autre',
};

const categoryColors: Record<
  string,
  { bg: string; border: string; text: string }
> = {
  supplies: {
    bg: 'bg-blue-50',
    border: 'border-blue-200',
    text: 'text-blue-600',
  },
  equipment: {
    bg: 'bg-purple-50',
    border: 'border-purple-200',
    text: 'text-purple-600',
  },
  transportation: {
    bg: 'bg-orange-50',
    border: 'border-orange-200',
    text: 'text-orange-600',
  },
  utilities: {
    bg: 'bg-green-50',
    border: 'border-green-200',
    text: 'text-green-600',
  },
  services: {
    bg: 'bg-pink-50',
    border: 'border-pink-200',
    text: 'text-pink-600',
  },
  other: { bg: 'bg-gray-50', border: 'border-gray-200', text: 'text-gray-600' },
};

const ExpenseStats: React.FC<ExpenseStatsProps> = ({
  expenses,
  getTotalExpenses,
}) => {
  const getExpensesByCategory = () => {
    const byCategory: Record<string, number> = {};
    expenses.forEach((exp) => {
      byCategory[exp.category] =
        (byCategory[exp.category] || 0) + (exp.amount || 0);
    });
    return byCategory;
  };

  const expensesByCategory = getExpensesByCategory();

  return (
    <div className="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
      <h2 className="text-xl font-bold text-gray-900 mb-6">
        Dépenses par catégorie
      </h2>

      <div className="space-y-2">
        <div className="p-4 bg-red-50 rounded-lg border border-red-200 mb-4">
          <p className="text-sm text-gray-600">Total</p>
          <p className="text-2xl font-bold text-red-600 mt-1">
            ${getTotalExpenses().toFixed(2)}
          </p>
        </div>

        {Object.entries(expensesByCategory)
          .filter(([, amount]) => amount > 0)
          .sort(([, a], [, b]) => b - a)
          .map(([category, amount]) => {
            const colors = categoryColors[category] || categoryColors.other;
            const percentage = (amount / getTotalExpenses()) * 100;

            return (
              <div
                key={category}
                className={`p-3 rounded-lg border ${colors.bg} ${colors.border}`}
              >
                <div className="flex justify-between items-center mb-2">
                  <p className={`text-sm font-medium ${colors.text}`}>
                    {categoryLabels[category] || category}
                  </p>
                  <p className={`text-sm font-bold ${colors.text}`}>
                    ${amount.toFixed(2)}
                  </p>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-1.5">
                  <div
                    className={`h-1.5 rounded-full ${colors.text.replace(
                      'text-',
                      'bg-'
                    )}`}
                    style={{ width: `${percentage}%` }}
                  ></div>
                </div>
              </div>
            );
          })}
      </div>
    </div>
  );
};

export default ExpenseStats;
</file>

<file path="src/components/Analytics/MonthlyAnalysis.tsx">
import React, { useMemo, useState } from 'react';
import { Appointment } from '../../types';
import { Expense } from '../../hooks/useExpenses';
import { ChevronDown } from 'lucide-react';

interface MonthlyAnalysisProps {
  appointments: Appointment[];
  expenses: Expense[];
}

const MonthlyAnalysis: React.FC<MonthlyAnalysisProps> = ({
  appointments,
  expenses,
}) => {
  const [expandedMonth, setExpandedMonth] = useState<string | null>(null);

  const getMonthKey = (dateString: string) => {
    const date = new Date(dateString);
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(
      2,
      '0'
    )}`;
  };

  const getMonthName = (monthKey: string) => {
    const [year, month] = monthKey.split('-');
    const date = new Date(parseInt(year), parseInt(month) - 1);
    return date.toLocaleDateString('fr-CA', { month: 'long', year: 'numeric' });
  };

  const monthlyStats = useMemo(() => {
    const stats: Record<
      string,
      {
        revenue: number;
        expenses: number;
        appointmentCount: number;
        expenseCount: number;
        netIncome: number;
      }
    > = {};

    // Group appointments by month
    const completedAppointments = appointments.filter(
      (a) => a.status === 'completed' && a.price
    );
    completedAppointments.forEach((appt) => {
      const monthKey = getMonthKey(appt.date);
      if (!stats[monthKey]) {
        stats[monthKey] = {
          revenue: 0,
          expenses: 0,
          appointmentCount: 0,
          expenseCount: 0,
          netIncome: 0,
        };
      }
      stats[monthKey].revenue += appt.price || 0;
      stats[monthKey].appointmentCount += 1;
    });

    // Group expenses by month
    expenses.forEach((expense) => {
      const monthKey = getMonthKey(expense.date);
      if (!stats[monthKey]) {
        stats[monthKey] = {
          revenue: 0,
          expenses: 0,
          appointmentCount: 0,
          expenseCount: 0,
          netIncome: 0,
        };
      }
      stats[monthKey].expenses += expense.amount || 0;
      stats[monthKey].expenseCount += 1;
    });

    // Calculate net income
    Object.keys(stats).forEach((monthKey) => {
      stats[monthKey].netIncome =
        stats[monthKey].revenue - stats[monthKey].expenses;
    });

    return stats;
  }, [appointments, expenses]);

  const quarterlyStats = useMemo(() => {
    const stats: Record<
      string,
      {
        revenue: number;
        expenses: number;
        appointmentCount: number;
        expenseCount: number;
        netIncome: number;
      }
    > = {};

    Object.entries(monthlyStats).forEach(([monthKey, data]) => {
      const [year, month] = monthKey.split('-');
      const quarter = Math.ceil(parseInt(month) / 3);
      const quarterKey = `${year}-Q${quarter}`;

      if (!stats[quarterKey]) {
        stats[quarterKey] = {
          revenue: 0,
          expenses: 0,
          appointmentCount: 0,
          expenseCount: 0,
          netIncome: 0,
        };
      }

      stats[quarterKey].revenue += data.revenue;
      stats[quarterKey].expenses += data.expenses;
      stats[quarterKey].appointmentCount += data.appointmentCount;
      stats[quarterKey].expenseCount += data.expenseCount;
      stats[quarterKey].netIncome += data.netIncome;
    });

    return stats;
  }, [monthlyStats]);

  const sortedMonths = Object.keys(monthlyStats).sort().reverse();
  const sortedQuarters = Object.keys(quarterlyStats).sort().reverse();

  return (
    <div className="space-y-6">
      {/* Quarterly Summary */}
      <div className="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
        <h2 className="text-xl font-bold text-gray-900 mb-6">
          Analyse trimestrielle
        </h2>
        <div className="space-y-2">
          {sortedQuarters.map((quarterKey) => {
            const data = quarterlyStats[quarterKey];
            const isPositive = data.netIncome >= 0;

            return (
              <div
                key={quarterKey}
                className="p-4 bg-gray-50 rounded-lg border border-gray-200 hover:border-gray-300 transition-colors"
              >
                <div className="grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
                  <div>
                    <p className="font-semibold text-gray-900">{quarterKey}</p>
                  </div>
                  <div>
                    <p className="text-xs text-gray-600">Revenus</p>
                    <p className="text-lg font-bold text-green-600">
                      ${data.revenue.toFixed(2)}
                    </p>
                  </div>
                  <div>
                    <p className="text-xs text-gray-600">Dépenses</p>
                    <p className="text-lg font-bold text-red-600">
                      ${data.expenses.toFixed(2)}
                    </p>
                  </div>
                  <div>
                    <p className="text-xs text-gray-600">Rendez-vous</p>
                    <p className="text-lg font-bold text-blue-600">
                      {data.appointmentCount}
                    </p>
                  </div>
                  <div className="text-right">
                    <p className="text-xs text-gray-600">Revenu net</p>
                    <p
                      className={`text-lg font-bold ${
                        isPositive ? 'text-green-600' : 'text-red-600'
                      }`}
                    >
                      ${data.netIncome.toFixed(2)}
                    </p>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {/* Monthly Detailed View */}
      <div className="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
        <h2 className="text-xl font-bold text-gray-900 mb-6">
          Analyse mensuelle détaillée
        </h2>
        <div className="space-y-2">
          {sortedMonths.map((monthKey) => {
            const data = monthlyStats[monthKey];
            const isPositive = data.netIncome >= 0;
            const isExpanded = expandedMonth === monthKey;

            return (
              <div
                key={monthKey}
                className="border border-gray-200 rounded-lg overflow-hidden"
              >
                <button
                  onClick={() => setExpandedMonth(isExpanded ? null : monthKey)}
                  className="w-full p-4 bg-white hover:bg-gray-50 transition-colors flex items-center justify-between"
                >
                  <div className="flex-1 text-left">
                    <p className="font-semibold text-gray-900">
                      {getMonthName(monthKey)}
                    </p>
                  </div>

                  <div className="grid grid-cols-4 gap-8 flex-1 mr-4">
                    <div className="text-right">
                      <p className="text-xs text-gray-600">Revenus</p>
                      <p className="text-sm font-bold text-green-600">
                        ${data.revenue.toFixed(2)}
                      </p>
                    </div>
                    <div className="text-right">
                      <p className="text-xs text-gray-600">Dépenses</p>
                      <p className="text-sm font-bold text-red-600">
                        ${data.expenses.toFixed(2)}
                      </p>
                    </div>
                    <div className="text-right">
                      <p className="text-xs text-gray-600">Rendez-vous</p>
                      <p className="text-sm font-bold text-blue-600">
                        {data.appointmentCount}
                      </p>
                    </div>
                    <div className="text-right">
                      <p className="text-xs text-gray-600">Net</p>
                      <p
                        className={`text-sm font-bold ${
                          isPositive ? 'text-green-600' : 'text-red-600'
                        }`}
                      >
                        ${data.netIncome.toFixed(2)}
                      </p>
                    </div>
                  </div>

                  <ChevronDown
                    className={`w-5 h-5 text-gray-400 transition-transform ${
                      isExpanded ? 'rotate-180' : ''
                    }`}
                  />
                </button>

                {isExpanded && (
                  <div className="bg-gray-50 p-4 border-t border-gray-200 space-y-3">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div>
                        <p className="text-xs text-gray-600 font-medium">
                          Revenus bruts
                        </p>
                        <p className="text-lg font-bold text-green-600 mt-1">
                          ${data.revenue.toFixed(2)}
                        </p>
                      </div>
                      <div>
                        <p className="text-xs text-gray-600 font-medium">
                          Total dépenses
                        </p>
                        <p className="text-lg font-bold text-red-600 mt-1">
                          ${data.expenses.toFixed(2)}
                        </p>
                      </div>
                      <div>
                        <p className="text-xs text-gray-600 font-medium">
                          Revenu net
                        </p>
                        <p
                          className={`text-lg font-bold mt-1 ${
                            isPositive ? 'text-green-600' : 'text-red-600'
                          }`}
                        >
                          ${data.netIncome.toFixed(2)}
                        </p>
                      </div>
                      <div>
                        <p className="text-xs text-gray-600 font-medium">
                          Transactions
                        </p>
                        <p className="text-lg font-bold text-blue-600 mt-1">
                          {data.appointmentCount + data.expenseCount}
                        </p>
                      </div>
                    </div>

                    <div className="pt-3 border-t border-gray-300 text-sm">
                      <div className="flex justify-between mb-1">
                        <span className="text-gray-600">Marge nette:</span>
                        <span className="font-semibold">
                          {data.revenue > 0
                            ? ((data.netIncome / data.revenue) * 100).toFixed(1)
                            : '0'}
                          %
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Ratio dépenses:</span>
                        <span className="font-semibold">
                          {data.revenue > 0
                            ? ((data.expenses / data.revenue) * 100).toFixed(1)
                            : '0'}
                          %
                        </span>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            );
          })}

          {sortedMonths.length === 0 && (
            <p className="text-center text-gray-500 py-8">
              Aucune donnée disponible
            </p>
          )}
        </div>
      </div>
    </div>
  );
};

export default MonthlyAnalysis;
</file>

<file path="src/components/Analytics/RevenueStats.tsx">
import React, { useMemo } from 'react';
import { Appointment } from '../../types';

interface RevenueStatsProps {
  appointments: Appointment[];
}

const RevenueStats: React.FC<RevenueStatsProps> = ({ appointments }) => {
  const stats = useMemo(() => {
    const completed = appointments.filter(
      (a) => a.status === 'completed' && a.price
    );
    const total = completed.reduce((sum, a) => sum + (a.price || 0), 0);
    const average = completed.length > 0 ? total / completed.length : 0;

    return {
      totalCompleted: total,
      averagePrice: average,
      completedCount: completed.length,
    };
  }, [appointments]);

  return (
    <div className="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
      <h2 className="text-xl font-bold text-gray-900 mb-6">Revenus</h2>

      <div className="space-y-4">
        <div className="flex justify-between items-center p-4 bg-green-50 rounded-lg border border-green-200">
          <div>
            <p className="text-sm text-gray-600">Revenus complétés</p>
            <p className="text-2xl font-bold text-green-600 mt-1">
              ${stats.totalCompleted.toFixed(2)}
            </p>
            <p className="text-xs text-gray-500 mt-1">
              {stats.completedCount} rendez-vous
            </p>
          </div>
        </div>

        <div className="flex justify-between items-center p-4 bg-blue-50 rounded-lg border border-blue-200">
          <div>
            <p className="text-sm text-gray-600">Prix moyen par rendez-vous</p>
            <p className="text-2xl font-bold text-blue-600 mt-1">
              ${stats.averagePrice.toFixed(2)}
            </p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default RevenueStats;
</file>

<file path="src/components/Analytics/TaxCalculator.tsx">
import React, { useMemo, useState } from 'react';
import { Appointment } from '../../types';
import { Expense } from '../../hooks/useExpenses';
import { Calendar, TrendingDown, TrendingUp } from 'lucide-react';

interface TaxCalculatorProps {
  appointments: Appointment[];
  expenses: Expense[];
}

type ViewMode = 'combined' | 'revenues' | 'expenses';
type PeriodMode = 'monthly' | 'quarterly';

const TaxCalculator: React.FC<TaxCalculatorProps> = ({
  appointments,
  expenses,
}) => {
  const TAX_TPS = 0.05; // 5%
  const TAX_TVQ = 0.09975; // 9.975%

  const [viewMode, setViewMode] = useState<ViewMode>('combined');
  const [periodMode, setPeriodMode] = useState<PeriodMode>('monthly');

  const getCurrentPeriod = () => {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const quarter = Math.ceil(month / 3);

    return { year, month, quarter };
  };

  const filterByPeriod = (dateStr: string) => {
    const date = new Date(dateStr);
    const { year, month, quarter } = getCurrentPeriod();

    if (periodMode === 'monthly') {
      return date.getFullYear() === year && date.getMonth() + 1 === month;
    } else {
      const itemQuarter = Math.ceil((date.getMonth() + 1) / 3);
      return date.getFullYear() === year && itemQuarter === quarter;
    }
  };

  const calculations = useMemo(() => {
    // Vérification de sécurité
    if (!appointments || !expenses) {
      return {
        revenue: { beforeTax: 0, tps: 0, tvq: 0, total: 0 },
        expenses: { beforeTax: 0, tps: 0, tvq: 0, total: 0 },
        net: { tps: 0, tvq: 0, total: 0 },
      };
    }

    // Filtrer les rendez-vous complétés pour la période
    const periodAppointments = appointments.filter(
      (apt) =>
        apt.status === 'completed' && apt.price && filterByPeriod(apt.date)
    );

    // Filtrer les dépenses pour la période
    const periodExpenses = expenses.filter((exp) => filterByPeriod(exp.date));

    // Revenus (taxes collectées - à remettre au gouvernement)
    const revenueBeforeTax = periodAppointments.reduce(
      (sum, apt) => sum + (apt.price || 0),
      0
    );
    const revenueTPS = revenueBeforeTax * TAX_TPS;
    const revenueTVQ = revenueBeforeTax * TAX_TVQ;
    const revenueTaxesTotal = revenueTPS + revenueTVQ;

    // Dépenses (taxes payées - crédit à récupérer)
    const expensesBeforeTax = periodExpenses.reduce(
      (sum, exp) => sum + exp.amount,
      0
    );
    const expensesTPS = expensesBeforeTax * TAX_TPS;
    const expensesTVQ = expensesBeforeTax * TAX_TVQ;
    const expensesTaxesTotal = expensesTPS + expensesTVQ;

    // Calcul net (ce qu'on doit/reçoit du gouvernement)
    const netTPS = revenueTPS - expensesTPS;
    const netTVQ = revenueTVQ - expensesTVQ;
    const netTotal = netTPS + netTVQ;

    return {
      revenue: {
        beforeTax: revenueBeforeTax,
        tps: revenueTPS,
        tvq: revenueTVQ,
        total: revenueTaxesTotal,
      },
      expenses: {
        beforeTax: expensesBeforeTax,
        tps: expensesTPS,
        tvq: expensesTVQ,
        total: expensesTaxesTotal,
      },
      net: {
        tps: netTPS,
        tvq: netTVQ,
        total: netTotal,
      },
    };
  }, [appointments, expenses, periodMode]);

  const { year, month, quarter } = getCurrentPeriod();
  const periodLabel =
    periodMode === 'monthly'
      ? `${new Date(year, month - 1).toLocaleDateString('fr-FR', {
          month: 'long',
          year: 'numeric',
        })}`
      : `T${quarter} ${year}`;

  const isOwing = calculations.net.total > 0;

  return (
    <div className="bg-white p-6 rounded-lg border border-gray-200 shadow-sm space-y-6">
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <h2 className="text-xl font-bold text-gray-900">
          Calcul des taxes (Québec)
        </h2>

        <div className="flex gap-2">
          {/* Period Toggle */}
          <div className="flex bg-gray-100 rounded-lg p-1">
            <button
              onClick={() => setPeriodMode('monthly')}
              className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${
                periodMode === 'monthly'
                  ? 'bg-white text-blue-600 shadow-sm'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              Mois
            </button>
            <button
              onClick={() => setPeriodMode('quarterly')}
              className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${
                periodMode === 'quarterly'
                  ? 'bg-white text-blue-600 shadow-sm'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              Trimestre
            </button>
          </div>

          {/* View Toggle */}
          <div className="flex bg-gray-100 rounded-lg p-1">
            <button
              onClick={() => setViewMode('combined')}
              className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${
                viewMode === 'combined'
                  ? 'bg-white text-blue-600 shadow-sm'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              Net
            </button>
            <button
              onClick={() => setViewMode('revenues')}
              className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${
                viewMode === 'revenues'
                  ? 'bg-white text-blue-600 shadow-sm'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              Revenus
            </button>
            <button
              onClick={() => setViewMode('expenses')}
              className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${
                viewMode === 'expenses'
                  ? 'bg-white text-blue-600 shadow-sm'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              Dépenses
            </button>
          </div>
        </div>
      </div>

      {/* Period Label */}
      <div className="flex items-center gap-2 text-sm text-gray-600">
        <Calendar className="w-4 h-4" />
        <span>Période: {periodLabel}</span>
      </div>

      {/* Combined View - Net Amount */}
      {viewMode === 'combined' && (
        <div className="space-y-4">
          <div
            className={`p-6 rounded-lg border-2 ${
              isOwing
                ? 'bg-red-50 border-red-200'
                : 'bg-green-50 border-green-200'
            }`}
          >
            <div className="flex items-center justify-between mb-4">
              <div>
                <p className="text-sm text-gray-600 font-medium">
                  {isOwing
                    ? 'À remettre au gouvernement'
                    : 'Crédit à récupérer'}
                </p>
                <p
                  className={`text-4xl font-bold mt-2 ${
                    isOwing ? 'text-red-600' : 'text-green-600'
                  }`}
                >
                  ${Math.abs(calculations.net.total).toFixed(2)}
                </p>
              </div>
              {isOwing ? (
                <TrendingUp className="w-12 h-12 text-red-600 opacity-20" />
              ) : (
                <TrendingDown className="w-12 h-12 text-green-600 opacity-20" />
              )}
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
              <p className="text-sm text-gray-600 font-medium">TPS nette</p>
              <p
                className={`text-2xl font-bold mt-2 ${
                  calculations.net.tps > 0 ? 'text-red-600' : 'text-green-600'
                }`}
              >
                {calculations.net.tps > 0 ? '-' : '+'}$
                {Math.abs(calculations.net.tps).toFixed(2)}
              </p>
              <p className="text-xs text-gray-500 mt-1">
                Collecté: ${calculations.revenue.tps.toFixed(2)} | Payé: $
                {calculations.expenses.tps.toFixed(2)}
              </p>
            </div>

            <div className="p-4 bg-purple-50 rounded-lg border border-purple-200">
              <p className="text-sm text-gray-600 font-medium">TVQ nette</p>
              <p
                className={`text-2xl font-bold mt-2 ${
                  calculations.net.tvq > 0 ? 'text-red-600' : 'text-green-600'
                }`}
              >
                {calculations.net.tvq > 0 ? '-' : '+'}$
                {Math.abs(calculations.net.tvq).toFixed(2)}
              </p>
              <p className="text-xs text-gray-500 mt-1">
                Collecté: ${calculations.revenue.tvq.toFixed(2)} | Payé: $
                {calculations.expenses.tvq.toFixed(2)}
              </p>
            </div>
          </div>

          <div className="p-4 bg-gray-50 rounded-lg">
            <h3 className="font-semibold text-gray-900 mb-3">Résumé</h3>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between text-gray-600">
                <span>Taxes collectées (revenus):</span>
                <span className="font-medium text-red-600">
                  +${calculations.revenue.total.toFixed(2)}
                </span>
              </div>
              <div className="flex justify-between text-gray-600">
                <span>Taxes payées (dépenses):</span>
                <span className="font-medium text-green-600">
                  -${calculations.expenses.total.toFixed(2)}
                </span>
              </div>
              <div className="border-t border-gray-300 pt-2 flex justify-between font-bold">
                <span>{isOwing ? 'À remettre:' : 'À récupérer:'}</span>
                <span className={isOwing ? 'text-red-600' : 'text-green-600'}>
                  ${Math.abs(calculations.net.total).toFixed(2)}
                </span>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Revenue View */}
      {viewMode === 'revenues' && (
        <div className="space-y-4">
          <div className="bg-gradient-to-r from-red-50 to-orange-50 p-6 rounded-lg border border-red-200">
            <p className="text-sm text-gray-600 mb-2">Revenus (avant taxes)</p>
            <p className="text-3xl font-bold text-gray-900">
              ${calculations.revenue.beforeTax.toFixed(2)}
            </p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
              <p className="text-sm text-gray-600 font-medium">
                TPS collectée (5%)
              </p>
              <p className="text-xl font-bold text-blue-600 mt-2">
                ${calculations.revenue.tps.toFixed(2)}
              </p>
            </div>

            <div className="p-4 bg-purple-50 rounded-lg border border-purple-200">
              <p className="text-sm text-gray-600 font-medium">
                TVQ collectée (9.975%)
              </p>
              <p className="text-xl font-bold text-purple-600 mt-2">
                ${calculations.revenue.tvq.toFixed(2)}
              </p>
            </div>

            <div className="p-4 bg-red-50 rounded-lg border border-red-200">
              <p className="text-sm text-gray-600 font-medium">
                Total à remettre
              </p>
              <p className="text-xl font-bold text-red-600 mt-2">
                ${calculations.revenue.total.toFixed(2)}
              </p>
            </div>
          </div>

          <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p className="text-sm text-yellow-800">
              <strong>Note:</strong> Ces taxes ont été collectées sur vos
              rendez-vous et doivent être remises au gouvernement.
            </p>
          </div>
        </div>
      )}

      {/* Expenses View */}
      {viewMode === 'expenses' && (
        <div className="space-y-4">
          <div className="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-lg border border-green-200">
            <p className="text-sm text-gray-600 mb-2">Dépenses (avant taxes)</p>
            <p className="text-3xl font-bold text-gray-900">
              ${calculations.expenses.beforeTax.toFixed(2)}
            </p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
              <p className="text-sm text-gray-600 font-medium">
                TPS payée (5%)
              </p>
              <p className="text-xl font-bold text-blue-600 mt-2">
                ${calculations.expenses.tps.toFixed(2)}
              </p>
            </div>

            <div className="p-4 bg-purple-50 rounded-lg border border-purple-200">
              <p className="text-sm text-gray-600 font-medium">
                TVQ payée (9.975%)
              </p>
              <p className="text-xl font-bold text-purple-600 mt-2">
                ${calculations.expenses.tvq.toFixed(2)}
              </p>
            </div>

            <div className="p-4 bg-green-50 rounded-lg border border-green-200">
              <p className="text-sm text-gray-600 font-medium">
                Total récupérable
              </p>
              <p className="text-xl font-bold text-green-600 mt-2">
                ${calculations.expenses.total.toFixed(2)}
              </p>
            </div>
          </div>

          <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p className="text-sm text-blue-800">
              <strong>Note:</strong> Ces taxes ont été payées sur vos dépenses
              professionnelles et peuvent être récupérées comme crédits.
            </p>
          </div>
        </div>
      )}
    </div>
  );
};

export default TaxCalculator;
</file>

<file path="src/components/Calendar/AppointmentCard.tsx">
import React from 'react';
import { Clock, User, MapPin, Navigation, Trash2 } from 'lucide-react';
import { Appointment, Client } from '../../types';

interface AppointmentCardProps {
  appointment: Appointment;
  client?: Client;
  onClick?: (e: React.MouseEvent) => void;
  onDelete?: (e: React.MouseEvent) => void;
  showNavigation?: boolean;
}

const AppointmentCard: React.FC<AppointmentCardProps> = ({
  appointment,
  client,
  onClick,
  onDelete,
  showNavigation = false,
}) => {
  const handleNavigate = (e: React.MouseEvent) => {
    e.stopPropagation();

    if (!client?.address) {
      alert('Adresse du client non disponible');
      return;
    }

    // Encode the address for URL
    const encodedAddress = encodeURIComponent(client.address);

    // Try to open in Apple Maps first (iOS/macOS)
    const appleMapsUrl = `maps://maps.apple.com/?daddr=${encodedAddress}`;

    // Fallback to Google Maps (universal)
    const googleMapsUrl = `https://maps.google.com/maps?daddr=${encodedAddress}`;

    // Detect if we're on iOS/macOS
    const isAppleDevice = /iPad|iPhone|iPod|Macintosh/.test(
      navigator.userAgent
    );

    if (isAppleDevice) {
      // Try Apple Maps first
      const link = document.createElement('a');
      link.href = appleMapsUrl;
      link.click();

      // Fallback to Google Maps after a short delay if Apple Maps doesn't open
      setTimeout(() => {
        window.open(googleMapsUrl, '_blank');
      }, 1000);
    } else {
      // Open Google Maps directly on non-Apple devices
      window.open(googleMapsUrl, '_blank');
    }
  };

  const handleDelete = (e: React.MouseEvent) => {
    e.stopPropagation();
    if (onDelete) {
      onDelete(e);
    }
  };

  return (
    <div
      onClick={onClick}
      className={`p-4 rounded-lg cursor-pointer touch-manipulation transition-all border relative ${
        appointment.status === 'scheduled'
          ? 'bg-blue-100 text-blue-800 hover:bg-blue-200'
          : appointment.status === 'completed'
          ? 'bg-green-100 text-green-800 hover:bg-green-200'
          : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
      }`}
    >
      {/* Header avec heure et boutons d'action */}
      <div className="flex items-start justify-between mb-3">
        <div className="flex items-center gap-2 flex-1">
          <Clock className="w-4 h-4" />
          <div>
            <span className="font-bold text-lg">
              {appointment.time.slice(0, 5)}
            </span>
            <span className="text-sm opacity-75 ml-2">
              ({appointment.duration} min)
            </span>
          </div>
        </div>

        {/* Boutons d'action */}
        <div className="flex items-center gap-1 flex-shrink-0">
          {showNavigation && client?.address && (
            <button
              onClick={handleNavigate}
              className="p-2 rounded-lg bg-white/50 hover:bg-white/80 active:bg-white transition-colors"
              title="Ouvrir l'itinéraire"
            >
              <Navigation className="w-4 h-4" />
            </button>
          )}

          {onDelete && (
            <button
              onClick={handleDelete}
              className="p-2 rounded-lg bg-red-500/20 hover:bg-red-500/40 active:bg-red-500/60 transition-colors group"
              title="Supprimer le rendez-vous"
            >
              <Trash2 className="w-4 h-4 text-red-700 group-hover:text-red-800" />
            </button>
          )}
        </div>
      </div>

      {/* Service */}
      <div className="font-bold text-base mb-2 text-gray-900">
        {appointment.service}
      </div>

      {/* Client */}
      <div className="flex items-center gap-2 text-sm opacity-90 mb-2">
        <User className="w-3 h-3" />
        <span className="font-medium">{appointment.clientName}</span>
      </div>

      {/* Adresse */}
      {client?.address && (
        <div className="flex items-start gap-2 text-sm opacity-90 mb-2">
          <MapPin className="w-3 h-3 mt-0.5" />
          <span className="line-clamp-2">{client.address}</span>
        </div>
      )}

      {/* Notes */}
      {appointment.notes && (
        <div className="text-sm opacity-90 mt-2 p-2 bg-white/30 rounded italic">
          {appointment.notes}
        </div>
      )}

      {/* Prix */}
      {appointment.price && appointment.price > 0 && (
        <div className="flex items-center justify-end mt-3 pt-2 border-t border-white/30">
          <span className="text-lg font-bold">
            ${appointment.price.toFixed(2)}
          </span>
        </div>
      )}
    </div>
  );
};

export default AppointmentCard;
</file>

<file path="src/components/Calendar/AppointmentModal.tsx">
import React, { useState, useEffect } from 'react';
import {
  X,
  Calendar,
  Clock,
  User,
  Search,
  Plus,
  Wrench,
  AlertTriangle,
  Loader2,
} from 'lucide-react';
import { Appointment, Client, Service } from '../../types';
import { supabase } from '../../lib/supabase';
import { usePreferences } from '../../hooks/usePreferences';

interface TimeSlot {
  time: string;
  available: boolean;
  warning?: string;
}

interface AppointmentModalProps {
  appointment?: Appointment | null;
  clients: Client[];
  services: Service[];
  selectedDate: string;
  preSelectedClient?: Client;
  existingAppointments: Appointment[];
  onSave: (appointment: Omit<Appointment, 'id'>) => void;
  onAddService: (serviceName: string) => Promise<boolean>;
  onDeleteService: (serviceId: string) => Promise<boolean>;
  onClose: () => void;
}

const AppointmentModal: React.FC<AppointmentModalProps> = ({
  appointment,
  clients,
  services,
  selectedDate,
  preSelectedClient,
  onSave,
  onAddService,
  onDeleteService,
  onClose,
}) => {
  // Charger les préférences
  const { preferences } = usePreferences();

  const [formData, setFormData] = useState({
    clientId: '',
    clientName: '',
    service: '',
    notes: '',
    date: selectedDate,
    time: '',
    duration: 60,
    status: 'scheduled' as const,
    price: '',
  });

  // États UI
  const [clientSearch, setClientSearch] = useState('');
  const [showClientDropdown, setShowClientDropdown] = useState(false);
  const [newService, setNewService] = useState('');
  const [showAddService, setShowAddService] = useState(false);
  const [customDuration, setCustomDuration] = useState('');
  const [showCustomDuration, setShowCustomDuration] = useState(false);
  const [customDurations, setCustomDurations] = useState<number[]>([]);
  const [showWarningModal, setShowWarningModal] = useState(false);

  // États pour la gestion des conflits DB
  const [dbAppointments, setDbAppointments] = useState<Appointment[]>([]);
  const [isLoadingSlots, setIsLoadingSlots] = useState(false);
  const [availableSlots, setAvailableSlots] = useState<TimeSlot[]>([]);
  const [showTimeGrid, setShowTimeGrid] = useState(false);
  const [pendingTime, setPendingTime] = useState<string | null>(null);
  const [warningMessage, setWarningMessage] = useState('');

  // Paramètres par défaut ou depuis les préférences
  const minTimeBetween = preferences?.min_time_between_appointments || 90;
  const businessStart =
    preferences?.business_hours_start?.slice(0, 5) || '08:00';
  const businessEnd = preferences?.business_hours_end?.slice(0, 5) || '18:00';

  // Initialisation du formulaire
  useEffect(() => {
    if (appointment) {
      setFormData({
        clientId: appointment.clientId,
        clientName: appointment.clientName,
        service: appointment.service,
        notes: appointment.notes || '',
        date: appointment.date,
        time: appointment.time,
        duration: appointment.duration,
        status: appointment.status,
        price: appointment.price || '',
      });
      setClientSearch(appointment.clientName);
    } else if (preSelectedClient) {
      setFormData((prev) => ({
        ...prev,
        clientId: preSelectedClient.id,
        clientName: preSelectedClient.name,
      }));
      setClientSearch(preSelectedClient.name);
    }
  }, [appointment, preSelectedClient]);

  // Récupération des rendez-vous du jour depuis la DB
  useEffect(() => {
    const fetchDayAppointments = async () => {
      setIsLoadingSlots(true);
      try {
        const { data, error } = await supabase
          .from('appointments')
          .select('*')
          .eq('date', formData.date);

        if (error) throw error;
        if (data) {
          setDbAppointments(data as Appointment[]);
        }
      } catch (err) {
        console.error(
          'Erreur lors de la vérification des disponibilités:',
          err
        );
      } finally {
        setIsLoadingSlots(false);
      }
    };

    if (formData.date) {
      fetchDayAppointments();
    }
  }, [formData.date]);

  // Recalculer les créneaux quand les données changent
  useEffect(() => {
    if (formData.date && !isLoadingSlots && preferences) {
      generateTimeSlots(formData.date);
    }
  }, [
    formData.date,
    formData.duration,
    dbAppointments,
    isLoadingSlots,
    preferences,
  ]);

  const checkTimeSlotAvailability = (
    date: string,
    time: string,
    duration: number
  ): TimeSlot => {
    const now = new Date();
    const slotStart = new Date(`${date}T${time}:00`);
    const slotEnd = new Date(slotStart.getTime() + duration * 60000);

    // Vérifier si c'est dans le passé
    const isPast = slotStart < now;

    const otherApts = dbAppointments.filter(
      (a) => a.id !== appointment?.id && a.status !== 'cancelled'
    );

    let hasConflict = false;
    let minGap = Infinity;

    for (const apt of otherApts) {
      const aptTimeClean = apt.time.slice(0, 5);
      const aptStart = new Date(`${date}T${aptTimeClean}:00`);
      const aptEnd = new Date(aptStart.getTime() + apt.duration * 60000);

      // Vérifier le chevauchement
      if (slotStart < aptEnd && slotEnd > aptStart) {
        hasConflict = true;
        break;
      }

      // Calculer l'écart minimum
      const gapBefore = (slotStart.getTime() - aptEnd.getTime()) / 60000;
      const gapAfter = (aptStart.getTime() - slotEnd.getTime()) / 60000;
      if (gapBefore >= 0) minGap = Math.min(minGap, gapBefore);
      if (gapAfter >= 0) minGap = Math.min(minGap, gapAfter);
    }

    if (hasConflict) return { time, available: false };

    // Messages d'avertissement selon les préférences
    let warningMsg = '';
    if (isPast) {
      warningMsg = 'Ce créneau horaire est déjà passé.';
    } else if (minGap < minTimeBetween && minGap !== Infinity) {
      warningMsg = `Attention : seulement ${Math.round(
        minGap
      )} min d'écart (${minTimeBetween} min recommandés).`;
    }

    return {
      time,
      available: true,
      warning: warningMsg || undefined,
    };
  };

  const generateTimeSlots = (date: string) => {
    const slots: TimeSlot[] = [];

    // Utiliser les heures d'ouverture des préférences
    const [startHour, startMinute] = businessStart.split(':').map(Number);
    const [endHour, endMinute] = businessEnd.split(':').map(Number);

    let hour = startHour;
    let minute = startMinute;

    while (hour < endHour || (hour === endHour && minute < endMinute)) {
      const timeString = `${hour.toString().padStart(2, '0')}:${minute
        .toString()
        .padStart(2, '0')}`;
      const slot = checkTimeSlotAvailability(
        date,
        timeString,
        formData.duration
      );
      slots.push(slot);

      // Incrémenter par 30 minutes
      minute += 30;
      if (minute >= 60) {
        minute = 0;
        hour++;
      }
    }

    setAvailableSlots(slots);
  };

  const filteredClients = clients.filter(
    (client) =>
      client.name.toLowerCase().includes(clientSearch.toLowerCase()) ||
      client.contactPersonName
        .toLowerCase()
        .includes(clientSearch.toLowerCase())
  );

  const handleClientSelect = (client: Client) => {
    setFormData((prev) => ({
      ...prev,
      clientId: client.id,
      clientName: client.name,
    }));
    setClientSearch(client.name);
    setShowClientDropdown(false);
  };

  const handleAddService = () => {
    if (
      newService.trim() &&
      !services.some((s) => s.name === newService.trim())
    ) {
      onAddService(newService.trim()).then((success) => {
        if (success) {
          setFormData((prev) => ({ ...prev, service: newService.trim() }));
          setNewService('');
          setShowAddService(false);
        }
      });
    }
  };

  const handleDeleteServiceLocal = (serviceToDelete: Service) => {
    if (services.length > 1) {
      onDeleteService(serviceToDelete.id).then((success) => {
        if (success) {
          if (formData.service === serviceToDelete.name) {
            setFormData((prev) => ({ ...prev, service: '' }));
          }
        }
      });
    }
  };

  const handleDurationChange = (value: string) => {
    if (value === 'custom') {
      setShowCustomDuration(true);
    } else {
      setFormData((prev) => ({ ...prev, duration: parseInt(value) }));
      setShowCustomDuration(false);
    }
  };

  const handleCustomDurationSubmit = () => {
    const duration = parseInt(customDuration);
    if (duration > 0) {
      setCustomDurations((prev) => [...prev, duration]);
      setFormData((prev) => ({ ...prev, duration }));
      setShowCustomDuration(false);
      setCustomDuration('');
    }
  };

  const handleDeleteDuration = (durationToDelete: number) => {
    setCustomDurations((prev) => prev.filter((d) => d !== durationToDelete));
    if (formData.duration === durationToDelete) {
      setFormData((prev) => ({ ...prev, duration: 60 }));
    }
  };

  const handleTimeSelect = (slot: TimeSlot) => {
    if (!slot.available) return;
    if (slot.warning) {
      setWarningMessage(slot.warning);
      setPendingTime(slot.time);
      setShowWarningModal(true);
    } else {
      setFormData((prev) => ({ ...prev, time: slot.time }));
      setShowTimeGrid(false);
    }
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();

    if (!formData.clientId) {
      alert('Veuillez sélectionner un client');
      return;
    }

    onSave(formData);
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50 p-0 sm:p-4">
      <div className="bg-white rounded-t-2xl sm:rounded-2xl shadow-xl w-full sm:max-w-md max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="flex items-center justify-between p-4 sm:p-6 border-b border-gray-200 sticky top-0 bg-white z-10">
          <h2 className="text-lg sm:text-xl font-semibold text-gray-900">
            {appointment ? 'Modifier le rendez-vous' : 'Nouveau rendez-vous'}
          </h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition-colors touch-manipulation"
          >
            <X className="h-6 w-6" />
          </button>
        </div>

        <form onSubmit={handleSubmit} className="p-4 sm:p-6 space-y-4">
          {/* Client Search */}
          <div className="relative">
            <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
              <User className="h-4 w-4 mr-2" />
              Client
            </label>
            <div className="relative">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4 pointer-events-none" />
              <input
                type="text"
                value={clientSearch}
                onChange={(e) => {
                  setClientSearch(e.target.value);
                  setShowClientDropdown(true);
                }}
                onFocus={() => setShowClientDropdown(true)}
                className="w-full pl-10 pr-4 py-4 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-manipulation"
                placeholder="Rechercher un client..."
                required
              />
            </div>

            {showClientDropdown && clientSearch && (
              <div className="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                {filteredClients.length > 0 ? (
                  filteredClients.map((client) => (
                    <button
                      key={client.id}
                      type="button"
                      onClick={() => handleClientSelect(client)}
                      className="w-full text-left px-4 py-3 hover:bg-gray-100 active:bg-gray-200 border-b border-gray-100 last:border-b-0 touch-manipulation"
                    >
                      <div className="font-medium text-gray-900">
                        {client.name}
                      </div>
                      <div className="text-sm text-gray-600">
                        Contact : {client.contactPersonName}
                      </div>
                    </button>
                  ))
                ) : (
                  <div className="px-4 py-3 text-gray-500 text-center text-sm">
                    Aucun client trouvé
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Service Selection */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
              <Wrench className="h-4 w-4 mr-2" />
              Service
            </label>
            <div className="space-y-2">
              <select
                value={formData.service}
                onChange={(e) => {
                  if (e.target.value === 'add-new') setShowAddService(true);
                  else
                    setFormData((prev) => ({
                      ...prev,
                      service: e.target.value,
                    }));
                }}
                className="w-full py-4 px-4 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-manipulation"
                required
              >
                <option value="">Sélectionnez un service</option>
                {services.map((service) => (
                  <option key={service.id} value={service.name}>
                    {service.name}
                  </option>
                ))}
                <option value="add-new">+ Ajouter un nouveau service</option>
              </select>

              {services.length > 1 && (
                <div className="flex flex-wrap gap-2 mt-2">
                  {services.map((service) => (
                    <div
                      key={service.id}
                      className="flex items-center bg-gray-50 rounded-lg px-3 py-2 text-sm border border-gray-200"
                    >
                      <span className="mr-2 text-gray-700">{service.name}</span>
                      <button
                        type="button"
                        onClick={() => handleDeleteServiceLocal(service)}
                        className="text-gray-400 hover:text-red-500 transition-colors touch-manipulation p-1"
                      >
                        <X className="w-4 h-4" />
                      </button>
                    </div>
                  ))}
                </div>
              )}

              {showAddService && (
                <div className="flex gap-2 mt-2">
                  <input
                    type="text"
                    value={newService}
                    onChange={(e) => setNewService(e.target.value)}
                    className="flex-1 border border-gray-300 rounded-lg px-3 py-3 text-base focus:ring-2 focus:ring-blue-500 touch-manipulation"
                    placeholder="Nom du service"
                  />
                  <button
                    type="button"
                    onClick={handleAddService}
                    className="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors touch-manipulation"
                  >
                    <Plus className="w-5 h-5" />
                  </button>
                  <button
                    type="button"
                    onClick={() => setShowAddService(false)}
                    className="px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors touch-manipulation"
                  >
                    <X className="w-5 h-5" />
                  </button>
                </div>
              )}
            </div>
          </div>

          {/* Date and Time */}
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                <Calendar className="h-4 w-4 mr-2" />
                Date
              </label>
              <input
                type="date"
                value={formData.date}
                onChange={(e) =>
                  setFormData((prev) => ({ ...prev, date: e.target.value }))
                }
                className="w-full py-4 px-4 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-manipulation"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                <Clock className="h-4 w-4 mr-2" />
                Heure
              </label>
              <button
                type="button"
                onClick={() => setShowTimeGrid(!showTimeGrid)}
                className="w-full text-left py-4 px-4 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 bg-white flex justify-between items-center touch-manipulation"
              >
                <span>{formData.time}</span>
                {isLoadingSlots && (
                  <Loader2 className="w-4 h-4 animate-spin text-blue-500" />
                )}
              </button>
            </div>
          </div>

          {/* Time Grid */}
          {showTimeGrid && (
            <div className="bg-gray-50 border border-gray-200 rounded-lg p-3">
              <div className="flex justify-between items-center mb-3">
                <span className="text-sm font-medium text-gray-700 flex items-center gap-2">
                  Disponibilités
                  {isLoadingSlots && (
                    <span className="text-xs text-blue-500">
                      (Chargement...)
                    </span>
                  )}
                </span>
                <button
                  type="button"
                  onClick={() => setShowTimeGrid(false)}
                  className="text-xs text-blue-600 font-medium touch-manipulation p-2"
                >
                  Fermer
                </button>
              </div>
              <div className="grid grid-cols-3 sm:grid-cols-4 gap-2 max-h-64 overflow-y-auto">
                {availableSlots.map((slot) => (
                  <button
                    key={slot.time}
                    type="button"
                    onClick={() => handleTimeSelect(slot)}
                    disabled={!slot.available}
                    className={`
                      px-3 py-3 text-sm font-medium rounded-lg border transition-all relative touch-manipulation
                      ${
                        slot.time === formData.time
                          ? 'bg-blue-600 text-white border-blue-600 shadow-sm'
                          : ''
                      }
                      ${
                        !slot.available
                          ? 'bg-gray-100 text-gray-300 border-gray-200 cursor-not-allowed line-through'
                          : slot.warning && slot.time !== formData.time
                          ? 'bg-orange-50 text-orange-800 border-orange-200 hover:bg-orange-100 active:bg-orange-200'
                          : slot.time !== formData.time
                          ? 'bg-white text-gray-900 border-gray-300 hover:border-blue-400 active:bg-blue-50'
                          : ''
                      }
                    `}
                    title={
                      slot.warning || (slot.available ? 'Disponible' : 'Occupé')
                    }
                  >
                    {slot.time}
                    {slot.warning &&
                      slot.available &&
                      slot.time !== formData.time && (
                        <span className="absolute -top-1 -right-1 w-2 h-2 bg-orange-500 rounded-full"></span>
                      )}
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Duration */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Durée (minutes)
            </label>
            <select
              value={
                showCustomDuration ? 'custom' : formData.duration.toString()
              }
              onChange={(e) => handleDurationChange(e.target.value)}
              className="w-full py-4 px-4 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 touch-manipulation"
            >
              <option value={15}>15 minutes</option>
              <option value={30}>30 minutes</option>
              <option value={45}>45 minutes</option>
              <option value={60}>1 heure</option>
              <option value={90}>1,5 heure</option>
              <option value={120}>2 heures</option>
              {customDurations.map((duration) => (
                <option key={duration} value={duration}>
                  {duration} minutes
                </option>
              ))}
              <option value="custom">Durée personnalisée</option>
            </select>

            {showCustomDuration && (
              <div className="flex gap-2 mt-2">
                <input
                  type="number"
                  value={customDuration}
                  onChange={(e) => setCustomDuration(e.target.value)}
                  className="flex-1 border border-gray-300 rounded-lg px-3 py-3 text-base touch-manipulation"
                  placeholder="Minutes"
                />
                <button
                  type="button"
                  onClick={handleCustomDurationSubmit}
                  className="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 touch-manipulation"
                >
                  OK
                </button>
              </div>
            )}

            {customDurations.length > 0 && (
              <div className="flex flex-wrap gap-2 mt-2">
                {customDurations.map((d) => (
                  <div
                    key={d}
                    className="flex items-center bg-gray-50 px-3 py-2 text-sm border rounded-lg"
                  >
                    <span className="mr-2">{d} min</span>
                    <button
                      type="button"
                      onClick={() => handleDeleteDuration(d)}
                      className="text-gray-400 hover:text-red-500 touch-manipulation p-1"
                    >
                      <X className="w-4 h-4" />
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Notes */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Notes
            </label>
            <textarea
              value={formData.notes}
              onChange={(e) =>
                setFormData((prev) => ({ ...prev, notes: e.target.value }))
              }
              className="w-full py-4 px-4 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 resize-none touch-manipulation"
              rows={3}
              placeholder="Notes supplémentaires..."
            />
          </div>

          {/* Price & Status */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Prix ($)
              </label>
              <input
                type="number"
                value={formData.price}
                onChange={(e) =>
                  setFormData((prev) => ({
                    ...prev,
                    price: parseFloat(e.target.value) || 0,
                  }))
                }
                className="w-full py-4 px-4 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 touch-manipulation"
                step="0.01"
                min="0"
              />
            </div>
            {appointment && (
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Statut
                </label>
                <select
                  value={formData.status}
                  onChange={(e) =>
                    setFormData((prev) => ({
                      ...prev,
                      status: e.target.value as any,
                    }))
                  }
                  className="w-full py-4 px-4 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 touch-manipulation"
                >
                  <option value="scheduled">Planifié</option>
                  <option value="completed">Terminé</option>
                  <option value="cancelled">Annulé</option>
                </select>
              </div>
            )}
          </div>

          {/* Action Buttons */}
          <div className="flex flex-col sm:flex-row gap-3 pt-4">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 py-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 active:bg-gray-100 font-medium transition-colors touch-manipulation"
            >
              Annuler
            </button>
            <button
              type="submit"
              disabled={isLoadingSlots}
              className={`flex-1 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:bg-blue-800 font-medium transition-colors touch-manipulation ${
                isLoadingSlots ? 'opacity-50 cursor-not-allowed' : ''
              }`}
            >
              {isLoadingSlots
                ? 'Vérification...'
                : appointment
                ? 'Modifier'
                : 'Créer'}
            </button>
          </div>
        </form>
      </div>

      {/* Warning Modal */}
      {showWarningModal && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[110] p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 border-t-4 border-orange-500 animate-in zoom-in-95 duration-200">
            <div className="flex items-center gap-3 text-orange-600 mb-4">
              <AlertTriangle className="h-8 w-8" />
              <h3 className="text-lg font-bold">Avertissement</h3>
            </div>

            <p className="text-gray-600 mb-6 text-base leading-relaxed">
              {warningMessage}
              <br />
              <br />
              Voulez-vous quand même enregistrer le rendez-vous à{' '}
              <span className="font-bold text-gray-900">{pendingTime}</span> ?
            </p>

            <div className="flex flex-col gap-3">
              <button
                type="button"
                onClick={() => {
                  if (pendingTime) {
                    setFormData((prev) => ({ ...prev, time: pendingTime }));
                    setShowWarningModal(false);
                    setShowTimeGrid(false);
                  }
                }}
                className="w-full py-4 bg-orange-500 hover:bg-orange-600 active:bg-orange-700 text-white rounded-xl font-bold transition-colors shadow-lg touch-manipulation"
              >
                Oui, confirmer l'heure
              </button>
              <button
                type="button"
                onClick={() => {
                  setShowWarningModal(false);
                  setPendingTime(null);
                }}
                className="w-full py-4 bg-gray-100 hover:bg-gray-200 active:bg-gray-300 text-gray-700 rounded-xl font-medium transition-colors touch-manipulation"
              >
                Non, choisir une autre heure
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default AppointmentModal;
</file>

<file path="src/components/Calendar/Calendar.tsx">
import React, { useState } from 'react';
import {
  ChevronLeft,
  ChevronRight,
  Plus,
  Calendar as CalendarIcon,
  Menu,
  AlertTriangle,
  X,
} from 'lucide-react';
import { Appointment, Client, Service } from '../../types';
import { supabase } from '../../lib/supabase';
import AppointmentModal from './AppointmentModal';
import AppointmentCard from './AppointmentCard';
import { ShowToastFunction } from '../../types/toast';

type CalendarView = 'month' | 'week' | 'day';

interface CalendarProps {
  appointments: Appointment[];
  clients: Client[];
  onAddAppointment: (appointment: Omit<Appointment, 'id'>) => Promise<boolean>;
  onUpdateAppointment: (
    id: string,
    appointment: Partial<Appointment>
  ) => Promise<boolean>;
  onDeleteAppointment?: (id: string) => Promise<boolean>; // 🆕 AJOUTE CECI
  showToast: ShowToastFunction;
  onMenuToggle: () => void;
}

const Calendar: React.FC<CalendarProps> = ({
  appointments,
  clients,
  onAddAppointment,
  onUpdateAppointment,
  onDeleteAppointment, // 🆕 DESTRUCTURE ICI
  showToast,
  onMenuToggle,
}) => {
  const [services, setServices] = useState<Service[]>([]);
  const [currentDate, setCurrentDate] = useState(new Date());
  const [showModal, setShowModal] = useState(false);
  const [selectedDate, setSelectedDate] = useState<string>('');
  const [editingAppointment, setEditingAppointment] =
    useState<Appointment | null>(null);
  const [deletingAppointment, setDeletingAppointment] =
    useState<Appointment | null>(null);
  const [view, setView] = useState<CalendarView>('day');

  // Charger les services au démarrage
  React.useEffect(() => {
    const fetchServices = async () => {
      const { data } = await supabase.from('services').select('*');
      if (data) setServices(data);
    };
    fetchServices();
  }, []);

  // Fonction pour ajouter un service
  const addService = async (name: string): Promise<boolean> => {
    try {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) return false;

      const { data, error } = await supabase
        .from('services')
        .insert([{ name, user_id: user.id }])
        .select()
        .single();

      if (error) throw error;
      if (data) {
        setServices((prev) => [...prev, data]);
        showToast('success', `Service "${name}" ajouté avec succès ! ✨`);
        return true;
      }
      return false;
    } catch (err) {
      console.error('Erreur ajout service:', err);
      showToast('error', "Erreur lors de l'ajout du service");
      return false;
    }
  };

  // Fonction pour supprimer un service
  const deleteService = async (id: string): Promise<boolean> => {
    try {
      const { error } = await supabase.from('services').delete().eq('id', id);
      if (error) throw error;
      setServices((prev) => prev.filter((s) => s.id !== id));
      showToast('warning', 'Service supprimé 🗑️');
      return true;
    } catch (err) {
      console.error('Erreur suppression service:', err);
      showToast('error', 'Erreur lors de la suppression du service');
      return false;
    }
  };

  const monthNames = [
    'Janvier',
    'Février',
    'Mars',
    'Avril',
    'Mai',
    'Juin',
    'Juillet',
    'Août',
    'Septembre',
    'Octobre',
    'Novembre',
    'Décembre',
  ];

  const dayNames = [
    'Dimanche',
    'Lundi',
    'Mardi',
    'Mercredi',
    'Jeudi',
    'Vendredi',
    'Samedi',
  ];

  const getDaysInMonth = (date: Date) => {
    const year = date.getFullYear();
    const month = date.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();

    const days = [];
    for (let i = 0; i < startingDayOfWeek; i++) {
      days.push(null);
    }
    for (let day = 1; day <= daysInMonth; day++) {
      days.push(day);
    }
    return days;
  };

  const getWeekDays = (date: Date) => {
    const startOfWeek = new Date(date);
    const day = startOfWeek.getDay();
    startOfWeek.setDate(date.getDate() - day);

    const days = [];
    for (let i = 0; i < 7; i++) {
      const currentDay = new Date(startOfWeek);
      currentDay.setDate(startOfWeek.getDate() + i);
      days.push(currentDay);
    }
    return days;
  };

  const navigateMonth = (direction: 'prev' | 'next') => {
    setCurrentDate((prev) => {
      const newDate = new Date(prev);
      if (view === 'month') {
        newDate.setMonth(prev.getMonth() + (direction === 'next' ? 1 : -1));
      } else if (view === 'week') {
        newDate.setDate(prev.getDate() + (direction === 'next' ? 7 : -7));
      } else {
        newDate.setDate(prev.getDate() + (direction === 'next' ? 1 : -1));
      }
      return newDate;
    });
  };

  const formatDate = (year: number, month: number, day: number) => {
    return `${year}-${String(month + 1).padStart(2, '0')}-${String(
      day
    ).padStart(2, '0')}`;
  };

  const formatDateFromDate = (date: Date) => {
    return formatDate(date.getFullYear(), date.getMonth(), date.getDate());
  };

  const getAppointmentsForDate = (dateString: string) => {
    return appointments.filter((apt) => apt.date === dateString);
  };

  const handleDateClick = (day: number) => {
    const dateString = formatDate(
      currentDate.getFullYear(),
      currentDate.getMonth(),
      day
    );
    setSelectedDate(dateString);
    setEditingAppointment(null);
    setShowModal(true);
  };

  const handleDateClickFromDate = (date: Date) => {
    const dateString = formatDateFromDate(date);
    setSelectedDate(dateString);
    setEditingAppointment(null);
    setShowModal(true);
  };

  const handleAppointmentClick = (
    appointment: Appointment,
    e: React.MouseEvent
  ) => {
    e.stopPropagation();
    setEditingAppointment(appointment);
    setSelectedDate(appointment.date);
    setShowModal(true);
  };

  const getClientById = (clientId: string) => {
    return clients.find((client) => client.id === clientId);
  };

  const getViewTitle = () => {
    if (view === 'month') {
      return `${
        monthNames[currentDate.getMonth()]
      } ${currentDate.getFullYear()}`;
    } else if (view === 'week') {
      const weekDays = getWeekDays(currentDate);
      const start = weekDays[0];
      const end = weekDays[6];
      if (start.getMonth() === end.getMonth()) {
        return `${
          monthNames[start.getMonth()]
        } ${start.getDate()}-${end.getDate()}, ${start.getFullYear()}`;
      } else {
        return `${monthNames[start.getMonth()]} ${start.getDate()} - ${
          monthNames[end.getMonth()]
        } ${end.getDate()}, ${start.getFullYear()}`;
      }
    } else {
      return `${dayNames[currentDate.getDay()]}, ${currentDate.getDate()} ${
        monthNames[currentDate.getMonth()]
      } ${currentDate.getFullYear()}`;
    }
  };

  const handleSaveAppointment = (appointmentData: Omit<Appointment, 'id'>) => {
    if (editingAppointment) {
      onUpdateAppointment(editingAppointment.id, appointmentData).then(
        (success) => {
          if (success) {
            showToast(
              'success',
              `Rendez-vous avec ${appointmentData.clientName} modifié ! 🎉`
            );
            setShowModal(false);
            setEditingAppointment(null);
          } else {
            showToast('error', 'Erreur lors de la modification du rendez-vous');
          }
        }
      );
    } else {
      onAddAppointment(appointmentData).then((success) => {
        if (success) {
          showToast(
            'success',
            `Rendez-vous avec ${appointmentData.clientName} créé ! 📅`
          );
          setShowModal(false);
          setEditingAppointment(null);
        } else {
          showToast('error', 'Erreur lors de la création du rendez-vous');
        }
      });
    }
  };

  const handleDeleteClick = (appointment: Appointment, e: React.MouseEvent) => {
    e.stopPropagation();
    setDeletingAppointment(appointment);
  };

  const confirmDelete = async () => {
    if (deletingAppointment && onDeleteAppointment) {
      const success = await onDeleteAppointment(deletingAppointment.id);

      if (success) {
        showToast(
          'warning',
          `Rendez-vous avec ${deletingAppointment.clientName} supprimé 🗑️`,
          3500
        );
        setDeletingAppointment(null);
        // ✅ Les appointments se mettent à jour automatiquement via les props
      } else {
        showToast('error', 'Erreur lors de la suppression du rendez-vous');
      }
    }
  };

  const cancelDelete = () => {
    setDeletingAppointment(null);
  };

  const renderMonthView = () => {
    const days = getDaysInMonth(currentDate);
    const today = new Date();
    const isCurrentMonth =
      currentDate.getMonth() === today.getMonth() &&
      currentDate.getFullYear() === today.getFullYear();

    return (
      <>
        <div className="grid grid-cols-7 gap-1 mb-4">
          {['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'].map((day) => (
            <div
              key={day}
              className="p-2 text-center text-sm font-medium text-gray-500"
            >
              {day}
            </div>
          ))}
        </div>

        <div className="grid grid-cols-7 gap-1">
          {days.map((day, index) => {
            if (!day) {
              return <div key={index} className="h-32 md:h-36"></div>;
            }

            const dateString = formatDate(
              currentDate.getFullYear(),
              currentDate.getMonth(),
              day
            );
            const dayAppointments = getAppointmentsForDate(dateString);
            const isToday = isCurrentMonth && day === today.getDate();

            return (
              <div
                key={day}
                onClick={() => handleDateClick(day)}
                className={`h-32 md:h-36 p-2 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 active:bg-gray-100 transition-colors touch-manipulation overflow-hidden ${
                  isToday ? 'bg-blue-50 border-blue-200' : ''
                }`}
              >
                <div
                  className={`text-sm font-semibold mb-2 flex items-center justify-between ${
                    isToday ? 'text-blue-600' : 'text-gray-900'
                  }`}
                >
                  <span>{day}</span>
                  {dayAppointments.length > 0 && (
                    <span className="bg-blue-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                      {dayAppointments.length}
                    </span>
                  )}
                </div>
                <div className="space-y-1 overflow-hidden">
                  {dayAppointments.slice(0, 3).map((apt) => (
                    <div
                      key={apt.id}
                      onClick={(e) => handleAppointmentClick(apt, e)}
                      className={`text-xs p-1.5 rounded cursor-pointer transition-colors ${
                        apt.status === 'scheduled'
                          ? 'bg-blue-100 text-blue-800 hover:bg-blue-200'
                          : apt.status === 'completed'
                          ? 'bg-green-100 text-green-800 hover:bg-green-200'
                          : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
                      }`}
                    >
                      <div className="font-medium truncate">{apt.time}</div>
                      <div className="truncate opacity-90">
                        {apt.clientName}
                      </div>
                    </div>
                  ))}
                  {dayAppointments.length > 3 && (
                    <div className="text-xs text-gray-500 text-center py-1">
                      +{dayAppointments.length - 3} de plus
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      </>
    );
  };

  const renderWeekView = () => {
    const weekDays = getWeekDays(currentDate);
    const today = new Date();

    return (
      <div className="space-y-4">
        <div className="grid grid-cols-7 gap-1 md:gap-2">
          {weekDays.map((date, index) => {
            const isToday = date.toDateString() === today.toDateString();
            const dateString = formatDateFromDate(date);
            const dayAppointments = getAppointmentsForDate(dateString);
            return (
              <div
                key={index}
                className={`text-center p-2 rounded ${
                  isToday ? 'bg-blue-100' : ''
                }`}
              >
                <div className="text-xs text-gray-500">
                  {dayNames[date.getDay()].slice(0, 3)}
                </div>
                <div
                  className={`text-lg font-semibold flex items-center justify-center gap-2 ${
                    isToday ? 'text-blue-600' : 'text-gray-900'
                  }`}
                >
                  {date.getDate()}
                  {dayAppointments.length > 0 && (
                    <span className="bg-blue-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">
                      {dayAppointments.length}
                    </span>
                  )}
                </div>
              </div>
            );
          })}
        </div>

        <div className="grid grid-cols-1 md:grid-cols-7 gap-2">
          {weekDays.map((date, index) => {
            const dateString = formatDateFromDate(date);
            const dayAppointments = getAppointmentsForDate(dateString);
            const isToday = date.toDateString() === today.toDateString();

            return (
              <div
                key={index}
                onClick={() => handleDateClickFromDate(date)}
                className={`min-h-48 p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 active:bg-gray-100 transition-colors touch-manipulation ${
                  isToday ? 'bg-blue-50 border-blue-200' : ''
                }`}
              >
                <div className="md:hidden mb-2">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">
                      {dayNames[date.getDay()]}, {date.getDate()}
                    </span>
                  </div>
                </div>
                <div className="space-y-2">
                  {dayAppointments.map((apt) => (
                    <AppointmentCard
                      key={apt.id}
                      appointment={apt}
                      client={getClientById(apt.clientId)}
                      onClick={(e) => handleAppointmentClick(apt, e)}
                      onDelete={(e) => handleDeleteClick(apt, e)}
                      showNavigation={true}
                    />
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    );
  };

  const renderDayView = () => {
    const dateString = formatDateFromDate(currentDate);
    const dayAppointments = getAppointmentsForDate(dateString).sort((a, b) =>
      a.time.localeCompare(b.time)
    );
    const today = new Date();
    const isToday = currentDate.toDateString() === today.toDateString();

    return (
      <div className="space-y-4">
        <div className="text-center bg-white rounded-lg shadow-sm p-4 border">
          <div
            className={`text-3xl font-bold ${
              isToday ? 'text-blue-600' : 'text-gray-900'
            }`}
          >
            {currentDate.getDate()}
          </div>
          <div className="text-lg text-gray-600">
            {dayNames[currentDate.getDay()]}
          </div>
          <div className="text-sm text-gray-500">
            {monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}
          </div>
          {dayAppointments.length > 0 && (
            <div className="mt-2 flex items-center justify-center gap-2">
              <span className="bg-blue-500 text-white text-sm rounded-full px-3 py-1">
                {dayAppointments.length} rendez-vous
              </span>
            </div>
          )}
        </div>

        {dayAppointments.length > 0 ? (
          <div className="space-y-3">
            {dayAppointments.map((apt) => (
              <div
                key={apt.id}
                className="bg-white rounded-lg shadow-sm border"
              >
                <AppointmentCard
                  appointment={apt}
                  client={getClientById(apt.clientId)}
                  onClick={(e) => handleAppointmentClick(apt, e)}
                  onDelete={(e) => handleDeleteClick(apt, e)}
                  showNavigation={true}
                />
              </div>
            ))}
          </div>
        ) : (
          <div className="text-center py-12 bg-white rounded-lg shadow-sm border">
            <div className="text-gray-400 mb-4">
              <CalendarIcon className="w-16 h-16 mx-auto" />
            </div>
            <h3 className="text-lg font-medium text-gray-900 mb-2">
              Aucun rendez-vous prévu
            </h3>
          </div>
        )}
      </div>
    );
  };

  const today = new Date();

  return (
    <div className="flex-1 overflow-auto">
      <div className="lg:hidden bg-white shadow-sm border-b border-gray-200 px-4 py-4 flex items-center justify-between sticky top-0 z-30">
        <button
          onClick={onMenuToggle}
          className="p-3 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 active:bg-gray-200 transition-colors"
        >
          <Menu className="h-6 w-6" />
        </button>
        <h1 className="text-xl font-semibold text-gray-900">Calendrier</h1>
        <div className="w-12"></div>
      </div>

      <div className="p-4 md:p-6">
        <div className="mb-6">
          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div className="flex items-center gap-4">
              <button
                onClick={onMenuToggle}
                className="hidden lg:flex p-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-colors"
              >
                <Menu className="h-6 w-6" />
              </button>
              <div>
                <h1 className="text-2xl md:text-3xl font-bold text-gray-900 hidden lg:block">
                  Calendrier
                </h1>
                <p className="text-gray-600 mt-2">
                  Planifiez et gérez les rendez-vous clients
                </p>
              </div>
            </div>
            <div className="flex flex-col sm:flex-row gap-2">
              <div className="flex bg-gray-100 rounded-lg p-1">
                <button
                  onClick={() => setView('day')}
                  className={`px-4 py-2 text-sm rounded-md transition-colors touch-manipulation ${
                    view === 'day'
                      ? 'bg-white text-gray-900 shadow-sm'
                      : 'text-gray-600'
                  }`}
                >
                  Jour
                </button>
                <button
                  onClick={() => setView('week')}
                  className={`px-4 py-2 text-sm rounded-md transition-colors touch-manipulation ${
                    view === 'week'
                      ? 'bg-white text-gray-900 shadow-sm'
                      : 'text-gray-600'
                  }`}
                >
                  Semaine
                </button>
                <button
                  onClick={() => setView('month')}
                  className={`px-4 py-2 text-sm rounded-md transition-colors touch-manipulation ${
                    view === 'month'
                      ? 'bg-white text-gray-900 shadow-sm'
                      : 'text-gray-600'
                  }`}
                >
                  Mois
                </button>
              </div>
              <button
                onClick={() => handleDateClickFromDate(today)}
                className="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white px-6 py-3 rounded-lg flex items-center justify-center transition-colors touch-manipulation"
              >
                <Plus className="h-4 w-4 mr-2" />
                <span className="hidden sm:inline">Nouveau rendez-vous</span>
                <span className="sm:hidden">Nouveau</span>
              </button>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow-md">
          <div className="px-4 md:px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <button
              onClick={() => navigateMonth('prev')}
              className="p-3 hover:bg-gray-100 active:bg-gray-200 rounded-lg transition-colors touch-manipulation"
            >
              <ChevronLeft className="h-5 w-5" />
            </button>
            <h2 className="text-lg md:text-xl font-semibold text-gray-900 text-center">
              {getViewTitle()}
            </h2>
            <button
              onClick={() => navigateMonth('next')}
              className="p-3 hover:bg-gray-100 active:bg-gray-200 rounded-lg transition-colors touch-manipulation"
            >
              <ChevronRight className="h-5 w-5" />
            </button>
          </div>

          <div className="p-4 md:p-6">
            {view === 'month' && renderMonthView()}
            {view === 'week' && renderWeekView()}
            {view === 'day' && renderDayView()}
          </div>
        </div>

        {showModal && (
          <AppointmentModal
            appointment={editingAppointment}
            existingAppointments={appointments}
            clients={clients}
            services={services}
            selectedDate={selectedDate}
            onSave={handleSaveAppointment}
            onAddService={addService}
            onDeleteService={deleteService}
            onClose={() => {
              setShowModal(false);
              setEditingAppointment(null);
            }}
          />
        )}

        {/* Delete Confirmation Modal avec Liquid Glass */}
        {deletingAppointment && (
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-fadeIn">
            <div
              className="relative w-full max-w-md"
              style={{
                animation: 'scaleIn 0.3s ease-out forwards',
              }}
            >
              {/* Background gradient rouge */}
              <div className="absolute inset-0 bg-gradient-to-br from-red-500 via-rose-600 to-pink-700 opacity-95 rounded-3xl" />

              {/* Glassmorphism layer */}
              <div className="absolute inset-0 backdrop-blur-xl bg-white/10 rounded-3xl" />

              {/* Bulles décoratives */}
              <div
                className="absolute -top-10 -left-10 w-40 h-40 bg-red-400/30 rounded-full blur-3xl animate-pulse"
                style={{ animationDuration: '3s' }}
              />
              <div
                className="absolute -bottom-10 -right-10 w-32 h-32 bg-pink-400/30 rounded-full blur-2xl animate-pulse"
                style={{ animationDuration: '4s', animationDelay: '1s' }}
              />

              {/* Content */}
              <div className="relative p-8">
                {/* Close button */}
                <button
                  onClick={cancelDelete}
                  className="absolute top-4 right-4 p-2 rounded-xl bg-white/15 backdrop-blur-md hover:bg-white/25 transition-all duration-300 border border-white/30 hover:scale-110 group"
                >
                  <X className="w-5 h-5 text-white group-hover:rotate-90 transition-transform duration-300" />
                </button>

                {/* Icon */}
                <div className="flex justify-center mb-6">
                  <div className="relative">
                    <div className="absolute inset-0 bg-white/30 rounded-full blur-xl" />
                    <div className="relative w-20 h-20 bg-white/20 backdrop-blur-lg rounded-full flex items-center justify-center border-2 border-white/40 shadow-2xl">
                      <AlertTriangle className="w-10 h-10 text-white drop-shadow-2xl animate-pulse" />
                    </div>
                  </div>
                </div>

                {/* Title */}
                <h3 className="text-2xl font-bold text-white text-center mb-3 drop-shadow-lg">
                  Supprimer le rendez-vous ?
                </h3>

                {/* Message */}
                <div className="bg-white/15 backdrop-blur-md rounded-2xl p-5 mb-6 border border-white/30 shadow-xl">
                  <p className="text-white/95 text-center leading-relaxed drop-shadow-md">
                    Voulez-vous vraiment supprimer le rendez-vous avec{' '}
                    <span className="font-bold text-white">
                      {deletingAppointment.clientName}
                    </span>{' '}
                    prévu le{' '}
                    <span className="font-semibold">
                      {new Date(deletingAppointment.date).toLocaleDateString(
                        'fr-FR'
                      )}
                    </span>{' '}
                    à{' '}
                    <span className="font-semibold">
                      {deletingAppointment.time}
                    </span>
                    ?
                  </p>
                  <p className="text-white/80 text-sm text-center mt-2 drop-shadow">
                    Cette action est irréversible.
                  </p>
                </div>

                {/* Buttons */}
                <div className="flex gap-3">
                  <button
                    onClick={cancelDelete}
                    className="flex-1 px-6 py-4 bg-white/20 backdrop-blur-lg hover:bg-white/30 text-white font-semibold rounded-xl transition-all duration-300 border border-white/40 hover:scale-105 shadow-lg"
                  >
                    Annuler
                  </button>
                  <button
                    onClick={confirmDelete}
                    className="flex-1 px-6 py-4 bg-white/90 hover:bg-white text-red-600 font-bold rounded-xl transition-all duration-300 border border-white shadow-2xl hover:scale-105 hover:shadow-red-500/50"
                  >
                    Supprimer
                  </button>
                </div>
              </div>

              <style>{`
                @keyframes fadeIn {
                  from { opacity: 0; }
                  to { opacity: 1; }
                }
                
                @keyframes scaleIn {
                  from {
                    transform: scale(0.9);
                    opacity: 0;
                  }
                  to {
                    transform: scale(1);
                    opacity: 1;
                  }
                }
              `}</style>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default Calendar;
</file>

<file path="src/components/Clients/AddressInput.tsx">
import React, { useRef, useState, useEffect } from 'react';
import { MapPin, Loader2 } from 'lucide-react';

interface AddressInputProps {
  value: string;
  onChange: (address: string) => void;
  placeholder?: string;
  required?: boolean;
  className?: string;
}

interface NominatimResult {
  place_id: number;
  display_name: string;
  lat: string;
  lon: string;
  address: {
    house_number?: string;
    road?: string;
    city?: string;
    town?: string;
    village?: string;
    municipality?: string;
    county?: string;
    state?: string;
    postcode?: string;
    country?: string;
  };
}

const AddressInput: React.FC<AddressInputProps> = ({
  value,
  onChange,
  placeholder = "Entrez l'adresse",
  required = false,
  className = '',
}) => {
  const inputRef = useRef<HTMLInputElement>(null);
  const [suggestions, setSuggestions] = useState<NominatimResult[]>([]);
  const [loading, setLoading] = useState(false);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const debounceTimer = useRef<NodeJS.Timeout>();

  // Fermer les suggestions si on clique ailleurs
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        inputRef.current &&
        !inputRef.current.contains(event.target as Node)
      ) {
        setShowSuggestions(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const formatAddress = (result: NominatimResult): string => {
    const addr = result.address;

    // On force la présence du numéro et de la rue
    if (!addr.house_number || !addr.road) {
      return result.display_name; // Fallback au cas où
    }

    const city =
      addr.city || addr.town || addr.village || addr.municipality || '';
    const parts = [
      `${addr.house_number} ${addr.road}`,
      city,
      addr.state,
      addr.postcode,
    ].filter(Boolean); // Enlève les éléments vides

    return parts.join(', ');
  };

  // Recherche d'adresses via Nominatim avec focus Québec/Ontario
  const fetchSuggestions = async (query: string) => {
    if (!query || query.length < 3) {
      setSuggestions([]);
      setShowSuggestions(false);
      return;
    }

    setLoading(true);
    try {
      // Configuration optimisée pour le Québec et l'Ontario
      const params = new URLSearchParams({
        format: 'json',
        q: query,
        addressdetails: '1',
        limit: '8',
        countrycodes: 'ca', // Canada uniquement
        'accept-language': 'fr,en', // Priorité au français
        bounded: '1', // Limiter aux zones spécifiées
        viewbox: '-80,42,-55,55', // Zone couvrant Québec et Ontario
        dedupe: '1', // Éviter les doublons
      });

      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?${params.toString()}`,
        {
          headers: {
            'User-Agent': 'OutilsInternes/1.0', // Requis par Nominatim
          },
        }
      );

      if (!response.ok) {
        throw new Error('Erreur de recherche');
      }

      const data: NominatimResult[] = await response.json();

      const filtered = data.filter((result) => {
        const hasHouseNumber = !!result.address.house_number; // Vérifie si le numéro existe
        const state = result.address.state?.toLowerCase() || '';
        const isTargetProvince =
          state.includes('québec') ||
          state.includes('quebec') ||
          state.includes('ontario');

        return hasHouseNumber && isTargetProvince;
      });

      setSuggestions(filtered);
      setShowSuggestions(filtered.length > 0);
    } catch (error) {
      console.error('Erreur Nominatim:', error);
      setSuggestions([]);
      setShowSuggestions(false);
    } finally {
      setLoading(false);
    }
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const inputValue = e.target.value;
    onChange(inputValue);

    // Debounce pour éviter trop de requêtes
    if (debounceTimer.current) {
      clearTimeout(debounceTimer.current);
    }

    debounceTimer.current = setTimeout(() => {
      fetchSuggestions(inputValue);
    }, 300); // Attendre 300ms après la dernière frappe
  };

  const handleSelect = (suggestion: NominatimResult) => {
    const formattedAddress = formatAddress(suggestion);
    onChange(formattedAddress);
    setSuggestions([]);
    setShowSuggestions(false);
  };

  const handleFocus = () => {
    if (suggestions.length > 0) {
      setShowSuggestions(true);
    }
  };

  return (
    <div className="relative" ref={inputRef}>
      <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <MapPin className="h-4 w-4 text-gray-400" />
      </div>

      <input
        type="text"
        value={value}
        onChange={handleInputChange}
        onFocus={handleFocus}
        className={`pl-10 pr-10 w-full border border-gray-300 rounded-lg px-4 py-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation ${className}`}
        placeholder={placeholder}
        required={required}
        autoComplete="off"
      />

      {loading && (
        <div className="absolute right-3 top-1/2 transform -translate-y-1/2">
          <Loader2 className="w-4 h-4 text-blue-600 animate-spin" />
        </div>
      )}

      {/* Liste des suggestions */}
      {showSuggestions && suggestions.length > 0 && (
        <ul className="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-80 overflow-auto">
          {suggestions.map((sug) => {
            const formattedAddress = formatAddress(sug);
            const province = sug.address.state;

            return (
              <li
                key={sug.place_id}
                onClick={() => handleSelect(sug)}
                className="px-4 py-3 cursor-pointer hover:bg-blue-50 active:bg-blue-100 border-b border-gray-100 last:border-b-0 transition-colors"
              >
                <div className="flex items-start gap-2">
                  <MapPin className="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" />
                  <div className="flex-1 min-w-0">
                    <div className="font-medium text-gray-900 truncate">
                      {formattedAddress}
                    </div>
                    {province && (
                      <div className="text-sm text-gray-600 mt-0.5">
                        {province}, Canada
                      </div>
                    )}
                  </div>
                </div>
              </li>
            );
          })}
        </ul>
      )}

      {/* Message si aucun résultat */}
      {!loading &&
        showSuggestions &&
        suggestions.length === 0 &&
        value.length >= 3 && (
          <div className="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg p-4">
            <div className="text-center text-gray-600">
              <MapPin className="w-8 h-8 mx-auto mb-2 text-gray-400" />
              <p className="text-sm">
                Aucune adresse trouvée au Québec ou en Ontario
              </p>
              <p className="text-xs text-gray-500 mt-1">
                Essayez d'inclure le numéro civique, la rue et la ville
              </p>
            </div>
          </div>
        )}
    </div>
  );
};

export default AddressInput;
</file>

<file path="src/components/Clients/ClientList.tsx">
import React, { useState } from 'react';
import {
  Search,
  Plus,
  Edit,
  Trash2,
  Phone,
  User,
  Menu,
  Calendar,
  AlertTriangle,
  X,
} from 'lucide-react';
import { Client, Appointment } from '../../types';
import ClientModal from './ClientModal';
import { ShowToastFunction } from '../../types/toast';

interface ClientListProps {
  clients: Client[];
  appointments: Appointment[];
  onAddClient: (client: Omit<Client, 'id' | 'createdAt'>) => Promise<boolean>;
  onUpdateClient: (id: string, client: Partial<Client>) => Promise<boolean>;
  onDeleteClient: (id: string) => Promise<boolean>;
  showToast: ShowToastFunction;
  onMenuToggle: () => void;
}

const ClientList: React.FC<ClientListProps> = ({
  clients,
  appointments,
  onAddClient,
  onUpdateClient,
  onDeleteClient,
  showToast,
  onMenuToggle,
}) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingClient, setEditingClient] = useState<Client | null>(null);
  const [deletingClient, setDeletingClient] = useState<Client | null>(null);

  const getLastAppointmentCost = (clientId: string) => {
    const clientAppointments = appointments
      .filter((apt) => apt.clientId === clientId)
      .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

    const lastAppointment = clientAppointments[0];
    return lastAppointment?.price || 0;
  };

  const filteredClients = clients.filter(
    (client) =>
      client.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      client.contactPersonName.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const handleAddClient = () => {
    setEditingClient(null);
    setIsModalOpen(true);
  };

  const handleEditClient = (client: Client) => {
    setEditingClient(client);
    setIsModalOpen(true);
  };

  const handleSaveClient = (clientData: Omit<Client, 'id'>) => {
    if (editingClient) {
      onUpdateClient(editingClient.id, clientData).then((success) => {
        if (success) {
          showToast(
            'success',
            `Client ${clientData.name} modifié avec succès ! 🎉`
          );
          setIsModalOpen(false);
          setEditingClient(null);
        } else {
          showToast('error', 'Erreur lors de la modification du client');
        }
      });
    } else {
      onAddClient(clientData).then((success) => {
        if (success) {
          showToast(
            'success',
            `Client ${clientData.name} créé avec succès ! ✨`
          );
          setIsModalOpen(false);
          setEditingClient(null);
        } else {
          showToast('error', 'Erreur lors de la création du client');
        }
      });
    }
  };

  const handleDeleteClick = (client: Client) => {
    setDeletingClient(client);
  };

  const confirmDelete = () => {
    if (deletingClient) {
      onDeleteClient(deletingClient.id).then((success) => {
        if (success) {
          showToast(
            'warning',
            `${deletingClient.name} a été supprimé 🗑️`,
            3500
          );
          setDeletingClient(null);
        } else {
          showToast('error', 'Erreur lors de la suppression du client');
        }
      });
    }
  };

  const cancelDelete = () => {
    setDeletingClient(null);
  };

  return (
    <div className="flex-1 overflow-auto">
      {/* Mobile Header */}
      <div className="lg:hidden bg-white shadow-sm border-b border-gray-200 px-4 py-4 flex items-center justify-between sticky top-0 z-30">
        <button
          onClick={onMenuToggle}
          className="p-3 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 active:bg-gray-200 transition-colors"
        >
          <Menu className="h-6 w-6" />
        </button>
        <h1 className="text-xl font-semibold text-gray-900">Clients</h1>
        <div className="w-12"></div>
      </div>

      <div className="p-4 md:p-6 space-y-6">
        {/* Header */}
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div className="flex items-center gap-4">
            <button
              onClick={onMenuToggle}
              className="hidden lg:flex p-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-colors"
            >
              <Menu className="h-6 w-6" />
            </button>
            <div>
              <h1 className="text-2xl sm:text-3xl font-bold text-gray-900 hidden lg:block">
                Clients
              </h1>
              <p className="text-gray-600 lg:hidden">
                Gérez votre base de données clients
              </p>
            </div>
          </div>
          <button
            onClick={handleAddClient}
            className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors w-full sm:w-auto justify-center touch-manipulation font-medium"
          >
            <Plus className="w-4 h-4" />
            Ajouter un client
          </button>
        </div>

        {/* Search */}
        <div className="relative">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
          <input
            type="text"
            placeholder="Rechercher des clients..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full pl-10 pr-4 py-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base touch-manipulation"
          />
        </div>

        {/* Client Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
          {filteredClients.map((client) => (
            <div
              key={client.id}
              className="bg-white rounded-lg shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow"
            >
              <div className="flex items-start justify-between mb-4">
                <div className="flex-1 min-w-0">
                  <h3 className="text-lg font-semibold text-gray-900 truncate">
                    {client.name}
                  </h3>
                  <p className="text-sm text-gray-600 truncate">
                    Contact : {client.contactPersonName}
                  </p>
                </div>
                <div className="flex gap-1 ml-2">
                  <button
                    onClick={() => handleEditClient(client)}
                    className="p-3 text-gray-400 hover:text-blue-600 hover:bg-blue-50 active:bg-blue-100 rounded-lg transition-colors touch-manipulation"
                  >
                    <Edit className="w-4 h-4" />
                  </button>
                  <button
                    onClick={() => handleDeleteClick(client)}
                    className="p-3 text-gray-400 hover:text-red-600 hover:bg-red-50 active:bg-red-100 rounded-lg transition-colors touch-manipulation"
                  >
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              </div>

              <div className="space-y-2">
                <div className="flex items-center gap-2 text-sm text-gray-600">
                  <Phone className="w-4 h-4 flex-shrink-0" />
                  <div className="flex flex-col">
                    <a
                      href={`tel:${client.phone}`}
                      className="truncate hover:text-blue-600 transition-colors"
                    >
                      Client : {client.phone}
                    </a>
                    <a
                      href={`tel:${client.contactPersonPhone}`}
                      className="truncate hover:text-blue-600 transition-colors text-xs"
                    >
                      Contact : {client.contactPersonPhone}
                    </a>
                  </div>
                </div>
                <div className="flex items-center gap-2 text-sm text-gray-600 mt-2">
                  <User className="w-4 h-4 flex-shrink-0" />
                  <span className="truncate">{client.address}</span>
                </div>
                <div className="flex items-center gap-2 text-sm text-gray-600 mt-1">
                  <Calendar className="w-4 h-4 flex-shrink-0" />
                  <span className="truncate">
                    {client.frequency === 'weekly'
                      ? 'Hebdomadaire'
                      : client.frequency === 'biweekly'
                      ? 'Bi-hebdomadaire'
                      : client.frequency === 'monthly'
                      ? 'Mensuel'
                      : client.frequency === 'quarterly'
                      ? 'Trimestriel'
                      : `Personnalisé (${client.customFrequencyDays} jours)`}
                  </span>
                </div>
                <div className="flex items-center justify-between text-sm text-gray-600 mt-2 pt-2 border-t border-gray-100">
                  <span>Dernier coût :</span>
                  <span className="font-semibold text-green-600">
                    ${getLastAppointmentCost(client.id).toFixed(2)}
                  </span>
                </div>
              </div>

              {client.notes && (
                <div className="mt-3 pt-3 border-t border-gray-100">
                  <p className="text-sm text-gray-600 line-clamp-2">
                    {client.notes}
                  </p>
                </div>
              )}
            </div>
          ))}
        </div>

        {filteredClients.length === 0 && (
          <div className="text-center py-8 sm:py-12">
            <div className="text-gray-400 mb-4">
              <Search className="w-12 h-12 mx-auto" />
            </div>
            <h3 className="text-lg font-medium text-gray-900 mb-2">
              Aucun client trouvé
            </h3>
            <p className="text-gray-600 mb-4">
              {searchTerm
                ? "Essayez d'ajuster vos termes de recherche"
                : 'Commencez par ajouter votre premier client'}
            </p>
            {!searchTerm && (
              <button
                onClick={handleAddClient}
                className="inline-flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors touch-manipulation font-medium"
              >
                <Plus className="w-4 h-4" />
                Ajouter un client
              </button>
            )}
          </div>
        )}

        {/* Client Modal */}
        {isModalOpen && (
          <ClientModal
            client={editingClient}
            onSave={handleSaveClient}
            onClose={() => {
              setIsModalOpen(false);
              setEditingClient(null);
            }}
          />
        )}

        {/* Delete Confirmation Modal avec Liquid Glass */}
        {deletingClient && (
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-fadeIn">
            <div
              className="relative w-full max-w-md"
              style={{
                animation: 'scaleIn 0.3s ease-out forwards',
              }}
            >
              {/* Background gradient rouge */}
              <div className="absolute inset-0 bg-gradient-to-br from-red-500 via-rose-600 to-pink-700 opacity-95 rounded-3xl" />

              {/* Glassmorphism layer */}
              <div className="absolute inset-0 backdrop-blur-xl bg-white/10 rounded-3xl" />

              {/* Bulles décoratives */}
              <div
                className="absolute -top-10 -left-10 w-40 h-40 bg-red-400/30 rounded-full blur-3xl animate-pulse"
                style={{ animationDuration: '3s' }}
              />
              <div
                className="absolute -bottom-10 -right-10 w-32 h-32 bg-pink-400/30 rounded-full blur-2xl animate-pulse"
                style={{ animationDuration: '4s', animationDelay: '1s' }}
              />

              {/* Content */}
              <div className="relative p-8">
                {/* Close button */}
                <button
                  onClick={cancelDelete}
                  className="absolute top-4 right-4 p-2 rounded-xl bg-white/15 backdrop-blur-md hover:bg-white/25 transition-all duration-300 border border-white/30 hover:scale-110 group"
                >
                  <X className="w-5 h-5 text-white group-hover:rotate-90 transition-transform duration-300" />
                </button>

                {/* Icon */}
                <div className="flex justify-center mb-6">
                  <div className="relative">
                    <div className="absolute inset-0 bg-white/30 rounded-full blur-xl" />
                    <div className="relative w-20 h-20 bg-white/20 backdrop-blur-lg rounded-full flex items-center justify-center border-2 border-white/40 shadow-2xl">
                      <AlertTriangle className="w-10 h-10 text-white drop-shadow-2xl animate-pulse" />
                    </div>
                  </div>
                </div>

                {/* Title */}
                <h3 className="text-2xl font-bold text-white text-center mb-3 drop-shadow-lg">
                  Êtes-vous sûr ?
                </h3>

                {/* Message */}
                <div className="bg-white/15 backdrop-blur-md rounded-2xl p-5 mb-6 border border-white/30 shadow-xl">
                  <p className="text-white/95 text-center leading-relaxed drop-shadow-md">
                    Voulez-vous vraiment supprimer le client{' '}
                    <span className="font-bold text-white">
                      {deletingClient.name}
                    </span>{' '}
                    ?
                  </p>
                  <p className="text-white/80 text-sm text-center mt-2 drop-shadow">
                    Cette action est irréversible.
                  </p>
                </div>

                {/* Buttons */}
                <div className="flex gap-3">
                  <button
                    onClick={cancelDelete}
                    className="flex-1 px-6 py-4 bg-white/20 backdrop-blur-lg hover:bg-white/30 text-white font-semibold rounded-xl transition-all duration-300 border border-white/40 hover:scale-105 shadow-lg"
                  >
                    Annuler
                  </button>
                  <button
                    onClick={confirmDelete}
                    className="flex-1 px-6 py-4 bg-white/90 hover:bg-white text-red-600 font-bold rounded-xl transition-all duration-300 border border-white shadow-2xl hover:scale-105 hover:shadow-red-500/50"
                  >
                    Supprimer
                  </button>
                </div>
              </div>

              <style>{`
                @keyframes fadeIn {
                  from {
                    opacity: 0;
                  }
                  to {
                    opacity: 1;
                  }
                }
                
                @keyframes scaleIn {
                  from {
                    transform: scale(0.9);
                    opacity: 0;
                  }
                  to {
                    transform: scale(1);
                    opacity: 1;
                  }
                }
              `}</style>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default ClientList;
</file>

<file path="src/components/Clients/ClientModal.tsx">
import React, { useState, useEffect } from 'react';
import { X, User, Phone, UserCheck, Calendar } from 'lucide-react';
import { Client } from '../../types';
import AddressInput from './AddressInput';
import { usePreferences } from '../../hooks/usePreferences';

interface ClientModalProps {
  client?: Client | null;
  onSave: (client: Omit<Client, 'id' | 'createdAt'>) => void;
  onClose: () => void;
}

const ClientModal: React.FC<ClientModalProps> = ({
  client,
  onSave,
  onClose,
}) => {
  const { preferences } = usePreferences();

  const [formData, setFormData] = useState({
    name: '',
    phone: '',
    address: '',
    contactPersonName: '',
    contactPersonPhone: '',
    frequency: '',
    customFrequencyDays: 30,
    notes: '',
  });
  const [showCustomFrequency, setShowCustomFrequency] = useState(false);

  useEffect(() => {
    if (client) {
      setFormData({
        name: client.name,
        phone: client.phone, // Assurez-vous que la BDD stocke le format ou brut, ici on l'affichera tel quel
        address: client.address,
        contactPersonName: client.contactPersonName || '',
        contactPersonPhone: client.contactPersonPhone || '',
        frequency: client.frequency,
        customFrequencyDays: client.customFrequencyDays || 30,
        notes: client.notes || '',
      });
      setShowCustomFrequency(client.frequency === 'custom');
    } else if (
      preferences &&
      preferences.frequency_options.length > 0 &&
      !formData.frequency
    ) {
      setFormData((prev) => ({
        ...prev,
        frequency: preferences.frequency_options[0].value,
      }));
    }
  }, [client, preferences]);

  // --- NOUVELLE FONCTION DE FORMATAGE ---
  const formatPhoneNumber = (value: string) => {
    // 1. On nettoie tout ce qui n'est pas un chiffre
    const numbers = value.replace(/\D/g, '');

    // 2. On formate selon la longueur (Max 10 chiffres)
    if (numbers.length === 0) return '';
    
    // Si moins de 4 chiffres : (123
    if (numbers.length < 4) return `(${numbers}`;
    
    // Si moins de 7 chiffres : (123) 456
    if (numbers.length < 7) {
      return `(${numbers.slice(0, 3)}) ${numbers.slice(3)}`;
    }

    // Si 7 chiffres ou plus : (123) 456-7890
    return `(${numbers.slice(0, 3)}) ${numbers.slice(3, 6)}-${numbers.slice(6, 10)}`;
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    onSave(formData);
  };

  const handleChange = (
    e: React.ChangeEvent<
      HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement
    >
  ) => {
    const { name, value } = e.target;

    // --- MODIFICATION ICI POUR LE FORMATAGE TÉLÉPHONE ---
    if (name === 'phone' || name === 'contactPersonPhone') {
      // On applique le formatage avant de sauvegarder dans le state
      const formattedPhone = formatPhoneNumber(value);
      setFormData((prev) => ({ ...prev, [name]: formattedPhone }));
    } 
    // Logique existante pour la fréquence
    else if (name === 'frequency') {
      setShowCustomFrequency(value === 'custom');
      if (value !== 'custom') {
        setFormData((prev) => ({
          ...prev,
          [name]: value,
          customFrequencyDays: undefined,
        }));
      } else {
        setFormData((prev) => ({ ...prev, [name]: value }));
      }
    } else {
      setFormData((prev) => ({ ...prev, [name]: value }));
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50 p-0 sm:p-4">
      <div className="bg-white rounded-t-2xl sm:rounded-lg shadow-xl w-full sm:max-w-md sm:w-full max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between p-6 border-b border-gray-200">
          <h2 className="text-lg sm:text-xl font-semibold text-gray-900">
            {client ? 'Modifier le client' : 'Ajouter un nouveau client'}
          </h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition-colors touch-manipulation"
          >
            <X className="h-6 w-6" />
          </button>
        </div>

        <form onSubmit={handleSubmit} className="p-4 sm:p-6 space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
              <User className="h-4 w-4 inline mr-2" />
              Nom du client
            </label>
            <input
              type="text"
              name="name"
              value={formData.name}
              onChange={handleChange}
              className="w-full border border-gray-300 rounded-lg px-4 py-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation"
              placeholder="Entrez le nom du client"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
              <Phone className="h-4 w-4 inline mr-2" />
              Numéro de téléphone du client
            </label>
            <input
              type="tel"
              name="phone"
              value={formData.phone}
              onChange={handleChange}
              maxLength={14} // (123) 456-7890 fait 14 caractères
              className="w-full border border-gray-300 rounded-lg px-4 py-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation"
              placeholder="(123) 456-7890" // Placeholder mis à jour
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Adresse
            </label>
            <AddressInput
              value={formData.address}
              onChange={(address) =>
                setFormData((prev) => ({ ...prev, address }))
              }
              placeholder="Entrez l'adresse du client"
              required={true}
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
              <UserCheck className="h-4 w-4 inline mr-2" />
              Nom de la personne de contact
            </label>
            <input
              type="text"
              name="contactPersonName"
              value={formData.contactPersonName}
              onChange={handleChange}
              className="w-full border border-gray-300 rounded-lg px-4 py-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation"
              placeholder="Entrez le nom de la personne de contact"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
              <Phone className="h-4 w-4 inline mr-2" />
              Téléphone portable de la personne de contact
            </label>
            <input
              type="tel"
              name="contactPersonPhone"
              value={formData.contactPersonPhone}
              onChange={handleChange}
              maxLength={14} // (123) 456-7890 fait 14 caractères
              className="w-full border border-gray-300 rounded-lg px-4 py-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation"
              placeholder="(123) 456-7890" // Placeholder mis à jour
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
              <Calendar className="h-4 w-4 inline mr-2" />
              Fréquence des rendez-vous
            </label>

            <select
              name="frequency"
              value={formData.frequency}
              onChange={handleChange}
              className="w-full border border-gray-300 rounded-lg px-4 py-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation"
              required
            >
              <option value="" disabled>
                Sélectionner une fréquence
              </option>

              {preferences?.frequency_options.map((option) => (
                <option key={option.value} value={option.value}>
                  {option.label} ({option.days} jours)
                </option>
              ))}

              <option value="custom">Personnalisé</option>
            </select>

            {showCustomFrequency && (
              <div className="mt-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Nombre de jours personnalisé
                </label>
                <input
                  type="number"
                  name="customFrequencyDays"
                  value={formData.customFrequencyDays}
                  onChange={handleChange}
                  min="1"
                  max="365"
                  className="w-full border border-gray-300 rounded-lg px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation"
                  placeholder="Entrez le nombre de jours"
                  required={showCustomFrequency}
                />
              </div>
            )}
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
              Notes
            </label>
            <textarea
              name="notes"
              value={formData.notes}
              onChange={handleChange}
              className="w-full border border-gray-300 rounded-lg px-4 py-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation resize-none"
              rows={3}
              placeholder="Notes supplémentaires sur le client"
            />
          </div>

          <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 pt-4">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 px-6 py-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors touch-manipulation font-medium"
            >
              Annuler
            </button>
            <button
              type="submit"
              className="flex-1 px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors touch-manipulation font-medium"
            >
              {client ? 'Modifier' : 'Ajouter'} le client
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default ClientModal;
</file>

<file path="src/components/Dashboard/Dashboard.tsx">
import React, { useState, useEffect } from 'react';
import { Calendar, Users, Clock, TrendingUp, Menu, DollarSign } from 'lucide-react';
import { Appointment, Client } from '../../types';
import AppointmentCard from '../Calendar/AppointmentCard';
import { useActivityLogs } from '../../hooks/useActivityLogs';
import { useExpenses } from '../../hooks/useExpenses';
import { calculateDashboardStats, formatCurrency } from '../../utils/statistics';

interface DashboardProps {
  appointments: Appointment[];
  clients: Client[];
  onMenuToggle: () => void;
}

const Dashboard: React.FC<DashboardProps> = ({ appointments, clients, onMenuToggle }) => {
  const { activities } = useActivityLogs();
  const { getTotalExpenses } = useExpenses();
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];

  const todayAppointments = appointments.filter(apt => apt.date === todayStr);
  const upcomingAppointments = appointments.filter(apt => apt.date > todayStr).slice(0, 5);
  const thisWeekAppointments = appointments.filter(apt => {
    const aptDate = new Date(apt.date);
    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() - today.getDay());
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    return aptDate >= weekStart && aptDate <= weekEnd;
  });

  const getClientById = (clientId: string) => {
    return clients.find(client => client.id === clientId);
  };

  const stats = calculateDashboardStats(
    clients.length,
    todayAppointments.length,
    thisWeekAppointments.length,
    appointments
  );

  const totalExpenses = getTotalExpenses();
  const netProfit = stats.totalRevenue - totalExpenses;

  const statCards = [
    {
      title: 'Total des clients',
      value: stats.totalClients,
      icon: Users,
      color: 'bg-blue-500',
      change: `${stats.clientsChange > 0 ? '+' : '-'}${Math.abs(stats.clientsChange)}%`,
    },
    {
      title: 'Rendez-vous d\'aujourd\'hui',
      value: stats.todayAppointments,
      icon: Calendar,
      color: 'bg-green-500',
      change: `${stats.appointmentsChange > 0 ? '+' : '-'}${Math.abs(stats.appointmentsChange)}%`,
    },
    {
      title: 'Cette semaine',
      value: stats.weekAppointments,
      icon: Clock,
      color: 'bg-cyan-500',
      change: `${stats.weekChange > 0 ? '+' : '-'}${Math.abs(stats.weekChange)}%`,
    },
    {
      title: 'Revenus',
      value: formatCurrency(stats.totalRevenue),
      icon: TrendingUp,
      color: 'bg-orange-500',
      change: `${stats.revenueChange > 0 ? '+' : '-'}${Math.abs(stats.revenueChange)}%`,
    },
    {
      title: 'Profit net',
      value: formatCurrency(netProfit),
      icon: DollarSign,
      color: netProfit >= 0 ? 'bg-emerald-500' : 'bg-red-500',
      change: netProfit >= 0 ? '+' : '-',
    },
  ];

  return (
    <div className="flex-1 overflow-auto">
      {/* Mobile Header */}
      <div className="lg:hidden bg-white shadow-sm border-b border-gray-200 px-4 py-4 flex items-center justify-between sticky top-0 z-30">
        <button
          onClick={onMenuToggle}
          className="p-3 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 active:bg-gray-200 transition-colors"
        >
          <Menu className="h-6 w-6" />
        </button>
        <h1 className="text-xl font-semibold text-gray-900">Tableau de bord</h1>
        <div className="w-12"></div>
      </div>

      <div className="p-4 md:p-6 space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <div className="flex items-center gap-4">
              <button
                onClick={onMenuToggle}
                className="hidden lg:flex p-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-colors"
              >
                <Menu className="h-6 w-6" />
              </button>
              <div>
                <h1 className="text-2xl md:text-3xl font-bold text-gray-900">Tableau de bord</h1>
                <p className="text-gray-600 mt-1">Bon retour ! Voici ce qui se passe aujourd'hui.</p>
              </div>
            </div>
          </div>
        </div>

        {/* Stats Grid */}
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 md:gap-6">
          {statCards.map((stat, index) => (
            <div key={index} className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-gray-600">{stat.title}</p>
                  <p className="text-3xl font-bold text-gray-900 mt-2">{stat.value}</p>
                </div>
                <div className={`${stat.color} p-3 rounded-lg`}>
                  <stat.icon className="w-6 h-6 text-white" />
                </div>
              </div>
              <div className="mt-4 flex items-center">
                <span className={`text-sm font-medium ${stat.change.startsWith('+') ? 'text-green-600' : 'text-red-600'}`}>{stat.change}</span>
                <span className="text-sm text-gray-600 ml-1">par rapport au mois dernier</span>
              </div>
            </div>
          ))}
        </div>

        {/* Content Grid */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Today's Appointments */}
          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-xl font-semibold text-gray-900 mb-4">Rendez-vous d'aujourd'hui</h2>
            {todayAppointments.length > 0 ? (
              <div className="space-y-3">
                {todayAppointments.map((appointment) => (
                  <AppointmentCard
                    key={appointment.id}
                    appointment={appointment}
                    client={getClientById(appointment.clientId)}
                    showNavigation={true}
                  />
                ))}
              </div>
            ) : (
              <div className="text-center py-8">
                <Calendar className="w-12 h-12 text-gray-400 mx-auto mb-3" />
                <p className="text-gray-600">Aucun rendez-vous prévu pour aujourd'hui</p>
              </div>
            )}
          </div>

          {/* Upcoming Appointments */}
          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-xl font-semibold text-gray-900 mb-4">Prochains rendez-vous</h2>
            {upcomingAppointments.length > 0 ? (
              <div className="space-y-3">
                {upcomingAppointments.map((appointment) => (
                  <AppointmentCard
                    key={appointment.id}
                    appointment={appointment}
                    client={getClientById(appointment.clientId)}
                    showNavigation={false}
                  />
                ))}
              </div>
            ) : (
              <div className="text-center py-8">
                <Clock className="w-12 h-12 text-gray-400 mx-auto mb-3" />
                <p className="text-gray-600">Aucun rendez-vous à venir</p>
              </div>
            )}
          </div>
        </div>

        {/* Recent Activity */}
        <div className="bg-white rounded-lg shadow-md p-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-4">Activité récente</h2>
          {activities.length > 0 ? (
            <div className="space-y-4">
              {activities.map((activity) => {
                const getActivityColor = (actionType: string) => {
                  if (actionType.includes('added')) return { bg: 'bg-blue-50', dot: 'bg-blue-500' };
                  if (actionType.includes('completed')) return { bg: 'bg-green-50', dot: 'bg-green-500' };
                  if (actionType.includes('deleted')) return { bg: 'bg-red-50', dot: 'bg-red-500' };
                  return { bg: 'bg-yellow-50', dot: 'bg-yellow-500' };
                };

                const colors = getActivityColor(activity.actionType);
                const timeAgo = getTimeAgo(new Date(activity.createdAt));

                return (
                  <div key={activity.id} className={`flex items-center gap-4 p-4 ${colors.bg} rounded-lg`}>
                    <div className={`w-3 h-3 ${colors.dot} rounded-full flex-shrink-0`}></div>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm text-gray-700 truncate">{activity.description}</p>
                      <span className="text-xs text-gray-500">{timeAgo}</span>
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <div className="text-center py-8">
              <p className="text-gray-600">Aucune activité récente</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

const getTimeAgo = (date: Date): string => {
  const now = new Date();
  const seconds = Math.floor((now.getTime() - date.getTime()) / 1000);

  if (seconds < 60) return 'À l\'instant';
  if (seconds < 3600) return `Il y a ${Math.floor(seconds / 60)} minute${Math.floor(seconds / 60) > 1 ? 's' : ''}`;
  if (seconds < 86400) return `Il y a ${Math.floor(seconds / 3600)} heure${Math.floor(seconds / 3600) > 1 ? 's' : ''}`;
  if (seconds < 604800) return `Il y a ${Math.floor(seconds / 86400)} jour${Math.floor(seconds / 86400) > 1 ? 's' : ''}`;
  return `Il y a ${Math.floor(seconds / 604800)} semaine${Math.floor(seconds / 604800) > 1 ? 's' : ''}`;
};

export default Dashboard;
</file>

<file path="src/components/Expenses/ExpenseList.tsx">
import { Trash2, Edit2, Calendar as CalendarIcon } from 'lucide-react';
import { Expense } from '../../hooks/useExpenses';
// 1. Import du hook
import { usePreferences } from '../../hooks/usePreferences';

interface ExpenseListProps {
  expenses: Expense[];
  loading: boolean;
  onEdit: (expense: Expense) => void;
  onDelete: (expense: Expense) => void; // 🆕 Passe l'expense complet au lieu de l'id
}

// 2. Palette de couleurs pour l'attribution dynamique
const COLOR_PALETTE = [
  'bg-blue-100 text-blue-800',
  'bg-purple-100 text-purple-800',
  'bg-orange-100 text-orange-800',
  'bg-green-100 text-green-800',
  'bg-pink-100 text-pink-800',
  'bg-indigo-100 text-indigo-800',
  'bg-yellow-100 text-yellow-800',
  'bg-teal-100 text-teal-800',
  'bg-red-100 text-red-800',
  'bg-cyan-100 text-cyan-800',
];

export const ExpenseList = ({
  expenses,
  loading,
  onEdit,
  onDelete,
}: ExpenseListProps) => {
  // 3. Récupération des préférences pour avoir les labels
  const { preferences } = usePreferences();

  // Fonction helper pour obtenir les détails d'affichage d'une catégorie
  const getCategoryDisplay = (categoryValue: string) => {
    if (!preferences?.expense_categories) {
      return { label: categoryValue, color: 'bg-gray-100 text-gray-800' };
    }

    // On cherche l'index pour attribuer une couleur et l'objet pour le label
    const index = preferences.expense_categories.findIndex(
      (c) => c.value === categoryValue
    );

    if (index === -1) {
      // Si la catégorie n'existe plus dans les préférences (ex: ancienne donnée)
      return { label: categoryValue, color: 'bg-gray-100 text-gray-800' };
    }

    const category = preferences.expense_categories[index];
    // On boucle sur la palette si on a plus de catégories que de couleurs
    const color = COLOR_PALETTE[index % COLOR_PALETTE.length];

    return { label: category.label, color };
  };

  if (loading) {
    return (
      <div className="flex flex-col items-center justify-center py-12">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"></div>
        <p className="text-gray-500 text-sm">Chargement des dépenses...</p>
      </div>
    );
  }

  if (expenses.length === 0) {
    return (
      <div className="text-center py-12 px-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
        <p className="text-gray-500 font-medium">Aucune dépense enregistrée</p>
        <p className="text-xs text-gray-400 mt-1">
          Vos dépenses apparaîtront ici.
        </p>
      </div>
    );
  }

  return (
    <div className="space-y-3">
      {expenses.map((expense) => {
        // Calcul des détails d'affichage pour cet item
        const categoryDisplay = getCategoryDisplay(expense.category);

        return (
          <div
            key={expense.id}
            className="flex flex-col sm:flex-row sm:items-center justify-between p-4 bg-white border border-gray-200 rounded-xl hover:shadow-sm transition-shadow gap-3"
          >
            <div className="flex-1 min-w-0">
              <div className="flex flex-wrap items-center gap-2 mb-2">
                <span
                  className={`px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-wider ${categoryDisplay.color}`}
                >
                  {categoryDisplay.label}
                </span>
                <div className="flex items-center text-gray-400 text-xs gap-1">
                  <CalendarIcon size={12} />
                  {new Date(expense.date).toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                  })}
                </div>
              </div>

              <h3 className="font-bold text-gray-900 truncate text-base">
                {expense.description}
              </h3>
            </div>

            <div className="flex items-center justify-between sm:justify-end gap-4 border-t sm:border-t-0 pt-3 sm:pt-0 border-gray-50">
              <div className="text-left sm:text-right">
                <p className="text-lg font-black text-gray-900">
                  {Number(expense.amount).toFixed(2)} $
                </p>
              </div>

              <div className="flex gap-1">
                <button
                  onClick={() => onEdit(expense)}
                  className="p-2.5 text-blue-600 bg-blue-50 sm:bg-transparent hover:bg-blue-100 rounded-lg transition-colors"
                  title="Modifier"
                >
                  <Edit2 size={18} />
                </button>
                <button
                  onClick={() => onDelete(expense)}
                  className="p-2.5 text-red-500 bg-red-50 sm:bg-transparent hover:bg-red-100 rounded-lg transition-colors"
                  title="Supprimer"
                >
                  <Trash2 size={18} />
                </button>
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
};
</file>

<file path="src/components/Expenses/ExpenseModal.tsx">
import { useState, useEffect } from 'react';
import { X } from 'lucide-react';
import { Expense, ExpenseCategory } from '../../hooks/useExpenses';
// 1. Import du hook des préférences
import { usePreferences } from '../../hooks/usePreferences';

interface ExpenseModalProps {
  isOpen: boolean;
  expense?: Expense;
  onClose: () => void;
  onSave: (
    expense: Omit<Expense, 'id' | 'user_id' | 'created_at' | 'updated_at'>
  ) => Promise<void>;
  loading: boolean;
}

// 2. Suppression de la constante 'categories' en dur

export const ExpenseModal = ({
  isOpen,
  expense,
  onClose,
  onSave,
  loading,
}: ExpenseModalProps) => {
  // 3. Récupération des préférences
  const { preferences } = usePreferences();

  const [formData, setFormData] = useState({
    description: '',
    amount: '',
    category: '' as ExpenseCategory, // Initialisation vide au départ
    date: new Date().toISOString().split('T')[0],
  });

  const [errors, setErrors] = useState<Record<string, string>>({});

  useEffect(() => {
    if (expense) {
      // Mode Édition : on utilise les données existantes
      setFormData({
        description: expense.description,
        amount: expense.amount.toString(),
        category: expense.category,
        date: expense.date,
      });
    } else {
      // Mode Création : on réinitialise
      // On essaie de prendre la première catégorie des préférences comme défaut
      const defaultCategory = preferences?.expense_categories?.[0]?.value || '';

      setFormData({
        description: '',
        amount: '',
        category: defaultCategory as ExpenseCategory,
        date: new Date().toISOString().split('T')[0],
      });
    }
    setErrors({});
  }, [expense, isOpen, preferences]); // Ajout de preferences aux dépendances

  const validateForm = () => {
    const newErrors: Record<string, string> = {};

    if (!formData.description.trim()) {
      newErrors.description = 'La description est requise';
    }

    if (!formData.amount || parseFloat(formData.amount) <= 0) {
      newErrors.amount = 'Le montant doit être supérieur à 0';
    }

    if (!formData.date) {
      newErrors.date = 'La date est requise';
    }

    if (!formData.category) {
      newErrors.category = 'La catégorie est requise';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!validateForm()) return;

    await onSave({
      description: formData.description.trim(),
      amount: parseFloat(formData.amount),
      category: formData.category,
      date: formData.date,
    });

    onClose();
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/60 flex items-end sm:items-center justify-center z-[100] p-0 sm:p-4">
      <div className="absolute inset-0" onClick={onClose} />

      <div className="relative bg-white w-full max-w-lg rounded-t-2xl sm:rounded-2xl shadow-xl overflow-hidden animate-in slide-in-from-bottom duration-300">
        <div className="flex items-center justify-between p-4 border-b border-gray-100 bg-white">
          <h2 className="text-lg font-bold text-gray-900">
            {expense ? 'Modifier la dépense' : 'Nouvelle dépense'}
          </h2>
          <button
            onClick={onClose}
            className="p-2 bg-gray-100 rounded-full text-gray-500 hover:text-gray-700 active:scale-90 transition-transform"
          >
            <X size={20} />
          </button>
        </div>

        <form onSubmit={handleSubmit} className="p-5 space-y-5 mb-4">
          <div>
            <label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">
              Description
            </label>
            <input
              type="text"
              value={formData.description}
              onChange={(e) =>
                setFormData({ ...formData, description: e.target.value })
              }
              placeholder="Ex: Peinture, Essence..."
              className={`w-full p-4 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-blue-500 text-base ${
                errors.description ? 'ring-2 ring-red-500' : ''
              }`}
            />
            {errors.description && (
              <p className="text-red-500 text-xs mt-1 ml-1 font-medium">
                {errors.description}
              </p>
            )}
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">
                Montant ($)
              </label>
              <input
                type="number"
                step="0.01"
                min="0"
                value={formData.amount}
                onChange={(e) =>
                  setFormData({ ...formData, amount: e.target.value })
                }
                placeholder="0.00"
                className={`w-full p-4 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-blue-500 text-lg font-bold ${
                  errors.amount ? 'ring-2 ring-red-500' : ''
                }`}
              />
              {errors.amount && (
                <p className="text-red-500 text-xs mt-1 ml-1 font-medium">
                  {errors.amount}
                </p>
              )}
            </div>

            <div>
              <label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">
                Date
              </label>
              <input
                type="date"
                value={formData.date}
                onChange={(e) =>
                  setFormData({ ...formData, date: e.target.value })
                }
                className={`w-full p-4 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-blue-500 text-base ${
                  errors.date ? 'ring-2 ring-red-500' : ''
                }`}
              />
              {errors.date && (
                <p className="text-red-500 text-xs mt-1 ml-1 font-medium">
                  {errors.date}
                </p>
              )}
            </div>
          </div>

          <div>
            <label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">
              Catégorie
            </label>
            <select
              value={formData.category}
              onChange={(e) =>
                setFormData({
                  ...formData,
                  category: e.target.value as ExpenseCategory,
                })
              }
              className={`w-full p-4 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-blue-500 text-base appearance-none ${
                errors.category ? 'ring-2 ring-red-500' : ''
              }`}
            >
              <option value="" disabled>
                Sélectionner une catégorie
              </option>
              {/* 4. Mapping dynamique des catégories depuis les préférences */}
              {preferences?.expense_categories.map((cat) => (
                <option key={cat.value} value={cat.value}>
                  {cat.label}
                </option>
              ))}
            </select>
            {errors.category && (
              <p className="text-red-500 text-xs mt-1 ml-1 font-medium">
                {errors.category}
              </p>
            )}
          </div>

          <div className="flex gap-3 pt-4">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 py-4 border border-gray-200 rounded-xl text-gray-600 font-bold hover:bg-gray-50 active:scale-95 transition-transform"
            >
              Annuler
            </button>
            <button
              type="submit"
              disabled={loading}
              className="flex-1 py-4 bg-blue-600 text-white rounded-xl font-bold text-lg shadow-lg shadow-blue-100 active:scale-95 transition-transform disabled:opacity-50"
            >
              {loading ? 'En cours...' : 'Enregistrer'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};
</file>

<file path="src/components/Expenses/Expenses.tsx">
import { useState } from 'react';
import { Plus, Menu, Search, AlertTriangle, X } from 'lucide-react';
import { useExpenses, Expense, ExpenseCategory } from '../../hooks/useExpenses';
import { usePreferences } from '../../hooks/usePreferences';
import { ShowToastFunction } from '../../types/toast';
import { ExpenseList } from './ExpenseList';
import { ExpenseModal } from './ExpenseModal';

interface ExpensesProps {
  onMenuToggle: () => void;
  showToast: ShowToastFunction; // 🆕 AJOUTE CECI
}

export const Expenses = ({ onMenuToggle, showToast }: ExpensesProps) => {
  const {
    expenses,
    loading,
    error,
    addExpense,
    updateExpense,
    deleteExpense,
    getTotalExpenses,
    getExpensesByCategory,
  } = useExpenses();

  const { preferences } = usePreferences();

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedExpense, setSelectedExpense] = useState<Expense | undefined>();
  const [deletingExpense, setDeletingExpense] = useState<Expense | null>(null); // 🆕
  const [selectedCategory, setSelectedCategory] =
    useState<ExpenseCategory | null>(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [isSaving, setIsSaving] = useState(false);

  const getCategoryLabel = (categoryValue: string) => {
    const category = preferences?.expense_categories.find(
      (c) => c.value === categoryValue
    );
    return category ? category.label : categoryValue || 'Autre';
  };

  const filteredExpenses = expenses.filter((exp) => {
    const matchesCategory =
      !selectedCategory || exp.category === selectedCategory;
    const matchesSearch = exp.description
      .toLowerCase()
      .includes(searchTerm.toLowerCase());
    return matchesCategory && matchesSearch;
  });

  const expensesByCategory = getExpensesByCategory();

  const handleOpenModal = (expense?: Expense) => {
    setSelectedExpense(expense);
    setIsModalOpen(true);
  };

  const handleCloseModal = () => {
    setIsModalOpen(false);
    setSelectedExpense(undefined);
  };

  const handleSave = async (
    expenseData: Omit<Expense, 'id' | 'user_id' | 'created_at' | 'updated_at'>
  ) => {
    setIsSaving(true);
    try {
      if (selectedExpense) {
        const success = await updateExpense(selectedExpense.id, expenseData);
        if (success) {
          showToast(
            'success',
            `Dépense "${expenseData.description}" modifiée ! 🎉`
          );
          handleCloseModal();
        } else {
          showToast('error', 'Erreur lors de la modification de la dépense');
        }
      } else {
        const success = await addExpense(expenseData);
        if (success) {
          showToast(
            'success',
            `Dépense "${expenseData.description}" ajoutée ! ✨`
          );
          handleCloseModal();
        } else {
          showToast('error', "Erreur lors de l'ajout de la dépense");
        }
      }
    } finally {
      setIsSaving(false);
    }
  };

  const handleDeleteClick = (expense: Expense) => {
    setDeletingExpense(expense);
  };

  const confirmDelete = async () => {
    if (deletingExpense) {
      const success = await deleteExpense(deletingExpense.id);
      if (success) {
        showToast(
          'warning',
          `Dépense "${deletingExpense.description}" supprimée 🗑️`,
          3500
        );
        setDeletingExpense(null);
      } else {
        showToast('error', 'Erreur lors de la suppression de la dépense');
      }
    }
  };

  const cancelDelete = () => {
    setDeletingExpense(null);
  };

  return (
    <div className="flex-1 overflow-auto">
      {/* Mobile Header */}
      <div className="lg:hidden bg-white shadow-sm border-b border-gray-200 px-4 py-4 flex items-center justify-between sticky top-0 z-30">
        <button
          onClick={onMenuToggle}
          className="p-3 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 active:bg-gray-200 transition-colors"
        >
          <Menu className="h-6 w-6" />
        </button>
        <h1 className="text-xl font-semibold text-gray-900">Dépenses</h1>
        <div className="w-12"></div>
      </div>

      <div className="p-4 md:p-6 space-y-6">
        {/* Header */}
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div className="flex items-center gap-4">
            <button
              onClick={onMenuToggle}
              className="hidden lg:flex p-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-colors"
            >
              <Menu className="h-6 w-6" />
            </button>
            <div>
              <h1 className="text-2xl sm:text-3xl font-bold text-gray-900 hidden lg:block">
                Dépenses
              </h1>
              <p className="text-gray-600 lg:hidden">
                Gérez vos dépenses professionnelles
              </p>
            </div>
          </div>
          <button
            onClick={() => handleOpenModal()}
            className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors w-full sm:w-auto justify-center touch-manipulation font-medium"
          >
            <Plus className="w-4 h-4" />
            Ajouter une dépense
          </button>
        </div>

        {/* Search */}
        <div className="relative">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
          <input
            type="text"
            placeholder="Rechercher des dépenses..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full pl-10 pr-4 py-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base touch-manipulation"
          />
        </div>

        {error && (
          <div className="p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
            {error}
          </div>
        )}

        {/* Stats Cards */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
          <div className="bg-white rounded-lg shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow">
            <p className="text-sm text-gray-600 font-medium">
              Dépenses totales
            </p>
            <p className="text-3xl font-bold text-gray-900 mt-2">
              ${getTotalExpenses().toFixed(2)}
            </p>
          </div>

          {Object.entries(expensesByCategory).map(
            ([category, amount]) =>
              amount > 0 && (
                <button
                  key={category}
                  onClick={() =>
                    setSelectedCategory(
                      selectedCategory === (category as ExpenseCategory)
                        ? null
                        : (category as ExpenseCategory)
                    )
                  }
                  className={`bg-white rounded-lg shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow text-left ${
                    selectedCategory === category ? 'ring-2 ring-blue-500' : ''
                  }`}
                >
                  <p className="text-sm text-gray-600 font-medium">
                    {getCategoryLabel(category)}
                  </p>
                  <p className="text-2xl sm:text-3xl font-bold text-gray-900 mt-2">
                    ${Number(amount).toFixed(2)}
                  </p>
                </button>
              )
          )}
        </div>

        {/* Expense List Section */}
        <div className="bg-white rounded-lg shadow-md p-4 sm:p-6">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-semibold text-gray-900">
              {selectedCategory
                ? `${getCategoryLabel(selectedCategory)} (${
                    filteredExpenses.length
                  })`
                : `Toutes les dépenses (${filteredExpenses.length})`}
            </h2>
            {selectedCategory && (
              <button
                onClick={() => setSelectedCategory(null)}
                className="text-sm text-blue-600 hover:text-blue-700 font-medium"
              >
                ← Toutes
              </button>
            )}
          </div>

          <ExpenseList
            expenses={filteredExpenses}
            loading={loading}
            onEdit={handleOpenModal}
            onDelete={handleDeleteClick} // 🆕 Passe handleDeleteClick au lieu de handleDelete
          />
        </div>

        {filteredExpenses.length === 0 && !loading && (
          <div className="text-center py-8 sm:py-12">
            <div className="text-gray-400 mb-4">
              <Search className="w-12 h-12 mx-auto" />
            </div>
            <h3 className="text-lg font-medium text-gray-900 mb-2">
              Aucune dépense trouvée
            </h3>
            <p className="text-gray-600 mb-4">
              {searchTerm
                ? "Essayez d'ajuster vos termes de recherche"
                : 'Commencez par ajouter votre première dépense'}
            </p>
            {!searchTerm && (
              <button
                onClick={() => handleOpenModal()}
                className="inline-flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors touch-manipulation font-medium"
              >
                <Plus className="w-4 h-4" />
                Ajouter une dépense
              </button>
            )}
          </div>
        )}
      </div>

      <ExpenseModal
        isOpen={isModalOpen}
        expense={selectedExpense}
        onClose={handleCloseModal}
        onSave={handleSave}
        loading={isSaving}
      />

      {/* Delete Confirmation Modal avec Liquid Glass */}
      {deletingExpense && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-fadeIn">
          <div
            className="relative w-full max-w-md"
            style={{ animation: 'scaleIn 0.3s ease-out forwards' }}
          >
            {/* Background gradient rouge */}
            <div className="absolute inset-0 bg-gradient-to-br from-red-500 via-rose-600 to-pink-700 opacity-95 rounded-3xl" />

            {/* Glassmorphism layer */}
            <div className="absolute inset-0 backdrop-blur-xl bg-white/10 rounded-3xl" />

            {/* Bulles décoratives */}
            <div
              className="absolute -top-10 -left-10 w-40 h-40 bg-red-400/30 rounded-full blur-3xl animate-pulse"
              style={{ animationDuration: '3s' }}
            />
            <div
              className="absolute -bottom-10 -right-10 w-32 h-32 bg-pink-400/30 rounded-full blur-2xl animate-pulse"
              style={{ animationDuration: '4s', animationDelay: '1s' }}
            />

            {/* Content */}
            <div className="relative p-8">
              {/* Close button */}
              <button
                onClick={cancelDelete}
                className="absolute top-4 right-4 p-2 rounded-xl bg-white/15 backdrop-blur-md hover:bg-white/25 transition-all duration-300 border border-white/30 hover:scale-110 group"
              >
                <X className="w-5 h-5 text-white group-hover:rotate-90 transition-transform duration-300" />
              </button>

              {/* Icon */}
              <div className="flex justify-center mb-6">
                <div className="relative">
                  <div className="absolute inset-0 bg-white/30 rounded-full blur-xl" />
                  <div className="relative w-20 h-20 bg-white/20 backdrop-blur-lg rounded-full flex items-center justify-center border-2 border-white/40 shadow-2xl">
                    <AlertTriangle className="w-10 h-10 text-white drop-shadow-2xl animate-pulse" />
                  </div>
                </div>
              </div>

              {/* Title */}
              <h3 className="text-2xl font-bold text-white text-center mb-3 drop-shadow-lg">
                Supprimer la dépense ?
              </h3>

              {/* Message */}
              <div className="bg-white/15 backdrop-blur-md rounded-2xl p-5 mb-6 border border-white/30 shadow-xl">
                <p className="text-white/95 text-center leading-relaxed drop-shadow-md">
                  Voulez-vous vraiment supprimer la dépense{' '}
                  <span className="font-bold text-white">
                    "{deletingExpense.description}"
                  </span>{' '}
                  d'un montant de{' '}
                  <span className="font-semibold">
                    ${deletingExpense.amount.toFixed(2)}
                  </span>
                  ?
                </p>
                <p className="text-white/80 text-sm text-center mt-2 drop-shadow">
                  Cette action est irréversible.
                </p>
              </div>

              {/* Buttons */}
              <div className="flex gap-3">
                <button
                  onClick={cancelDelete}
                  className="flex-1 px-6 py-4 bg-white/20 backdrop-blur-lg hover:bg-white/30 text-white font-semibold rounded-xl transition-all duration-300 border border-white/40 hover:scale-105 shadow-lg"
                >
                  Annuler
                </button>
                <button
                  onClick={confirmDelete}
                  className="flex-1 px-6 py-4 bg-white/90 hover:bg-white text-red-600 font-bold rounded-xl transition-all duration-300 border border-white shadow-2xl hover:scale-105 hover:shadow-red-500/50"
                >
                  Supprimer
                </button>
              </div>
            </div>

            <style>{`
              @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
              }
              
              @keyframes scaleIn {
                from {
                  transform: scale(0.9);
                  opacity: 0;
                }
                to {
                  transform: scale(1);
                  opacity: 1;
                }
              }
            `}</style>
          </div>
        </div>
      )}
    </div>
  );
};
</file>

<file path="src/components/Layout/Sidebar.tsx">
import React from 'react';
import {
  Home,
  Calendar,
  Users,
  LogOut,
  X,
  Building,
  Bell,
  Settings,
  UserPlus,
  PlayCircle,
  BarChart3,
  CreditCard,
  Shield,
  Menu,
} from 'lucide-react';

interface SidebarProps {
  activeTab: string;
  onTabChange: (tab: string) => void;
  onLogout: () => void;
  userName: string;
  userRole: string;
  isOpen: boolean;
  onToggle: () => void;
}

const Sidebar: React.FC<SidebarProps> = ({
  activeTab,
  onTabChange,
  onLogout,
  userName,
  userRole,
  isOpen,
  onToggle,
}) => {
  const menuItems = [
    { id: 'dashboard', label: 'Tableau de bord', icon: Home },
    { id: 'myday', label: 'Ma journée', icon: PlayCircle },
    { id: 'calendar', label: 'Calendrier', icon: Calendar },
    { id: 'clients', label: 'Clients', icon: Users },
    { id: 'expenses', label: 'Dépenses', icon: CreditCard },
    { id: 'analytics', label: 'Analyse', icon: BarChart3 },
    { id: 'notifications', label: 'Notifications', icon: Bell },
    ...(userRole === 'admin'
      ? [
          { id: 'admin-payments', label: 'Paiements', icon: Shield },
          { id: 'users', label: 'Utilisateurs', icon: UserPlus },
          { id: 'settings', label: 'Paramètres', icon: Settings },
        ]
      : []),
  ];

  const handleViewChange = (view: string) => {
    onTabChange(view);
    if (window.innerWidth < 1024) onToggle();
  };

  return (
    <>
      {/* Overlay mobile avec blur */}
      {isOpen && (
        <div
          className="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 lg:hidden transition-all duration-300"
          onClick={onToggle}
        />
      )}

      {/* Sidebar Container */}
      <div
        className={`fixed left-0 top-0 h-full w-80 transform transition-all duration-500 ease-out z-50 lg:relative lg:translate-x-0 ${
          isOpen ? 'translate-x-0' : '-translate-x-full'
        }`}
      >
        {/* Background avec gradient bleu */}
        <div className="absolute inset-0 bg-gradient-to-br from-blue-500 via-blue-600 to-indigo-700" />

        {/* Layer glassmorphism */}
        <div className="absolute inset-0 backdrop-blur-xl bg-white/10" />

        {/* Effets liquid glass - bulles animées */}
        <div
          className="absolute top-20 -left-20 w-72 h-72 bg-blue-300/20 rounded-full blur-3xl animate-pulse"
          style={{ animationDuration: '4s' }}
        />
        <div
          className="absolute bottom-40 -right-10 w-56 h-56 bg-indigo-300/20 rounded-full blur-3xl animate-pulse"
          style={{ animationDuration: '5s', animationDelay: '1s' }}
        />
        <div
          className="absolute top-1/2 left-1/2 w-40 h-40 bg-purple-300/15 rounded-full blur-2xl animate-pulse"
          style={{ animationDuration: '6s', animationDelay: '2s' }}
        />

        <div className="relative flex flex-col h-full">
          {/* Header avec logo */}
          <div className="flex items-center justify-between p-6 pb-8">
            <div className="flex items-center gap-3">
              {/* Logo avec effet glass */}
              <div className="relative">
                <div className="absolute inset-0 bg-white/30 rounded-2xl blur-md" />
                <div className="relative w-12 h-12 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center shadow-xl border border-white/40">
                  <Building className="w-7 h-7 text-white drop-shadow-lg" />
                </div>
              </div>
              <div>
                <h1 className="text-xl font-bold text-white drop-shadow-lg tracking-tight">
                  Outils Internes
                </h1>
                <p className="text-xs text-white/70 drop-shadow">
                  Gestion professionnelle
                </p>
              </div>
            </div>

            {/* Bouton fermer mobile */}
            <button
              onClick={onToggle}
              className="lg:hidden p-2.5 rounded-xl bg-white/15 backdrop-blur-md hover:bg-white/25 transition-all duration-300 border border-white/30 shadow-lg hover:scale-110"
            >
              <X className="w-5 h-5 text-white" />
            </button>
          </div>

          {/* Navigation */}
          <nav className="flex-1 px-4 overflow-y-auto scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent">
            <ul className="space-y-1.5 pb-4">
              {menuItems.map((item, index) => {
                const isActive = activeTab === item.id;
                return (
                  <li
                    key={item.id}
                    style={{
                      animationDelay: `${index * 50}ms`,
                      animation: 'slideIn 0.4s ease-out forwards',
                    }}
                  >
                    <button
                      onClick={() => handleViewChange(item.id)}
                      className={`group w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-left transition-all duration-300 ${
                        isActive
                          ? 'bg-white/30 backdrop-blur-lg text-white font-semibold shadow-2xl border border-white/50 scale-[1.02]'
                          : 'text-white/85 hover:bg-white/15 hover:backdrop-blur-md hover:scale-[1.02] border border-transparent hover:border-white/30 hover:shadow-lg'
                      }`}
                    >
                      {/* Icône avec effet glow */}
                      <div
                        className={`relative ${
                          isActive ? 'scale-110' : 'group-hover:scale-110'
                        } transition-transform duration-300`}
                      >
                        {isActive && (
                          <div className="absolute inset-0 bg-white/40 rounded-lg blur-md" />
                        )}
                        <item.icon
                          className={`relative w-5 h-5 ${
                            isActive
                              ? 'drop-shadow-[0_0_8px_rgba(255,255,255,0.8)]'
                              : ''
                          }`}
                        />
                      </div>

                      <span
                        className={`drop-shadow-md text-[15px] ${
                          isActive ? 'tracking-wide' : ''
                        }`}
                      >
                        {item.label}
                      </span>

                      {/* Indicateur actif */}
                      {isActive && (
                        <div className="ml-auto w-2 h-2 bg-white rounded-full shadow-lg animate-pulse" />
                      )}
                    </button>
                  </li>
                );
              })}
            </ul>
          </nav>

          {/* Footer avec info utilisateur */}
          <div className="p-4 mt-auto space-y-3">
            {/* Card utilisateur */}
            <div className="relative group">
              <div className="absolute inset-0 bg-white/20 rounded-2xl blur-md" />
              <div className="relative px-5 py-4 bg-white/15 backdrop-blur-lg rounded-2xl border border-white/40 shadow-xl">
                <div className="flex items-center gap-3 mb-3">
                  <div className="w-10 h-10 bg-white/25 backdrop-blur-md rounded-full flex items-center justify-center border-2 border-white/50 shadow-lg">
                    <span className="text-white font-bold text-sm">
                      {userName.charAt(0).toUpperCase()}
                    </span>
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="text-xs text-white/70 mb-0.5 drop-shadow">
                      Connecté en tant que
                    </p>
                    <p className="text-sm font-semibold text-white truncate drop-shadow-md">
                      {userName}
                    </p>
                  </div>
                </div>

                {/* Badge rôle */}
                <div className="flex justify-end">
                  <div className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-white/20 backdrop-blur-md rounded-full border border-white/40 shadow-lg">
                    <div className="w-1.5 h-1.5 bg-green-300 rounded-full animate-pulse shadow-[0_0_6px_rgba(134,239,172,0.8)]" />
                    <span className="text-xs text-white/95 font-medium drop-shadow">
                      {userRole === 'admin' ? 'Administrateur' : 'Utilisateur'}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            {/* Bouton déconnexion */}
            <button
              onClick={onLogout}
              className="w-full flex items-center justify-center gap-3 px-5 py-4 bg-red-500/25 backdrop-blur-lg hover:bg-red-500/35 rounded-2xl transition-all duration-300 border border-red-400/40 hover:border-red-400/60 hover:scale-[1.02] shadow-xl group"
            >
              <LogOut className="w-5 h-5 text-red-50 group-hover:rotate-12 transition-transform duration-300 drop-shadow-lg" />
              <span className="font-semibold text-red-50 drop-shadow-md text-[15px]">
                Déconnexion
              </span>
            </button>
          </div>
        </div>
      </div>

      <style>{`
        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateX(-20px);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }
        
        .scrollbar-thin::-webkit-scrollbar {
          width: 6px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
          background: transparent;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
          background: rgba(255, 255, 255, 0.2);
          border-radius: 10px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
          background: rgba(255, 255, 255, 0.3);
        }
      `}</style>
    </>
  );
};

export default Sidebar;
</file>

<file path="src/components/MyDay/MyDay.tsx">
import React, { useState, useMemo } from 'react';
import {
  Calendar,
  Clock,
  MapPin,
  CheckCircle,
  X,
  RotateCcw,
  Menu,
  DollarSign,
  User,
  AlertCircle,
} from 'lucide-react';
import { Appointment, Client } from '../../types';

interface MyDayProps {
  appointments: Appointment[];
  clients: Client[];
  onMenuToggle: () => void;
  onUpdateAppointment: (
    id: string,
    data: Partial<Appointment>
  ) => Promise<boolean>;
}

const MyDay: React.FC<MyDayProps> = ({
  appointments,
  clients,
  onMenuToggle,
  onUpdateAppointment,
}) => {
  const [updatingIds, setUpdatingIds] = useState<Set<string>>(new Set());

  const todayStr = new Date().toLocaleDateString('en-CA');

  const todayAppointments = useMemo(() => {
    return appointments
      .filter((apt) => apt.date === todayStr)
      .sort((a, b) => a.time.localeCompare(b.time));
  }, [appointments, todayStr]);

  const stats = useMemo(() => {
    const total = todayAppointments.length;
    const completed = todayAppointments.filter(
      (a) => a.status === 'completed'
    ).length;
    const revenue = todayAppointments
      .filter((a) => a.status === 'completed')
      .reduce((sum, a) => sum + (a.price || 0), 0);
    const remaining = todayAppointments.filter(
      (a) => a.status === 'scheduled'
    ).length;

    return { total, completed, revenue, remaining };
  }, [todayAppointments]);

  const getClientAddress = (clientId: string) =>
    clients.find((c) => c.id === clientId)?.address || '';

  const openMaps = (clientId: string) => {
    const address = getClientAddress(clientId);
    if (!address) return alert("Pas d'adresse enregistrée.");

    const encodedAddress = encodeURIComponent(address);
    const isApple = /iPhone|iPad|iPod|Macintosh/i.test(navigator.userAgent);

    if (isApple) {
      window.location.href = `maps://maps.apple.com/?q=${encodedAddress}`;
    } else {
      window.open(
        `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`,
        '_blank'
      );
    }
  };

  const updateStatus = async (
    id: string,
    status: 'completed' | 'cancelled' | 'scheduled'
  ) => {
    setUpdatingIds((prev) => new Set(prev).add(id));
    try {
      await onUpdateAppointment(id, { status });
    } catch (err) {
      alert('Erreur lors de la mise à jour');
    } finally {
      setUpdatingIds((prev) => {
        const next = new Set(prev);
        next.delete(id);
        return next;
      });
    }
  };

  const formatTime = (time: string) => time.slice(0, 5);

  const formatDate = () => {
    return new Date().toLocaleDateString('fr-FR', {
      weekday: 'long',
      day: 'numeric',
      month: 'long',
    });
  };

  return (
    <div className="flex-1 overflow-auto">
      {/* Mobile Header */}
      <div className="lg:hidden bg-white shadow-sm border-b border-gray-200 px-4 py-4 flex items-center justify-between sticky top-0 z-30">
        <button
          onClick={onMenuToggle}
          className="p-3 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 active:bg-gray-200 transition-colors"
        >
          <Menu className="h-6 w-6" />
        </button>
        <h1 className="text-xl font-semibold text-gray-900">Ma journée</h1>
        <div className="w-12"></div>
      </div>

      <div className="p-4 md:p-6 space-y-6">
        {/* Header */}
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div className="flex items-center gap-4">
            <button
              onClick={onMenuToggle}
              className="hidden lg:flex p-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-colors"
            >
              <Menu className="h-6 w-6" />
            </button>
            <div>
              <h1 className="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center gap-2 hidden lg:flex">
                <Calendar className="w-8 h-8 text-blue-600" />
                Ma journée
              </h1>
              <p className="text-gray-600 capitalize lg:hidden">
                {formatDate()}
              </p>
              <p className="text-gray-600 capitalize hidden lg:block">
                {formatDate()}
              </p>
            </div>
          </div>
        </div>

        {/* Stats Cards */}
        <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
          {/* Revenus */}
          <div className="bg-white rounded-lg shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow">
            <div className="flex items-center justify-between mb-2">
              <p className="text-sm text-gray-600 font-medium">Revenus</p>
              <div className="p-2 bg-green-100 rounded-lg">
                <DollarSign className="w-4 h-4 text-green-600" />
              </div>
            </div>
            <p className="text-2xl sm:text-3xl font-bold text-gray-900">
              ${stats.revenue.toFixed(2)}
            </p>
            <p className="text-xs text-gray-500 mt-1">Aujourd'hui</p>
          </div>

          {/* À faire */}
          <div className="bg-white rounded-lg shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow">
            <div className="flex items-center justify-between mb-2">
              <p className="text-sm text-gray-600 font-medium">À faire</p>
              <div className="p-2 bg-blue-100 rounded-lg">
                <Clock className="w-4 h-4 text-blue-600" />
              </div>
            </div>
            <p className="text-2xl sm:text-3xl font-bold text-blue-600">
              {stats.remaining}
            </p>
            <p className="text-xs text-gray-500 mt-1">Restants</p>
          </div>

          {/* Complétés */}
          <div className="bg-white rounded-lg shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow">
            <div className="flex items-center justify-between mb-2">
              <p className="text-sm text-gray-600 font-medium">Complétés</p>
              <div className="p-2 bg-green-100 rounded-lg">
                <CheckCircle className="w-4 h-4 text-green-600" />
              </div>
            </div>
            <p className="text-2xl sm:text-3xl font-bold text-green-600">
              {stats.completed}
            </p>
            <p className="text-xs text-gray-500 mt-1">Terminés</p>
          </div>

          {/* Total */}
          <div className="bg-white rounded-lg shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow">
            <div className="flex items-center justify-between mb-2">
              <p className="text-sm text-gray-600 font-medium">Total</p>
              <div className="p-2 bg-gray-100 rounded-lg">
                <User className="w-4 h-4 text-gray-600" />
              </div>
            </div>
            <p className="text-2xl sm:text-3xl font-bold text-gray-900">
              {stats.total}
            </p>
            <p className="text-xs text-gray-500 mt-1">Rendez-vous</p>
          </div>
        </div>

        {/* Appointments List */}
        <div className="space-y-4">
          <h2 className="text-lg font-semibold text-gray-900">
            Agenda du jour
          </h2>

          {todayAppointments.length === 0 ? (
            <div className="bg-white rounded-lg shadow-md p-8 sm:p-12 text-center">
              <div className="bg-gray-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <CheckCircle className="w-8 h-8 text-gray-400" />
              </div>
              <h3 className="text-lg font-semibold text-gray-900">
                Tout est calme
              </h3>
              <p className="text-gray-600 text-sm mt-1">
                Aucun rendez-vous prévu pour aujourd'hui.
              </p>
            </div>
          ) : (
            <div className="space-y-4">
              {todayAppointments.map((apt) => (
                <div
                  key={apt.id}
                  className={`bg-white rounded-lg shadow-md overflow-hidden transition-shadow hover:shadow-lg ${
                    apt.status === 'completed' ? 'opacity-75' : ''
                  }`}
                >
                  {/* Header */}
                  <div className="p-4 sm:p-6 border-b border-gray-100">
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <Clock className="w-4 h-4 text-gray-400" />
                          <span className="text-lg font-bold text-gray-900">
                            {formatTime(apt.time)}
                          </span>
                          {apt.duration && (
                            <span className="text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded">
                              {apt.duration} min
                            </span>
                          )}
                        </div>
                        <h3 className="text-lg font-semibold text-gray-900">
                          {apt.clientName}
                        </h3>
                        {apt.service && (
                          <p className="text-sm text-gray-600 mt-1">
                            {apt.service}
                          </p>
                        )}
                      </div>
                      <div
                        className={`px-3 py-1 rounded-lg text-xs font-bold uppercase ${
                          apt.status === 'completed'
                            ? 'bg-green-100 text-green-700'
                            : apt.status === 'cancelled'
                            ? 'bg-red-100 text-red-700'
                            : 'bg-blue-100 text-blue-700'
                        }`}
                      >
                        {apt.status === 'completed'
                          ? 'Fait'
                          : apt.status === 'cancelled'
                          ? 'Annulé'
                          : 'Prévu'}
                      </div>
                    </div>

                    {apt.notes && (
                      <div className="mt-3 p-3 bg-yellow-50 border border-yellow-100 rounded-lg flex gap-2 items-start">
                        <AlertCircle className="w-4 h-4 text-yellow-600 flex-shrink-0 mt-0.5" />
                        <span className="text-sm text-gray-700 italic">
                          {apt.notes}
                        </span>
                      </div>
                    )}
                  </div>

                  {/* Actions */}
                  <div className="p-4 sm:p-6 bg-gray-50">
                    <div className="flex flex-col sm:flex-row gap-2">
                      <button
                        onClick={() => openMaps(apt.clientId)}
                        className="flex-1 flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 active:bg-gray-200 py-3 rounded-lg font-medium transition-colors touch-manipulation"
                      >
                        <MapPin className="w-4 h-4" />
                        <span>Ouvrir GPS</span>
                      </button>

                      {apt.status === 'scheduled' ? (
                        <>
                          <button
                            onClick={() => updateStatus(apt.id, 'completed')}
                            disabled={updatingIds.has(apt.id)}
                            className="flex-1 flex items-center justify-center gap-2 bg-green-600 text-white hover:bg-green-700 active:bg-green-800 py-3 rounded-lg font-medium transition-colors touch-manipulation disabled:opacity-50"
                          >
                            <CheckCircle className="w-4 h-4" />
                            <span>Terminer</span>
                          </button>
                          <button
                            onClick={() => updateStatus(apt.id, 'cancelled')}
                            disabled={updatingIds.has(apt.id)}
                            className="px-4 py-3 bg-white border border-red-200 text-red-600 hover:bg-red-50 active:bg-red-100 rounded-lg transition-colors touch-manipulation disabled:opacity-50"
                          >
                            <X className="w-5 h-5" />
                          </button>
                        </>
                      ) : (
                        <button
                          onClick={() => updateStatus(apt.id, 'scheduled')}
                          disabled={updatingIds.has(apt.id)}
                          className="flex-1 flex items-center justify-center gap-2 bg-gray-600 text-white hover:bg-gray-700 active:bg-gray-800 py-3 rounded-lg font-medium transition-colors touch-manipulation disabled:opacity-50"
                        >
                          <RotateCcw className="w-4 h-4" />
                          <span>Réactiver</span>
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default MyDay;
</file>

<file path="src/components/Notifications/Notifications.tsx">
import React, { useState, useEffect } from 'react';
import {
  Bell,
  Calendar,
  AlertCircle,
  Check,
  Menu,
  ChevronDown,
  ChevronUp,
  Trash2,
  X,
  Clock,
  Phone,
  User,
  Loader2
} from 'lucide-react';
import { Appointment, Client, Service } from '../../types';
import { ShowToastFunction } from '../../types/toast';
import { supabase } from '../../lib/supabase';
import AppointmentModal from '../Calendar/AppointmentModal';

interface NotificationsProps {
  appointments: Appointment[];
  clients: Client[];
  onAddAppointment: (appointment: Omit<Appointment, 'id'>) => Promise<boolean>;
  showToast: ShowToastFunction;
  onMenuToggle: () => void;
}

interface Notification {
  id: string;
  type: 'upcoming_appointment' | 'missing_appointment' | 'frequency_reminder';
  title: string;
  message: string;
  date: string;
  priority: 'high' | 'medium' | 'low';
  completed: boolean;
  completed_at?: string;
  client_id?: string;
  client_name?: string;
}

const Notifications: React.FC<NotificationsProps> = ({
  appointments,
  clients,
  onAddAppointment,
  showToast,
  onMenuToggle,
}) => {
  // --- ÉTATS ---
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [loading, setLoading] = useState(true);
  const [showArchived, setShowArchived] = useState(false);
  
  // États pour les Modals
  const [services, setServices] = useState<Service[]>([]);
  const [deletingNotification, setDeletingNotification] = useState<Notification | null>(null);
  
  // État pour la réservation (Booking)
  const [showBookingModal, setShowBookingModal] = useState(false);
  const [clientForBooking, setClientForBooking] = useState<Client | undefined>(undefined);
  const [bookingNotificationId, setBookingNotificationId] = useState<string | null>(null);
  
  // État pour l'appel (Calling)
  const [clientForCall, setClientForCall] = useState<Client | null>(null);

  // --- CHARGEMENT ---
  useEffect(() => {
    let mounted = true;

    const initData = async () => {
      setLoading(true);
      
      // 1. Services
      const { data: servicesData } = await supabase.from('services').select('*');
      if (mounted && servicesData) setServices(servicesData);

      // 2. Notifications
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        // Nettoyage silencieux des vieilles notifs (>3h)
        const threeHoursAgo = new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString();
        await supabase
          .from('notifications')
          .delete()
          .eq('user_id', user.id)
          .eq('completed', true)
          .lt('completed_at', threeHoursAgo);

        // Chargement des notifs
        const { data: notifsData } = await supabase
          .from('notifications')
          .select('*')
          .eq('user_id', user.id)
          .order('date', { ascending: false });
          
        if (mounted && notifsData) setNotifications(notifsData);
      }
      
      if (mounted) setLoading(false);
    };

    initData();

    return () => { mounted = false; };
  }, []);

  // --- ACTIONS ---

  const handleToggleComplete = async (notificationId: string, currentStatus: boolean) => {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const newCompletedState = !currentStatus;

    // Mise à jour optimiste
    setNotifications((prev) =>
      prev.map((n) =>
        n.id === notificationId
          ? {
              ...n,
              completed: newCompletedState,
              completed_at: newCompletedState ? new Date().toISOString() : undefined,
            }
          : n
      )
    );

    // Mise à jour DB
    await supabase
      .from('notifications')
      .update({
        completed: newCompletedState,
        completed_at: newCompletedState ? new Date().toISOString() : null,
      })
      .eq('id', notificationId)
      .eq('user_id', user.id);

    if (newCompletedState) {
      showToast('success', 'Notification traitée (suppression dans 3h)', 2000);
    }
  };

  const confirmDelete = async () => {
    if (!deletingNotification) return;
    
    setNotifications((prev) => prev.filter((n) => n.id !== deletingNotification.id));
    setDeletingNotification(null);
    showToast('warning', 'Notification supprimée', 2000);

    const { error } = await supabase
      .from('notifications')
      .delete()
      .eq('id', deletingNotification.id);

    if (error) console.error("Erreur suppression", error);
  };

  // --- ACTIONS BOUTONS ---

  const handleOpenCall = (clientId?: string) => {
    if (!clientId) return;
    const client = clients.find(c => c.id === clientId);
    if (client) setClientForCall(client);
  };

  const handleOpenBooking = (clientId?: string, notificationId?: string) => {
    if (!clientId) return;
    const client = clients.find(c => c.id === clientId);
    if (client) {
      setClientForBooking(client);
      setBookingNotificationId(notificationId || null);
      setShowBookingModal(true);
    }
  };

  const handleSaveAppointment = async (appointmentData: Omit<Appointment, 'id'>) => {
    const success = await onAddAppointment(appointmentData);
    if (success) {
      showToast('success', 'Rendez-vous créé ! 📅');
      setShowBookingModal(false);
      setClientForBooking(undefined);
      
      // Fermeture auto de la notif liée
      if (bookingNotificationId) {
        handleToggleComplete(bookingNotificationId, false);
        setBookingNotificationId(null);
      }
    } else {
      showToast('error', 'Erreur lors de la création');
    }
  };

  // --- UI HELPERS ---

  const getIcon = (type: string) => {
    switch (type) {
      case 'upcoming_appointment': return <Calendar className="w-5 h-5" />;
      case 'missing_appointment': return <AlertCircle className="w-5 h-5" />;
      case 'frequency_reminder': return <Clock className="w-5 h-5" />;
      default: return <Bell className="w-5 h-5" />;
    }
  };

  const getPriorityStyles = (priority: string) => {
    switch (priority) {
      case 'high': return 'bg-red-50 border-red-100 text-red-900';
      case 'medium': return 'bg-orange-50 border-orange-100 text-orange-900';
      case 'low': return 'bg-blue-50 border-blue-100 text-blue-900';
      default: return 'bg-gray-50 border-gray-200 text-gray-900';
    }
  };

  const activeNotifications = notifications.filter((n) => !n.completed);
  const archivedNotifications = notifications.filter((n) => n.completed);

  return (
    <div className="flex-1 overflow-auto bg-gray-50/50">
      {/* Mobile Header */}
      <div className="lg:hidden bg-white shadow-sm border-b border-gray-200 px-4 py-4 flex items-center justify-between sticky top-0 z-30">
        <button onClick={onMenuToggle} className="p-3 rounded-lg text-gray-600 hover:bg-gray-100">
          <Menu className="h-6 w-6" />
        </button>
        <h1 className="text-xl font-semibold text-gray-900">Notifications</h1>
        <div className="w-12"></div>
      </div>

      <div className="p-4 md:p-6 max-w-4xl mx-auto space-y-6">
        {/* En-tête */}
        <div className="flex items-center gap-3">
          <h1 className="text-2xl font-bold text-gray-900 hidden lg:block">Notifications</h1>
          {!loading && activeNotifications.length > 0 && (
            <span className="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full font-bold">
              {activeNotifications.length}
            </span>
          )}
        </div>

        {/* LISTE ACTIVE */}
        <div className="space-y-4">
          {loading ? (
            // Skeleton Loader
            [1, 2].map(i => (
              <div key={i} className="bg-white rounded-xl p-6 border border-gray-100 shadow-sm animate-pulse">
                <div className="flex gap-4">
                  <div className="w-10 h-10 bg-gray-100 rounded-full"></div>
                  <div className="flex-1 space-y-3">
                    <div className="h-4 bg-gray-100 rounded w-1/4"></div>
                    <div className="h-3 bg-gray-100 rounded w-3/4"></div>
                  </div>
                </div>
              </div>
            ))
          ) : activeNotifications.length === 0 ? (
            <div className="text-center py-12 bg-white rounded-2xl shadow-sm border border-gray-200">
              <div className="bg-green-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                <Check className="w-8 h-8 text-green-600" />
              </div>
              <h3 className="text-lg font-bold text-gray-900">Vous êtes à jour !</h3>
              <p className="text-gray-500 text-sm">Aucune notification en attente.</p>
            </div>
          ) : (
            <div className="space-y-3">
              {activeNotifications.map((notif) => (
                <div
                  key={notif.id}
                  className={`relative rounded-xl border shadow-sm transition-all hover:shadow-md overflow-hidden ${getPriorityStyles(notif.priority)}`}
                >
                  <div className="p-4 sm:p-5 flex flex-col md:flex-row gap-4">
                    
                    {/* Icône & Texte */}
                    <div className="flex gap-4 flex-1">
                      <div className="flex-shrink-0 mt-1">
                        <div className="p-2.5 bg-white/80 backdrop-blur-sm rounded-xl shadow-sm">
                          {getIcon(notif.type)}
                        </div>
                      </div>
                      <div className="min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                          <h3 className="font-bold text-gray-900 text-base leading-tight">
                            {notif.title}
                          </h3>
                          {notif.priority === 'high' && (
                            <span className="w-2 h-2 bg-red-500 rounded-full animate-pulse" title="Urgent" />
                          )}
                        </div>
                        <p className="text-sm text-gray-800 opacity-90 leading-relaxed">{notif.message}</p>
                        <p className="text-xs text-gray-500 mt-2 flex items-center gap-1">
                          <Clock className="w-3 h-3" />
                          {new Date(notif.date).toLocaleDateString('fr-FR', {
                            weekday: 'long', day: 'numeric', month: 'long'
                          })}
                        </p>
                      </div>
                    </div>

                    {/* Boutons d'action */}
                    <div className="flex items-center md:flex-col gap-2 shrink-0 md:border-l md:border-black/5 md:pl-4 pt-2 md:pt-0 border-t border-black/5 md:border-t-0">
                      {notif.client_id && (
                        <button
                          onClick={() => handleOpenCall(notif.client_id)}
                          className="flex-1 md:w-full flex items-center justify-center gap-2 px-3 py-2 bg-white hover:bg-gray-50 text-xs font-bold text-gray-700 rounded-lg transition-colors border border-gray-200/50 shadow-sm"
                        >
                          <Phone className="w-3.5 h-3.5" />
                          <span className="hidden sm:inline">Appeler</span>
                        </button>
                      )}

                      {notif.client_id && (
                        <button
                          onClick={() => handleOpenBooking(notif.client_id, notif.id)}
                          className="flex-1 md:w-full flex items-center justify-center gap-2 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-xs font-bold text-white rounded-lg transition-colors shadow-sm"
                        >
                          <Calendar className="w-3.5 h-3.5" />
                          <span className="hidden sm:inline">Réserver</span>
                        </button>
                      )}

                      <button
                        onClick={() => handleToggleComplete(notif.id, notif.completed)}
                        className="flex-1 md:w-full flex items-center justify-center gap-2 px-3 py-2 bg-green-600 hover:bg-green-700 text-xs font-bold text-white rounded-lg transition-colors shadow-sm"
                      >
                        <Check className="w-3.5 h-3.5" />
                        <span className="hidden sm:inline">Fait</span>
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* LISTE ARCHIVÉE */}
        {archivedNotifications.length > 0 && (
          <div className="pt-6 border-t border-gray-200">
            <button
              onClick={() => setShowArchived(!showArchived)}
              className="flex items-center gap-2 text-xs font-bold text-gray-400 hover:text-gray-600 transition-colors uppercase tracking-wide mb-4"
            >
              {showArchived ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
              Historique récent ({archivedNotifications.length})
            </button>

            {showArchived && (
              <div className="space-y-3 opacity-75">
                {archivedNotifications.map((notif) => (
                  <div key={notif.id} className="bg-white rounded-lg p-3 border border-gray-200 flex items-center justify-between shadow-sm">
                    <div className="flex items-center gap-3 overflow-hidden">
                      <div className="p-1.5 bg-gray-100 rounded-full text-gray-400 shrink-0">
                        {getIcon(notif.type)}
                      </div>
                      <div className="min-w-0 flex-1">
                        <div className="flex items-center gap-2 flex-wrap">
                          <p className="text-sm font-medium text-gray-600 line-through">
                            {notif.title}
                          </p>
                          {notif.client_name && (
                            <span className="flex items-center gap-1 text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full border border-blue-100">
                              <User className="w-3 h-3" />
                              {notif.client_name}
                            </span>
                          )}
                        </div>
                        <p className="text-xs text-gray-400 truncate">{notif.message}</p>
                      </div>
                    </div>
                    
                    <div className="flex gap-2 flex-shrink-0 ml-2">
                      <button
                        onClick={() => handleToggleComplete(notif.id, notif.completed)}
                        className="p-1.5 hover:bg-blue-50 text-blue-600 rounded-md transition-colors"
                        title="Restaurer"
                      >
                        <ChevronUp className="w-4 h-4" />
                      </button>
                      <button
                        onClick={() => setDeletingNotification(notif)}
                        className="p-1.5 hover:bg-red-50 text-red-600 rounded-md transition-colors"
                        title="Supprimer"
                      >
                        <Trash2 className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}
      </div>

      {/* --- MODALS --- */}

      {/* 1. CALL MODAL */}
      {clientForCall && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-xs overflow-hidden scale-100 animate-in zoom-in-95">
            <div className="bg-gray-50 p-4 border-b border-gray-100 flex justify-between items-center">
              <h3 className="font-bold text-gray-900 truncate pr-2">
                {clientForCall.name}
              </h3>
              <button onClick={() => setClientForCall(null)} className="text-gray-400 hover:text-gray-600 bg-white rounded-full p-1 border hover:border-gray-300 transition-colors">
                <X className="w-4 h-4" />
              </button>
            </div>
            
            <div className="p-4 space-y-3">
              {clientForCall.phone ? (
                <a 
                  href={`tel:${clientForCall.phone}`} 
                  className="flex items-center justify-center gap-3 w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-md transition-transform active:scale-95"
                >
                  <Phone className="w-5 h-5" />
                  Appeler Client
                </a>
              ) : (
                <div className="text-center text-xs text-gray-400 py-1">Pas de numéro client</div>
              )}

              {clientForCall.contactPersonPhone && (
                <a 
                  href={`tel:${clientForCall.contactPersonPhone}`} 
                  className="flex items-center justify-center gap-3 w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold shadow-md transition-transform active:scale-95"
                >
                  <User className="w-5 h-5" />
                  Appeler Contact
                </a>
              )}

              {!clientForCall.phone && !clientForCall.contactPersonPhone && (
                <p className="text-center text-sm text-gray-500 py-2">Aucun numéro disponible</p>
              )}
            </div>
          </div>
        </div>
      )}

      {/* 2. APPOINTMENT MODAL */}
      {showBookingModal && (
        <AppointmentModal
          existingAppointments={appointments}
          clients={clients}
          services={services}
          selectedDate={new Date().toISOString().split('T')[0]}
          preSelectedClient={clientForBooking}
          onSave={handleSaveAppointment}
          onAddService={async (name) => {
             const { data } = await supabase.from('services').insert([{ name }]).select().single();
             if (data) { setServices(p => [...p, data]); return true; }
             return false;
          }}
          onDeleteService={async (id) => {
             const { error } = await supabase.from('services').delete().eq('id', id);
             if (!error) { setServices(p => p.filter(s => s.id !== id)); return true; }
             return false;
          }}
          onClose={() => {
            setShowBookingModal(false);
            setClientForBooking(undefined);
            setBookingNotificationId(null);
          }}
        />
      )}

      {/* 3. DELETE CONFIRMATION */}
      {deletingNotification && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl shadow-xl max-w-xs w-full p-6 animate-in zoom-in-95">
            <h3 className="text-lg font-bold text-center text-gray-900 mb-4">Supprimer ?</h3>
            <div className="flex gap-3">
              <button
                onClick={() => setDeletingNotification(null)}
                className="flex-1 py-2 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50"
              >
                Non
              </button>
              <button
                onClick={confirmDelete}
                className="flex-1 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700"
              >
                Oui
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default Notifications;
</file>

<file path="src/components/Payment/PaymentWarningModal.tsx">
import React, { useState, useEffect } from 'react';

interface PaymentWarningModalProps {
  isOpen: boolean;
  onClose: () => void;
  userStatus: 'active' | 'inactive' | 'suspended' | 'unpaid' | 'overdue';
  daysRemaining?: number;
  onUpgrade: (plan: string) => void;
  userName?: string;
  onLogout?: () => void;
}

const PaymentWarningModal: React.FC<PaymentWarningModalProps> = ({
  isOpen,
  onClose,
  userStatus,
  daysRemaining = 0,
  onUpgrade,
  userName = 'Utilisateur',
  onLogout,
}) => {
  useEffect(() => {
    if (isOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }
    return () => {
      document.body.style.overflow = 'unset';
    };
  }, [isOpen]);

  if (!isOpen) return null;

  const features = [
    {
      title: '📅 Gestion de rendez-vous',
      description:
        'Planifiez et organisez vos rendez-vous clients efficacement',
    },
    {
      title: '👥 Gestion clients',
      description: 'Centralisez toutes les informations de vos clients',
    },
    {
      title: '💰 Suivi des dépenses',
      description: 'Gardez un œil sur vos revenus et dépenses',
    },
    {
      title: "🕐 Gestion d'horaire",
      description: 'Organisez votre emploi du temps professionnel',
    },
    {
      title: '📊 Statistiques détaillées',
      description: 'Analysez vos performances et votre activité',
    },
    {
      title: '📈 Rapports personnalisés',
      description: 'Générez des rapports pour suivre votre croissance',
    },
  ];

  const getWarningContent = () => {
    switch (userStatus) {
      case 'inactive':
        return {
          icon: '🔒',
          title: 'Accès Restreint',
          message:
            "Votre compte n'a pas encore été activé. Contactez l'administrateur pour obtenir l'accès à l'application.",
          urgency: 'high',
          buttonText: "Contacter l'administrateur",
        };
      case 'suspended':
        return {
          icon: '🔒',
          title: 'Compte Suspendu',
          message:
            "Votre compte a été suspendu. Veuillez contacter l'administrateur pour plus d'informations.",
          urgency: 'high',
          buttonText: "Contacter l'administrateur",
        };
      case 'unpaid':
        return {
          icon: '⚠️',
          title: 'Action Requise',
          message:
            "Veuillez contacter l'administrateur concernant votre accès à l'application.",
          urgency: 'medium',
          buttonText: "Contacter l'administrateur",
        };
      case 'overdue':
        return {
          icon: '⏰',
          title: 'Attention',
          message:
            "Veuillez contacter l'administrateur pour régulariser votre situation.",
          urgency: 'high',
          buttonText: "Contacter l'administrateur",
        };
      default:
        return {
          icon: '🔒',
          title: 'Accès Restreint',
          message: "Contactez l'administrateur pour obtenir l'accès.",
          urgency: 'medium',
          buttonText: "Contacter l'administrateur",
        };
    }
  };

  const content = getWarningContent();

  const handleCopyEmail = () => {
    navigator.clipboard.writeText('bellerose.cedrick@cinfob.com');
    alert('Email copié dans le presse-papier !');
  };

  const handleContactAdmin = () => {
    window.location.href =
      "mailto:bellerose.cedrick@cinfob.com?subject=Demande d'accès à l'application&body=Bonjour,%0D%0A%0D%0AJe souhaiterais obtenir l'accès à l'application de gestion.%0D%0A%0D%0ACordialement";
  };

  return (
    <div className="fixed inset-0 z-50 overflow-y-auto">
      <div
        className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm transition-opacity"
        onClick={onClose}
      />
      <div className="flex min-h-full items-center justify-center p-4">
        <div className="relative bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
          <button
            onClick={onClose}
            className="absolute top-4 right-4 p-2 rounded-lg hover:bg-gray-100 transition z-10 text-2xl"
          >
            ✕
          </button>

          <div
            className={`relative px-8 pt-8 pb-6 ${
              content.urgency === 'high'
                ? 'bg-gradient-to-r from-red-50 to-orange-50'
                : 'bg-gradient-to-r from-yellow-50 to-amber-50'
            }`}
          >
            <div className="text-center">
              <div className="text-6xl mb-4">{content.icon}</div>
              <h2 className="text-3xl font-bold text-gray-900 mb-2">
                {content.title}
              </h2>
              <p className="text-gray-600 max-w-2xl mx-auto text-lg">
                Bonjour {userName}, {content.message}
              </p>
            </div>
          </div>

          <div className="bg-indigo-600 text-white px-8 py-4">
            <div className="flex items-center justify-center space-x-8 text-sm flex-wrap gap-4">
              <div className="flex items-center space-x-2">
                <span className="text-xl">✓</span>
                <span>Outil interne sécurisé</span>
              </div>
              <div className="flex items-center space-x-2">
                <span className="text-xl">✓</span>
                <span>Interface intuitive</span>
              </div>
              <div className="flex items-center space-x-2">
                <span className="text-xl">⚡</span>
                <span>Support technique inclus</span>
              </div>
            </div>
          </div>

          <div className="px-8 py-8">
            <div className="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-xl p-8 text-white mb-8">
              <div className="text-center">
                <div className="text-5xl mb-4">✉️</div>
                <h3 className="text-2xl font-bold mb-3">Demander l'accès</h3>
                <p className="text-indigo-100 mb-6">
                  Pour activer votre compte et accéder à toutes les
                  fonctionnalités, veuillez contacter l'administrateur :
                </p>
                <div className="bg-white bg-opacity-20 backdrop-blur-sm rounded-lg p-4 inline-block mb-4">
                  <a
                    href="mailto:bellerose.cedrick@cinfob.com"
                    className="text-xl font-semibold hover:underline"
                  >
                    bellerose.cedrick@cinfob.com
                  </a>
                </div>
                <div className="flex justify-center gap-4 flex-wrap">
                  <button
                    onClick={handleCopyEmail}
                    className="px-6 py-2 bg-white text-indigo-600 rounded-lg font-semibold hover:bg-indigo-50 transition"
                  >
                    📋 Copier l'email
                  </button>
                  <button
                    onClick={handleContactAdmin}
                    className="px-6 py-2 bg-white text-indigo-600 rounded-lg font-semibold hover:bg-indigo-50 transition"
                  >
                    📧 Envoyer un email
                  </button>
                </div>
              </div>
            </div>

            <div className="mb-8">
              <h3 className="text-2xl font-bold text-center text-gray-900 mb-6">
                À propos de l'application
              </h3>
              <p className="text-center text-gray-600 mb-8 max-w-2xl mx-auto">
                Cette application est un outil interne complet de gestion pour
                professionnels. Elle vous permet de centraliser toutes vos
                activités quotidiennes en un seul endroit.
              </p>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {features.map((feature, index) => (
                  <div
                    key={index}
                    className="p-5 rounded-xl border-2 border-gray-200 hover:border-indigo-300 hover:shadow-lg transition bg-white"
                  >
                    <h4 className="font-bold text-gray-900 mb-2 text-lg">
                      {feature.title}
                    </h4>
                    <p className="text-sm text-gray-600">
                      {feature.description}
                    </p>
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-gray-50 rounded-xl p-6 mb-6">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                <div>
                  <div className="text-3xl font-bold text-indigo-600 mb-2">
                    99.9%
                  </div>
                  <div className="text-sm text-gray-600">Disponibilité</div>
                </div>
                <div>
                  <div className="text-3xl font-bold text-indigo-600 mb-2">
                    100%
                  </div>
                  <div className="text-sm text-gray-600">Sécurisé</div>
                </div>
                <div>
                  <div className="text-3xl font-bold text-indigo-600 mb-2">
                    24/7
                  </div>
                  <div className="text-sm text-gray-600">
                    Support disponible
                  </div>
                </div>
              </div>
            </div>

            <div className="flex flex-col sm:flex-row gap-4">
              <button
                onClick={onClose}
                className="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition"
              >
                Plus tard
              </button>
              <button
                onClick={handleContactAdmin}
                className="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition flex items-center justify-center space-x-2"
              >
                <span>✉️</span>
                <span>{content.buttonText}</span>
                <span>→</span>
              </button>
            </div>

            {onLogout && (
              <button
                onClick={onLogout}
                className="w-full mt-4 px-6 py-2 text-sm text-gray-500 hover:text-gray-700 transition"
              >
                Se déconnecter
              </button>
            )}

            <p className="text-center text-sm text-gray-500 mt-6">
              💡 L'accès est accordé après validation par l'administrateur
            </p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default PaymentWarningModal;
</file>

<file path="src/components/Preferences/Preferences.tsx">
import React, { useState, useEffect } from 'react';
import {
  Clock,
  Calendar,
  Bell,
  Tag,
  ArrowRight,
  ArrowLeft,
  Check,
  HelpCircle,
  Plus,
  Trash2,
} from 'lucide-react';
import {
  usePreferences,
  FrequencyOption,
  ExpenseCategory,
} from '../../hooks/usePreferences';

const Preferences: React.FC = () => {
  const { preferences, loading, createDefaultPreferences, updatePreferences } =
    usePreferences();

  const [currentStep, setCurrentStep] = useState(0);
  const [saving, setSaving] = useState(false);
  const [showHelp, setShowHelp] = useState(false);

  const [formData, setFormData] = useState({
    min_time_between_appointments: 90,
    business_hours_start: '08:00',
    business_hours_end: '18:00',
    notification_days_before: 7,
    frequency_options: [] as FrequencyOption[],
    expense_categories: [] as ExpenseCategory[],
  });

  // États pour les nouveaux items
  const [newFrequency, setNewFrequency] = useState({ label: '', days: '' });
  const [newCategory, setNewCategory] = useState('');

  // Préremplir les fréquences par défaut
  const defaultFrequencies: FrequencyOption[] = [
    { value: 'weekly', label: 'Hebdomadaire', days: 7 },
    { value: 'biweekly', label: 'Aux 2 semaines', days: 14 },
    { value: 'monthly', label: 'Mensuel', days: 30 },
    { value: 'quarterly', label: 'Trimestriel', days: 90 },
  ];

  // Préremplir les catégories par défaut
  const defaultCategories: ExpenseCategory[] = [
    { value: 'supplies', label: 'Fournitures' },
    { value: 'equipment', label: 'Équipement' },
    { value: 'transportation', label: 'Transport' },
    { value: 'utilities', label: 'Services publics' },
    { value: 'services', label: 'Prestataires' },
    { value: 'other', label: 'Autre' },
  ];

  useEffect(() => {
    if (preferences) {
      setFormData({
        min_time_between_appointments: preferences.min_time_between_appointments,
        business_hours_start: preferences.business_hours_start.slice(0, 5),
        business_hours_end: preferences.business_hours_end.slice(0, 5),
        notification_days_before: preferences.notification_days_before,
        frequency_options: preferences.frequency_options,
        expense_categories: preferences.expense_categories,
      });
      setCurrentStep(4);
    } else {
      setFormData(prev => ({
        ...prev,
        frequency_options: defaultFrequencies,
        expense_categories: defaultCategories,
      }));
    }
  }, [preferences]);

  const steps = [
    {
      title: 'Horaires de travail',
      subtitle: 'Définissez vos heures d\'ouverture',
      icon: Clock,
      help: 'Ces heures détermineront les créneaux disponibles pour vos rendez-vous. Vous pourrez toujours les modifier plus tard.',
    },
    {
      title: 'Espacement des rendez-vous',
      subtitle: 'Temps de pause entre chaque client',
      icon: Calendar,
      help: 'Ce délai vous permet de préparer votre espace, nettoyer et vous reposer entre les rendez-vous. Un avertissement s\'affichera si vous programmez trop proche.',
    },
    {
      title: 'Fréquences de rendez-vous',
      subtitle: 'Options pour vos clients réguliers',
      icon: Calendar,
      help: 'Choisissez les fréquences que vous proposerez à vos clients. Vous pouvez utiliser celles proposées ou créer les vôtres.',
    },
    {
      title: 'Catégories de dépenses',
      subtitle: 'Organisez vos dépenses professionnelles',
      icon: Tag,
      help: 'Sélectionnez les types de dépenses que vous aurez. Cela facilitera votre comptabilité et vos déclarations fiscales.',
    },
    {
      title: 'Notifications',
      subtitle: 'Rappels pour vos rendez-vous',
      icon: Bell,
      help: 'Définissez combien de jours avant un rendez-vous vous souhaitez voir les rappels s\'afficher.',
    },
  ];

  const toggleFrequency = (freq: FrequencyOption) => {
    const exists = formData.frequency_options.some(f => f.value === freq.value);
    if (exists) {
      setFormData(prev => ({
        ...prev,
        frequency_options: prev.frequency_options.filter(f => f.value !== freq.value),
      }));
    } else {
      setFormData(prev => ({
        ...prev,
        frequency_options: [...prev.frequency_options, freq],
      }));
    }
  };

  const addCustomFrequency = () => {
    if (newFrequency.label && newFrequency.days) {
      const days = parseInt(newFrequency.days);
      const value = `custom_${Date.now()}`;
      const freq: FrequencyOption = {
        value,
        label: newFrequency.label,
        days,
      };
      setFormData(prev => ({
        ...prev,
        frequency_options: [...prev.frequency_options, freq],
      }));
      setNewFrequency({ label: '', days: '' });
    }
  };

  const removeFrequency = (value: string) => {
    setFormData(prev => ({
      ...prev,
      frequency_options: prev.frequency_options.filter(f => f.value !== value),
    }));
  };

  const toggleCategory = (cat: ExpenseCategory) => {
    const exists = formData.expense_categories.some(c => c.value === cat.value);
    if (exists) {
      setFormData(prev => ({
        ...prev,
        expense_categories: prev.expense_categories.filter(c => c.value !== cat.value),
      }));
    } else {
      setFormData(prev => ({
        ...prev,
        expense_categories: [...prev.expense_categories, cat],
      }));
    }
  };

  const addCustomCategory = () => {
    if (newCategory.trim()) {
      const value = `custom_${Date.now()}`;
      const cat: ExpenseCategory = {
        value,
        label: newCategory.trim(),
      };
      setFormData(prev => ({
        ...prev,
        expense_categories: [...prev.expense_categories, cat],
      }));
      setNewCategory('');
    }
  };

  const removeCategory = (value: string) => {
    setFormData(prev => ({
      ...prev,
      expense_categories: prev.expense_categories.filter(c => c.value !== value),
    }));
  };

  const handleNext = () => {
    if (currentStep < steps.length - 1) {
      setCurrentStep(currentStep + 1);
      setShowHelp(false);
    } else {
      handleFinish();
    }
  };

  const handleBack = () => {
    if (currentStep > 0) {
      setCurrentStep(currentStep - 1);
      setShowHelp(false);
    }
  };

  const handleFinish = async () => {
    setSaving(true);
    try {
      let success = false;
      
      if (preferences) {
        success = await updatePreferences({
          min_time_between_appointments: formData.min_time_between_appointments,
          business_hours_start: formData.business_hours_start + ':00',
          business_hours_end: formData.business_hours_end + ':00',
          notification_days_before: formData.notification_days_before,
          frequency_options: formData.frequency_options,
          expense_categories: formData.expense_categories,
        });
      } else {
        success = await createDefaultPreferences();
        
        if (success) {
          await updatePreferences({
            min_time_between_appointments: formData.min_time_between_appointments,
            business_hours_start: formData.business_hours_start + ':00',
            business_hours_end: formData.business_hours_end + ':00',
            notification_days_before: formData.notification_days_before,
            frequency_options: formData.frequency_options,
            expense_categories: formData.expense_categories,
          });
        }
      }

      if (success) {
        window.location.reload();
      }
    } catch (err) {
      console.error('Erreur:', err);
      alert('Une erreur est survenue');
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-indigo-600">
        <div className="bg-white rounded-2xl p-8 shadow-2xl">
          <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
          <p className="text-gray-600 mt-4 text-center">Chargement...</p>
        </div>
      </div>
    );
  }

  const currentStepData = steps[currentStep];
  const StepIcon = currentStepData.icon;
  const progress = ((currentStep + 1) / steps.length) * 100;

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-500 via-blue-600 to-indigo-700 flex flex-col">
      {/* Progress Bar */}
      <div className="w-full px-4 pt-4 pb-2">
        <div className="max-w-2xl mx-auto">
          <div className="bg-white/20 rounded-full h-1.5 overflow-hidden">
            <div
              className="bg-white h-full transition-all duration-500 ease-out"
              style={{ width: `${progress}%` }}
            />
          </div>
          <p className="text-white text-center mt-1.5 text-xs font-medium">
            Étape {currentStep + 1} sur {steps.length}
          </p>
        </div>
      </div>

      {/* Main Content - Scrollable */}
      <div className="flex-1 overflow-y-auto px-4 py-4">
        <div className="max-w-2xl mx-auto pb-4">
          {/* Main Card */}
          <div className="bg-white rounded-3xl shadow-2xl overflow-hidden">
            {/* Header */}
            <div className="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white">
              <div className="flex items-center justify-between mb-4">
                <div className="bg-white/20 p-3 rounded-2xl backdrop-blur-sm">
                  <StepIcon className="w-8 h-8" />
                </div>
                <button
                  onClick={() => setShowHelp(!showHelp)}
                  className="bg-white/20 p-2 rounded-full hover:bg-white/30 transition-colors touch-manipulation"
                >
                  <HelpCircle className="w-6 h-6" />
                </button>
              </div>
              <h2 className="text-2xl sm:text-3xl font-bold mb-2">
                {currentStepData.title}
              </h2>
              <p className="text-blue-100 text-sm sm:text-base">
                {currentStepData.subtitle}
              </p>
            </div>

            {/* Help Message */}
            {showHelp && (
              <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mx-6 mt-6 rounded-r-lg">
                <p className="text-blue-900 text-sm leading-relaxed">
                  💡 {currentStepData.help}
                </p>
              </div>
            )}

            {/* Content */}
            <div className="p-6 sm:p-8">
              {/* Step 0: Horaires */}
              {currentStep === 0 && (
                <div className="space-y-6">
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">
                        Ouverture
                      </label>
                      <input
                        type="time"
                        value={formData.business_hours_start}
                        onChange={(e) =>
                          setFormData({ ...formData, business_hours_start: e.target.value })
                        }
                        className="w-full px-3 py-3 text-base sm:text-lg font-semibold border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all touch-manipulation"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">
                        Fermeture
                      </label>
                      <input
                        type="time"
                        value={formData.business_hours_end}
                        onChange={(e) =>
                          setFormData({ ...formData, business_hours_end: e.target.value })
                        }
                        className="w-full px-3 py-3 text-base sm:text-lg font-semibold border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all touch-manipulation"
                      />
                    </div>
                  </div>
                  <div className="bg-gray-50 rounded-xl p-4 border border-gray-200">
                    <p className="text-sm text-gray-600">
                      ⏰ Vos rendez-vous seront proposés entre{' '}
                      <span className="font-bold text-gray-900">{formData.business_hours_start}</span>
                      {' '}et{' '}
                      <span className="font-bold text-gray-900">{formData.business_hours_end}</span>
                    </p>
                  </div>
                </div>
              )}

              {/* Step 1: Espacement */}
              {currentStep === 1 && (
                <div className="space-y-6">
                  <div>
                    <label className="block text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">
                      Temps minimum entre rendez-vous
                    </label>
                    <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-4">
                      <input
                        type="range"
                        min="0"
                        max="180"
                        step="15"
                        value={formData.min_time_between_appointments}
                        onChange={(e) =>
                          setFormData({
                            ...formData,
                            min_time_between_appointments: parseInt(e.target.value),
                          })
                        }
                        className="flex-1 h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer touch-manipulation"
                      />
                      <div className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold text-xl text-center sm:min-w-[100px]">
                        {formData.min_time_between_appointments} min
                      </div>
                    </div>
                  </div>
                  <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    {[30, 60, 90, 120].map((minutes) => (
                      <button
                        key={minutes}
                        type="button"
                        onClick={() =>
                          setFormData({ ...formData, min_time_between_appointments: minutes })
                        }
                        className={`py-3 px-4 rounded-xl font-semibold transition-all touch-manipulation ${
                          formData.min_time_between_appointments === minutes
                            ? 'bg-blue-600 text-white shadow-lg scale-105'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200 active:bg-gray-300'
                        }`}
                      >
                        {minutes} min
                      </button>
                    ))}
                  </div>
                  <div className="bg-yellow-50 rounded-xl p-4 border border-yellow-200">
                    <p className="text-sm text-yellow-800">
                      ⚠️ Un avertissement s'affichera si vous planifiez deux rendez-vous à moins de{' '}
                      <span className="font-bold">{formData.min_time_between_appointments} minutes</span>{' '}
                      d'intervalle.
                    </p>
                  </div>
                </div>
              )}

              {/* Step 2: Fréquences */}
              {currentStep === 2 && (
                <div className="space-y-4">
                  <p className="text-gray-600 text-sm mb-4">
                    Cliquez pour sélectionner ou désélectionner :
                  </p>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    {/* Options par défaut (toggle) */}
                    {defaultFrequencies.map((freq) => {
                      const isSelected = formData.frequency_options.some(f => f.value === freq.value);
                      return (
                        <button
                          key={freq.value}
                          type="button"
                          onClick={() => toggleFrequency(freq)}
                          className={`p-4 rounded-xl border-2 transition-all text-left ${
                            isSelected
                              ? 'border-blue-500 bg-blue-50 shadow-md'
                              : 'border-gray-200 bg-white hover:border-blue-300'
                          }`}
                        >
                          <div className="flex items-start justify-between">
                            <div className="flex-1">
                              <p className="font-bold text-gray-900">{freq.label}</p>
                              <p className="text-sm text-gray-600">Tous les {freq.days} jours</p>
                            </div>
                            {isSelected && (
                              <div className="bg-blue-500 rounded-full p-1 flex-shrink-0">
                                <Check className="w-4 h-4 text-white" />
                              </div>
                            )}
                          </div>
                        </button>
                      );
                    })}
                    
                    {/* Options personnalisées (toggle + supprimer) */}
                    {formData.frequency_options
                      .filter(freq => !defaultFrequencies.some(d => d.value === freq.value))
                      .map((freq) => (
                        <div
                          key={freq.value}
                          className="p-4 rounded-xl border-2 border-blue-500 bg-blue-50 shadow-md relative"
                        >
                          <div className="flex items-start justify-between">
                            <div className="flex-1">
                              <p className="font-bold text-gray-900">{freq.label}</p>
                              <p className="text-sm text-gray-600">Tous les {freq.days} jours</p>
                            </div>
                            <div className="flex items-center gap-2">
                              <div className="bg-blue-500 rounded-full p-1 flex-shrink-0">
                                <Check className="w-4 h-4 text-white" />
                              </div>
                              <button
                                type="button"
                                onClick={() => removeFrequency(freq.value)}
                                className="text-red-500 hover:bg-red-50 p-1.5 rounded-lg transition-colors touch-manipulation"
                              >
                                <Trash2 className="w-4 h-4" />
                              </button>
                            </div>
                          </div>
                        </div>
                      ))
                    }
                  </div>

                  {/* Ajouter une fréquence personnalisée */}
                  <div className="border-t-2 border-gray-200 pt-4 mt-6">
                    <p className="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">
                      + Créer une fréquence personnalisée
                    </p>
                    <div className="flex flex-col sm:flex-row gap-3">
                      <input
                        type="text"
                        placeholder="Ex: Bimensuel"
                        value={newFrequency.label}
                        onChange={(e) => setNewFrequency({ ...newFrequency, label: e.target.value })}
                        className="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 touch-manipulation"
                      />
                      <input
                        type="number"
                        placeholder="Jours"
                        value={newFrequency.days}
                        onChange={(e) => setNewFrequency({ ...newFrequency, days: e.target.value })}
                        className="w-full sm:w-28 px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 touch-manipulation"
                      />
                      <button
                        type="button"
                        onClick={addCustomFrequency}
                        className="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 active:bg-blue-800 transition-colors flex items-center justify-center gap-2 touch-manipulation"
                      >
                        <Plus className="w-5 h-5" />
                        Ajouter
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Step 3: Catégories */}
              {currentStep === 3 && (
                <div className="space-y-4">
                  <p className="text-gray-600 text-sm mb-4">
                    Cliquez pour sélectionner ou désélectionner :
                  </p>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    {/* Options par défaut (toggle) */}
                    {defaultCategories.map((cat) => {
                      const isSelected = formData.expense_categories.some(c => c.value === cat.value);
                      return (
                        <button
                          key={cat.value}
                          type="button"
                          onClick={() => toggleCategory(cat)}
                          className={`p-4 rounded-xl border-2 transition-all text-left ${
                            isSelected
                              ? 'border-blue-500 bg-blue-50 shadow-md'
                              : 'border-gray-200 bg-white hover:border-blue-300'
                          }`}
                        >
                          <div className="flex items-center justify-between">
                            <p className="font-bold text-gray-900 flex-1">{cat.label}</p>
                            {isSelected && (
                              <div className="bg-blue-500 rounded-full p-1 flex-shrink-0">
                                <Check className="w-4 h-4 text-white" />
                              </div>
                            )}
                          </div>
                        </button>
                      );
                    })}
                    
                    {/* Options personnalisées (toggle + supprimer) */}
                    {formData.expense_categories
                      .filter(cat => !defaultCategories.some(d => d.value === cat.value))
                      .map((cat) => (
                        <div
                          key={cat.value}
                          className="p-4 rounded-xl border-2 border-blue-500 bg-blue-50 shadow-md"
                        >
                          <div className="flex items-center justify-between">
                            <p className="font-bold text-gray-900 flex-1">{cat.label}</p>
                            <div className="flex items-center gap-2">
                              <div className="bg-blue-500 rounded-full p-1 flex-shrink-0">
                                <Check className="w-4 h-4 text-white" />
                              </div>
                              <button
                                type="button"
                                onClick={() => removeCategory(cat.value)}
                                className="text-red-500 hover:bg-red-50 p-1.5 rounded-lg transition-colors touch-manipulation"
                              >
                                <Trash2 className="w-4 h-4" />
                              </button>
                            </div>
                          </div>
                        </div>
                      ))
                    }
                  </div>

                  {/* Ajouter une catégorie personnalisée */}
                  <div className="border-t-2 border-gray-200 pt-4 mt-6">
                    <p className="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">
                      + Créer une catégorie personnalisée
                    </p>
                    <div className="flex gap-3">
                      <input
                        type="text"
                        placeholder="Ex: Marketing"
                        value={newCategory}
                        onChange={(e) => setNewCategory(e.target.value)}
                        className="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 touch-manipulation"
                      />
                      <button
                        type="button"
                        onClick={addCustomCategory}
                        className="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 active:bg-blue-800 transition-colors flex items-center gap-2 touch-manipulation"
                      >
                        <Plus className="w-5 h-5" />
                        Ajouter
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Step 4: Notifications */}
              {currentStep === 4 && (
                <div className="space-y-6">
                  <div>
                    <label className="block text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">
                      Rappels des rendez-vous
                    </label>
                    <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-4">
                      <input
                        type="range"
                        min="1"
                        max="14"
                        value={formData.notification_days_before}
                        onChange={(e) =>
                          setFormData({
                            ...formData,
                            notification_days_before: parseInt(e.target.value),
                          })
                        }
                        className="flex-1 h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer touch-manipulation"
                      />
                      <div className="bg-purple-600 text-white px-6 py-3 rounded-xl font-bold text-xl text-center sm:min-w-[120px]">
                        {formData.notification_days_before} jour{formData.notification_days_before > 1 ? 's' : ''}
                      </div>
                    </div>
                  </div>
                  <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    {[1, 3, 7, 14].map((days) => (
                      <button
                        key={days}
                        type="button"
                        onClick={() =>
                          setFormData({ ...formData, notification_days_before: days })
                        }
                        className={`py-3 px-4 rounded-xl font-semibold transition-all touch-manipulation ${
                          formData.notification_days_before === days
                            ? 'bg-purple-600 text-white shadow-lg scale-105'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200 active:bg-gray-300'
                        }`}
                      >
                        {days}j
                      </button>
                    ))}
                  </div>
                  <div className="bg-purple-50 rounded-xl p-4 border border-purple-200">
                    <p className="text-sm text-purple-800">
                      🔔 Les rendez-vous apparaîtront dans vos notifications{' '}
                      <span className="font-bold">{formData.notification_days_before} jour{formData.notification_days_before > 1 ? 's' : ''}</span>{' '}
                      avant la date prévue.
                    </p>
                  </div>
                </div>
              )}
            </div>

            {/* Footer Buttons */}
            <div className="bg-gray-50 px-6 py-4 sm:px-8 flex gap-3">
              {currentStep > 0 && (
                <button
                  onClick={handleBack}
                  className="flex items-center gap-2 px-4 sm:px-6 py-4 border-2 border-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-100 active:bg-gray-200 transition-all touch-manipulation"
                >
                  <ArrowLeft className="w-5 h-5" />
                  <span className="hidden sm:inline">Retour</span>
                </button>
              )}
              <button
                onClick={handleNext}
                disabled={saving}
                className="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-4 rounded-xl font-bold hover:from-blue-700 hover:to-indigo-700 active:scale-95 transition-all disabled:opacity-50 shadow-lg touch-manipulation"
              >
                {saving ? (
                  <>
                    <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                    Sauvegarde...
                  </>
                ) : currentStep === steps.length - 1 ? (
                  <>
                    <Check className="w-5 h-5" />
                    Terminer
                  </>
                ) : (
                  <>
                    Continuer
                    <ArrowRight className="w-5 h-5" />
                  </>
                )}
              </button>
            </div>
          </div>

          {/* Skip Button */}
          {!preferences && (
            <button
              onClick={handleFinish}
              disabled={saving}
              className="w-full mt-4 text-white hover:text-white/90 text-sm font-bold py-3 transition-colors backdrop-blur-sm bg-white/10 rounded-xl disabled:opacity-50"
            >
              Passer et utiliser les valeurs par défaut →
            </button>
          )}
        </div>
      </div>
    </div>
  );
};

export default Preferences;
</file>

<file path="src/components/Settings/PasskeyModal.tsx">
import React, { useState } from 'react';
import { X, Key, Shield } from 'lucide-react';

interface PasskeyModalProps {
  onSave: (name: string) => void;
  onClose: () => void;
}

const PasskeyModal: React.FC<PasskeyModalProps> = ({ onSave, onClose }) => {
  const [name, setName] = useState('');
  const [error, setError] = useState('');

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!name.trim()) {
      setError('Le nom de la passkey est requis');
      return;
    }

    onSave(name.trim());
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50 p-0 sm:p-4">
      <div className="bg-white rounded-t-2xl sm:rounded-lg shadow-xl w-full sm:max-w-md sm:w-full max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between p-6 border-b border-gray-200">
          <h2 className="text-lg sm:text-xl font-semibold text-gray-900">
            Créer une nouvelle passkey
          </h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition-colors touch-manipulation"
          >
            <X className="h-6 w-6" />
          </button>
        </div>

        <div className="p-6">
          {/* Info Section */}
          <div className="bg-blue-50 rounded-lg p-4 mb-6">
            <div className="flex items-start gap-3">
              <Shield className="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" />
              <div>
                <h3 className="font-medium text-blue-900 mb-2">Qu'est-ce qu'une passkey ?</h3>
                <p className="text-sm text-blue-800">
                  Une passkey est une méthode d'authentification sécurisée qui utilise 
                  la biométrie (empreinte digitale, reconnaissance faciale) ou un code PIN 
                  de votre appareil au lieu d'un mot de passe traditionnel.
                </p>
              </div>
            </div>
          </div>

          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                <Key className="h-4 w-4 inline mr-2" />
                Nom de la passkey
              </label>
              <input
                type="text"
                value={name}
                onChange={(e) => {
                  setName(e.target.value);
                  setError('');
                }}
                className={`w-full border rounded-lg px-4 py-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation ${
                  error ? 'border-red-500' : 'border-gray-300'
                }`}
                placeholder="Ex: Mon iPhone, Mon ordinateur portable..."
                required
              />
              {error && (
                <p className="mt-1 text-sm text-red-600">{error}</p>
              )}
              <p className="mt-1 text-sm text-gray-500">
                Donnez un nom descriptif pour identifier cette passkey
              </p>
            </div>

            <div className="bg-yellow-50 rounded-lg p-4">
              <div className="flex items-start gap-3">
                <Key className="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0" />
                <div>
                  <h4 className="font-medium text-yellow-900 mb-1">Avant de continuer</h4>
                  <p className="text-sm text-yellow-800">
                    Assurez-vous que votre appareil supporte l'authentification biométrique 
                    ou qu'un code PIN est configuré.
                  </p>
                </div>
              </div>
            </div>

            <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 pt-4">
              <button
                type="button"
                onClick={onClose}
                className="flex-1 px-6 py-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors touch-manipulation font-medium"
              >
                Annuler
              </button>
              <button
                type="submit"
                className="flex-1 px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors touch-manipulation font-medium"
              >
                Créer la passkey
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
};

export default PasskeyModal;
</file>

<file path="src/components/Settings/Settings.tsx">
import React, { useState, useEffect } from 'react';
import { 
  Menu, Key, Plus, Trash2, Shield, User, Calendar, 
  Building, MapPin, Phone, Globe, Settings as SettingsIcon,
  Save, Loader2, Hash, CreditCard, ChevronRight, Mail, X,
  AlertTriangle
} from 'lucide-react';
import { supabase } from '../../lib/supabase';
import { Passkey } from '../../types';
import PasskeyModal from './PasskeyModal';

interface SettingsProps {
  onMenuToggle: () => void;
  onNavigate?: (view: string) => void;
}

const Settings: React.FC<SettingsProps> = ({ onMenuToggle, onNavigate }) => {
  const [loading, setLoading] = useState(true);
  const [currentUser, setCurrentUser] = useState<any>(null);
  const [passkeys, setPasskeys] = useState<Passkey[]>([]);
  const [isPasskeyModalOpen, setIsPasskeyModalOpen] = useState(false);
  const [deletingPasskey, setDeletingPasskey] = useState<Passkey | null>(null);
  const [isSavingCompany, setIsSavingCompany] = useState(false);
  const [companyForm, setCompanyForm] = useState({
    companyName: '',
    address: '',
    phone: '',
    website: '',
    neq: '',
    tps: '',
    tvq: ''
  });

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      setLoading(true);
      const { data: { user } } = await supabase.auth.getUser();
      
      if (user) {
        setCurrentUser(user);
        const meta = user.user_metadata || {};
        setCompanyForm({
          companyName: meta.company_name || '',
          address: meta.company_address || '',
          phone: meta.company_phone || '',
          website: meta.company_website || '',
          neq: meta.company_neq || '',
          tps: meta.company_tps || '',
          tvq: meta.company_tvq || ''
        });
      }
    } catch (error) {
      console.error('Error loading settings:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSaveCompany = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSavingCompany(true);
    try {
      const { error } = await supabase.auth.updateUser({
        data: {
          company_name: companyForm.companyName,
          company_address: companyForm.address,
          company_phone: companyForm.phone,
          company_website: companyForm.website,
          company_neq: companyForm.neq,
          company_tps: companyForm.tps,
          company_tvq: companyForm.tvq
        }
      });
      if (error) throw error;
      alert('Informations mises à jour avec succès ! ✨');
    } catch (err) {
      console.error(err);
      alert('Erreur lors de la sauvegarde.');
    } finally {
      setIsSavingCompany(false);
    }
  };

  const handleCreatePasskey = async (name: string) => {
    setIsPasskeyModalOpen(false);
    alert('Passkey créée (Simulation)');
  };

  const handleDeletePasskeyClick = (passkey: Passkey) => {
    setDeletingPasskey(passkey);
  };

  const confirmDeletePasskey = () => {
    if (deletingPasskey) {
      console.log('Deleted:', deletingPasskey.id);
      setDeletingPasskey(null);
    }
  };

  const cancelDeletePasskey = () => {
    setDeletingPasskey(null);
  };

  if (loading) {
    return (
      <div className="flex-1 flex items-center justify-center bg-gray-50 h-full">
        <Loader2 className="w-8 h-8 text-blue-600 animate-spin" />
      </div>
    );
  }

  return (
    <div className="flex-1 overflow-auto">
      {/* Mobile Header */}
      <div className="lg:hidden bg-white shadow-sm border-b border-gray-200 px-4 py-4 flex items-center justify-between sticky top-0 z-30">
        <button
          onClick={onMenuToggle}
          className="p-3 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 active:bg-gray-200 transition-colors"
        >
          <Menu className="h-6 w-6" />
        </button>
        <h1 className="text-xl font-semibold text-gray-900">Paramètres</h1>
        <div className="w-12"></div>
      </div>

      <div className="p-4 md:p-6 space-y-6">
        {/* Header */}
        <div className="flex items-center gap-4">
          <button
            onClick={onMenuToggle}
            className="hidden lg:flex p-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-colors"
          >
            <Menu className="h-6 w-6" />
          </button>
          <div>
            <h1 className="text-2xl md:text-3xl font-bold text-gray-900 hidden lg:block">
              Paramètres
            </h1>
            <p className="text-gray-600 mt-1">
              Gérez votre compte et les informations de votre entreprise
            </p>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          
          {/* Colonne gauche - Formulaire entreprise */}
          <div className="lg:col-span-2 space-y-6">
            {/* Carte Entreprise */}
            <div className="bg-white rounded-lg shadow-md border border-gray-200">
              <div className="px-6 py-4 border-b border-gray-200">
                <h2 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
                  <Building className="w-5 h-5 text-gray-600" />
                  Informations de l'entreprise
                </h2>
              </div>
              
              <form onSubmit={handleSaveCompany} className="p-6 space-y-5">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Nom de l'entreprise
                    </label>
                    <input 
                      type="text" 
                      value={companyForm.companyName}
                      onChange={e => setCompanyForm({...companyForm, companyName: e.target.value})}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base"
                      placeholder="Votre entreprise"
                    />
                  </div>

                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Adresse
                    </label>
                    <input 
                      type="text" 
                      value={companyForm.address}
                      onChange={e => setCompanyForm({...companyForm, address: e.target.value})}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base"
                      placeholder="123 Rue Example, Ville, Province"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Téléphone
                    </label>
                    <input 
                      type="text" 
                      value={companyForm.phone}
                      onChange={e => setCompanyForm({...companyForm, phone: e.target.value})}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base"
                      placeholder="(000) 000-0000"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Site Web
                    </label>
                    <input 
                      type="text" 
                      value={companyForm.website}
                      onChange={e => setCompanyForm({...companyForm, website: e.target.value})}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base"
                      placeholder="www.exemple.com"
                    />
                  </div>

                  <div className="md:col-span-2 pt-4 border-t border-gray-200">
                    <h3 className="text-sm font-semibold text-gray-700 mb-4">
                      Information Fiscale
                    </h3>
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          NEQ
                        </label>
                        <input 
                          type="text" 
                          value={companyForm.neq}
                          onChange={e => setCompanyForm({...companyForm, neq: e.target.value})}
                          className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base"
                          placeholder="11XX..."
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          TPS
                        </label>
                        <input 
                          type="text" 
                          value={companyForm.tps}
                          onChange={e => setCompanyForm({...companyForm, tps: e.target.value})}
                          className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base"
                          placeholder="RT0001"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          TVQ
                        </label>
                        <input 
                          type="text" 
                          value={companyForm.tvq}
                          onChange={e => setCompanyForm({...companyForm, tvq: e.target.value})}
                          className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base"
                          placeholder="TQ0001"
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <div className="flex justify-end pt-4">
                  <button 
                    type="submit"
                    disabled={isSavingCompany}
                    className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors font-medium disabled:opacity-70"
                  >
                    {isSavingCompany ? (
                      <Loader2 className="w-5 h-5 animate-spin"/>
                    ) : (
                      <Save className="w-5 h-5" />
                    )}
                    Enregistrer
                  </button>
                </div>
              </form>
            </div>

            {/* Banner Préférences */}
            {onNavigate && (
              <div 
                onClick={() => onNavigate('preferences')}
                className="bg-white border border-gray-200 rounded-lg p-6 shadow-md hover:shadow-lg transition-shadow cursor-pointer group"
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <div className="bg-purple-100 p-3 rounded-lg group-hover:bg-purple-200 transition-colors">
                      <SettingsIcon className="w-6 h-6 text-purple-600" />
                    </div>
                    <div>
                      <h3 className="font-semibold text-gray-900 text-lg">
                        Préférences Système
                      </h3>
                      <p className="text-sm text-gray-600 mt-1">
                        Horaires, catégories, notifications
                      </p>
                    </div>
                  </div>
                  <ChevronRight className="w-6 h-6 text-gray-400 group-hover:text-purple-600 transition-colors" />
                </div>
              </div>
            )}
          </div>

          {/* Colonne droite - Profil & Sécurité */}
          <div className="space-y-6">
            {/* Carte Profil */}
            <div className="bg-white rounded-lg shadow-md border border-gray-200">
              <div className="p-6 text-center border-b border-gray-200">
                <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl font-bold text-white shadow-lg">
                  {currentUser?.email?.charAt(0).toUpperCase()}
                </div>
                <h3 className="font-bold text-gray-900 text-lg truncate px-4">
                  {currentUser?.email}
                </h3>
                <span className="inline-block mt-3 px-4 py-1.5 rounded-full text-sm font-medium bg-green-100 text-green-700 border border-green-200">
                  {currentUser?.user_metadata?.role === 'admin' ? 'Administrateur' : 'Utilisateur'}
                </span>
              </div>
              <div className="p-6 space-y-3">
                <div className="flex items-center gap-3 text-sm text-gray-600">
                  <Mail className="w-5 h-5 text-gray-400" />
                  <span className="truncate">{currentUser?.email}</span>
                </div>
                <div className="flex items-center gap-3 text-sm text-gray-600">
                  <Calendar className="w-5 h-5 text-gray-400" />
                  <span>
                    Inscrit le {new Date(currentUser?.created_at).toLocaleDateString('fr-FR')}
                  </span>
                </div>
              </div>
            </div>

            {/* Carte Sécurité */}
            <div className="bg-white rounded-lg shadow-md border border-gray-200">
              <div className="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 className="font-semibold text-gray-900 flex items-center gap-2">
                  <Shield className="w-5 h-5 text-gray-600" />
                  Passkeys
                </h3>
                <button
                  onClick={() => setIsPasskeyModalOpen(true)}
                  className="flex items-center gap-1.5 text-sm font-medium text-blue-600 hover:text-blue-700 transition-colors"
                >
                  <Plus className="w-4 h-4" />
                  Ajouter
                </button>
              </div>

              <div className="p-4">
                {passkeys.length > 0 ? (
                  <div className="space-y-2">
                    {passkeys.map((pk) => (
                      <div 
                        key={pk.id} 
                        className="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors group"
                      >
                        <div className="flex items-center gap-3">
                          <Key className="w-5 h-5 text-gray-400" />
                          <span className="text-sm font-medium text-gray-700">
                            {pk.name}
                          </span>
                        </div>
                        <button 
                          onClick={() => handleDeletePasskeyClick(pk)} 
                          className="text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-all"
                        >
                          <Trash2 className="w-5 h-5" />
                        </button>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                      <Key className="w-6 h-6 text-gray-400" />
                    </div>
                    <p className="text-sm text-gray-500">
                      Aucune passkey configurée
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* Modals */}
        {isPasskeyModalOpen && (
          <PasskeyModal
            onSave={handleCreatePasskey}
            onClose={() => setIsPasskeyModalOpen(false)}
          />
        )}

        {/* Delete Passkey Confirmation Modal */}
        {deletingPasskey && (
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
            <div className="relative w-full max-w-md" style={{ animation: 'scaleIn 0.3s ease-out' }}>
              <div className="absolute inset-0 bg-gradient-to-br from-red-500 via-rose-600 to-pink-700 opacity-95 rounded-3xl" />
              <div className="absolute inset-0 backdrop-blur-xl bg-white/10 rounded-3xl" />
              
              <div className="absolute -top-10 -left-10 w-40 h-40 bg-red-400/30 rounded-full blur-3xl animate-pulse" style={{ animationDuration: '3s' }} />
              <div className="absolute -bottom-10 -right-10 w-32 h-32 bg-pink-400/30 rounded-full blur-2xl animate-pulse" style={{ animationDuration: '4s', animationDelay: '1s' }} />
              
              <div className="relative p-8">
                <button onClick={cancelDeletePasskey} className="absolute top-4 right-4 p-2 rounded-xl bg-white/15 backdrop-blur-md hover:bg-white/25 transition-all duration-300 border border-white/30 hover:scale-110 group">
                  <X className="w-5 h-5 text-white group-hover:rotate-90 transition-transform duration-300" />
                </button>

                <div className="flex justify-center mb-6">
                  <div className="relative">
                    <div className="absolute inset-0 bg-white/30 rounded-full blur-xl" />
                    <div className="relative w-20 h-20 bg-white/20 backdrop-blur-lg rounded-full flex items-center justify-center border-2 border-white/40 shadow-2xl">
                      <AlertTriangle className="w-10 h-10 text-white drop-shadow-2xl animate-pulse" />
                    </div>
                  </div>
                </div>

                <h3 className="text-2xl font-bold text-white text-center mb-3 drop-shadow-lg">
                  Supprimer la passkey ?
                </h3>

                <div className="bg-white/15 backdrop-blur-md rounded-2xl p-5 mb-6 border border-white/30 shadow-xl">
                  <p className="text-white/95 text-center leading-relaxed drop-shadow-md">
                    Voulez-vous vraiment supprimer la passkey{' '}
                    <span className="font-bold text-white">"{deletingPasskey.name}"</span> ?
                  </p>
                  <p className="text-white/80 text-sm text-center mt-2 drop-shadow">
                    Cette action est irréversible.
                  </p>
                </div>

                <div className="flex gap-3">
                  <button onClick={cancelDeletePasskey} className="flex-1 px-6 py-4 bg-white/20 backdrop-blur-lg hover:bg-white/30 text-white font-semibold rounded-xl transition-all duration-300 border border-white/40 hover:scale-105 shadow-lg">
                    Annuler
                  </button>
                  <button onClick={confirmDeletePasskey} className="flex-1 px-6 py-4 bg-white/90 hover:bg-white text-red-600 font-bold rounded-xl transition-all duration-300 border border-white shadow-2xl hover:scale-105 hover:shadow-red-500/50">
                    Supprimer
                  </button>
                </div>
              </div>

              <style>{`
                @keyframes scaleIn {
                  from { transform: scale(0.9); opacity: 0; }
                  to { transform: scale(1); opacity: 1; }
                }
              `}</style>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default Settings;
</file>

<file path="src/components/Toast/ToastContainer.tsx">
import React, { useEffect } from 'react';
import { CheckCircle, XCircle, AlertTriangle, Info, X } from 'lucide-react';
import { Toast, ToastType } from '../../types/toast';

interface ToastContainerProps {
  toasts: Toast[];
  onRemove: (id: string) => void;
}

const ToastContainer: React.FC<ToastContainerProps> = ({
  toasts,
  onRemove,
}) => {
  return (
    <div className="fixed top-4 right-4 z-[9999] space-y-3 max-w-md w-full px-4 pointer-events-none">
      {toasts.map((toast) => (
        <ToastItem key={toast.id} toast={toast} onRemove={onRemove} />
      ))}
    </div>
  );
};

interface ToastItemProps {
  toast: Toast;
  onRemove: (id: string) => void;
}

const ToastItem: React.FC<ToastItemProps> = ({ toast, onRemove }) => {
  useEffect(() => {
    const timer = setTimeout(() => {
      onRemove(toast.id);
    }, toast.duration || 4000);

    return () => clearTimeout(timer);
  }, [toast.id, toast.duration, onRemove]);

  const getToastStyles = (type: ToastType) => {
    switch (type) {
      case 'success':
        return {
          gradient: 'from-green-500 via-emerald-600 to-teal-700',
          icon: CheckCircle,
          iconColor: 'text-green-100',
          glowColor: 'bg-green-400/30',
        };
      case 'error':
        return {
          gradient: 'from-red-500 via-rose-600 to-pink-700',
          icon: XCircle,
          iconColor: 'text-red-100',
          glowColor: 'bg-red-400/30',
        };
      case 'warning':
        return {
          gradient: 'from-amber-500 via-orange-600 to-yellow-700',
          icon: AlertTriangle,
          iconColor: 'text-amber-100',
          glowColor: 'bg-amber-400/30',
        };
      case 'info':
        return {
          gradient: 'from-blue-500 via-indigo-600 to-purple-700',
          icon: Info,
          iconColor: 'text-blue-100',
          glowColor: 'bg-blue-400/30',
        };
    }
  };

  const {
    gradient,
    icon: Icon,
    iconColor,
    glowColor,
  } = getToastStyles(toast.type);

  return (
    <div
      className="relative animate-slideInRight pointer-events-auto"
      style={{
        animation: 'slideInRight 0.4s ease-out forwards',
      }}
    >
      {/* Background gradient */}
      <div
        className={`absolute inset-0 bg-gradient-to-br ${gradient} opacity-95 rounded-2xl`}
      />

      {/* Glassmorphism layer */}
      <div className="absolute inset-0 backdrop-blur-xl bg-white/10 rounded-2xl" />

      {/* Glow effects */}
      <div
        className={`absolute -top-2 -left-2 w-24 h-24 ${glowColor} rounded-full blur-2xl animate-pulse`}
        style={{ animationDuration: '3s' }}
      />
      <div
        className={`absolute -bottom-2 -right-2 w-20 h-20 ${glowColor} rounded-full blur-xl animate-pulse`}
        style={{ animationDuration: '4s', animationDelay: '1s' }}
      />

      {/* Content */}
      <div className="relative flex items-start gap-3 p-4 pr-12">
        {/* Icon avec glow */}
        <div className="relative flex-shrink-0">
          <div
            className={`absolute inset-0 ${glowColor} rounded-full blur-md`}
          />
          <div className="relative w-10 h-10 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center border border-white/40 shadow-lg">
            <Icon className={`w-5 h-5 ${iconColor} drop-shadow-lg`} />
          </div>
        </div>

        {/* Message */}
        <div className="flex-1 pt-1.5">
          <p className="text-white font-medium drop-shadow-lg text-[15px] leading-relaxed">
            {toast.message}
          </p>
        </div>

        {/* Close button */}
        <button
          onClick={() => onRemove(toast.id)}
          className="absolute top-3 right-3 p-1.5 rounded-lg bg-white/15 backdrop-blur-md hover:bg-white/25 transition-all duration-200 border border-white/30 hover:scale-110 group"
        >
          <X className="w-4 h-4 text-white/90 group-hover:rotate-90 transition-transform duration-300" />
        </button>
      </div>

      {/* Progress bar */}
      <div className="relative h-1 bg-white/10 rounded-b-2xl overflow-hidden">
        <div
          className="h-full bg-white/40 backdrop-blur-sm shadow-lg"
          style={{
            animation: `shrink ${toast.duration || 4000}ms linear forwards`,
          }}
        />
      </div>

      <style>{`
        @keyframes slideInRight {
          from {
            transform: translateX(120%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        
        @keyframes shrink {
          from {
            width: 100%;
          }
          to {
            width: 0%;
          }
        }
      `}</style>
    </div>
  );
};

export default ToastContainer;
</file>

<file path="src/components/Users/Toast/ToastContainer.tsx">
import React, { useEffect } from 'react';
import { CheckCircle, XCircle, AlertTriangle, Info, X } from 'lucide-react';
import { Toast, ToastType } from '../../types/toast';

interface ToastContainerProps {
  toasts: Toast[];
  onRemove: (id: string) => void;
}

const ToastContainer: React.FC<ToastContainerProps> = ({
  toasts,
  onRemove,
}) => {
  return (
    <div className="fixed top-4 right-4 z-[9999] space-y-3 max-w-md w-full px-4 pointer-events-none">
      {toasts.map((toast) => (
        <ToastItem key={toast.id} toast={toast} onRemove={onRemove} />
      ))}
    </div>
  );
};

interface ToastItemProps {
  toast: Toast;
  onRemove: (id: string) => void;
}

const ToastItem: React.FC<ToastItemProps> = ({ toast, onRemove }) => {
  useEffect(() => {
    const timer = setTimeout(() => {
      onRemove(toast.id);
    }, toast.duration || 4000);

    return () => clearTimeout(timer);
  }, [toast.id, toast.duration, onRemove]);

  const getToastStyles = (type: ToastType) => {
    switch (type) {
      case 'success':
        return {
          gradient: 'from-green-500 via-emerald-600 to-teal-700',
          icon: CheckCircle,
          iconColor: 'text-green-100',
          glowColor: 'bg-green-400/30',
        };
      case 'error':
        return {
          gradient: 'from-red-500 via-rose-600 to-pink-700',
          icon: XCircle,
          iconColor: 'text-red-100',
          glowColor: 'bg-red-400/30',
        };
      case 'warning':
        return {
          gradient: 'from-amber-500 via-orange-600 to-yellow-700',
          icon: AlertTriangle,
          iconColor: 'text-amber-100',
          glowColor: 'bg-amber-400/30',
        };
      case 'info':
        return {
          gradient: 'from-blue-500 via-indigo-600 to-purple-700',
          icon: Info,
          iconColor: 'text-blue-100',
          glowColor: 'bg-blue-400/30',
        };
    }
  };

  const {
    gradient,
    icon: Icon,
    iconColor,
    glowColor,
  } = getToastStyles(toast.type);

  return (
    <div
      className="relative animate-slideInRight pointer-events-auto"
      style={{
        animation: 'slideInRight 0.4s ease-out forwards',
      }}
    >
      {/* Background gradient */}
      <div
        className={`absolute inset-0 bg-gradient-to-br ${gradient} opacity-95 rounded-2xl`}
      />

      {/* Glassmorphism layer */}
      <div className="absolute inset-0 backdrop-blur-xl bg-white/10 rounded-2xl" />

      {/* Glow effects */}
      <div
        className={`absolute -top-2 -left-2 w-24 h-24 ${glowColor} rounded-full blur-2xl animate-pulse`}
        style={{ animationDuration: '3s' }}
      />
      <div
        className={`absolute -bottom-2 -right-2 w-20 h-20 ${glowColor} rounded-full blur-xl animate-pulse`}
        style={{ animationDuration: '4s', animationDelay: '1s' }}
      />

      {/* Content */}
      <div className="relative flex items-start gap-3 p-4 pr-12">
        {/* Icon avec glow */}
        <div className="relative flex-shrink-0">
          <div
            className={`absolute inset-0 ${glowColor} rounded-full blur-md`}
          />
          <div className="relative w-10 h-10 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center border border-white/40 shadow-lg">
            <Icon className={`w-5 h-5 ${iconColor} drop-shadow-lg`} />
          </div>
        </div>

        {/* Message */}
        <div className="flex-1 pt-1.5">
          <p className="text-white font-medium drop-shadow-lg text-[15px] leading-relaxed">
            {toast.message}
          </p>
        </div>

        {/* Close button */}
        <button
          onClick={() => onRemove(toast.id)}
          className="absolute top-3 right-3 p-1.5 rounded-lg bg-white/15 backdrop-blur-md hover:bg-white/25 transition-all duration-200 border border-white/30 hover:scale-110 group"
        >
          <X className="w-4 h-4 text-white/90 group-hover:rotate-90 transition-transform duration-300" />
        </button>
      </div>

      {/* Progress bar */}
      <div className="relative h-1 bg-white/10 rounded-b-2xl overflow-hidden">
        <div
          className="h-full bg-white/40 backdrop-blur-sm shadow-lg"
          style={{
            animation: `shrink ${toast.duration || 4000}ms linear forwards`,
          }}
        />
      </div>

      <style>{`
        @keyframes slideInRight {
          from {
            transform: translateX(120%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        
        @keyframes shrink {
          from {
            width: 100%;
          }
          to {
            width: 0%;
          }
        }
      `}</style>
    </div>
  );
};

export default ToastContainer;
</file>

<file path="src/components/Users/UserManagement.tsx">
import React, { useState, useEffect } from 'react';
import { Search, Plus, Edit, Trash2, User, Shield, Menu, Mail, Calendar } from 'lucide-react';
import { supabase } from '../../lib/supabase';
import { UserProfile } from '../../types';
import UserModal from './UserModal';

interface UserManagementProps {
  onMenuToggle: () => void;
}

const UserManagement: React.FC<UserManagementProps> = ({ onMenuToggle }) => {
  const [users, setUsers] = useState<UserProfile[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingUser, setEditingUser] = useState<UserProfile | null>(null);

  useEffect(() => {
    loadUsers();
  }, []);

  const loadUsers = async () => {
    try {
      setLoading(true);
      
      // Get all users from auth.users using admin API
      const { data: { users: authUsers }, error } = await supabase.auth.admin.listUsers();
      
      if (error) throw error;
      
      // Map auth users to UserProfile format
      const mappedUsers: UserProfile[] = authUsers.map(user => ({
        id: user.id,
        email: user.email || '',
        full_name: user.user_metadata?.full_name || user.email || 'User',
        role: user.email === 'admin@company.com' ? 'admin' : 'user',
        created_at: user.created_at,
        updated_at: user.updated_at || user.created_at
      }));
      
      setUsers(mappedUsers);
    } catch (error) {
      console.error('Error loading users:', error);
      setUsers([]); // Set empty array on error
    } finally {
      setLoading(false);
    }
  };

  const filteredUsers = users.filter(user =>
    user.full_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
    user.email.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const handleAddUser = () => {
    setEditingUser(null);
    setIsModalOpen(true);
  };

  const handleEditUser = (user: UserProfile) => {
    setEditingUser(user);
    setIsModalOpen(true);
  };

  const handleDeleteUser = async (userId: string) => {
    if (!confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?')) {
      return;
    }

    try {
      // First delete from auth.users (this will cascade to user_profiles)
      const { error } = await supabase.auth.admin.deleteUser(userId);
      
      if (error) throw error;
      
      await loadUsers();
    } catch (error) {
      console.error('Error deleting user:', error);
      alert('Erreur lors de la suppression de l\'utilisateur');
    }
  };

  const handleSaveUser = async (userData: { email: string; full_name: string; role: 'admin' | 'user'; password?: string }) => {
    try {
      if (editingUser) {
        // Update existing user metadata
        const { error } = await supabase.auth.admin.updateUserById(
          editingUser.id,
          {
            user_metadata: {
              full_name: userData.full_name,
              role: userData.role
            }
          }
        );

        if (error) throw error;
      } else {
        // Create new user
        const { data: authData, error: authError } = await supabase.auth.admin.createUser({
          email: userData.email,
          password: userData.password!,
          user_metadata: {
            full_name: userData.full_name,
            role: userData.role
          }
        });

        if (authError) throw authError;
      }

      await loadUsers();
      setIsModalOpen(false);
      setEditingUser(null);
    } catch (error) {
      console.error('Error saving user:', error);
      alert('Erreur lors de la sauvegarde de l\'utilisateur');
    }
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('fr-FR', {
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    });
  };

  if (loading) {
    return (
      <div className="flex-1 flex items-center justify-center">
        <div className="text-center">
          <div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-gray-600">Chargement des utilisateurs...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="flex-1 overflow-auto">
      {/* Mobile Header */}
      <div className="lg:hidden bg-white shadow-sm border-b border-gray-200 px-4 py-4 flex items-center justify-between sticky top-0 z-30">
        <button
          onClick={onMenuToggle}
          className="p-3 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 active:bg-gray-200 transition-colors"
        >
          <Menu className="h-6 w-6" />
        </button>
        <h1 className="text-xl font-semibold text-gray-900">Utilisateurs</h1>
        <div className="w-12"></div>
      </div>

      <div className="p-4 md:p-6 space-y-6">
        {/* Header */}
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div className="flex items-center gap-4">
            <button
              onClick={onMenuToggle}
              className="hidden lg:flex p-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-colors"
            >
              <Menu className="h-6 w-6" />
            </button>
            <div>
              <h1 className="text-2xl sm:text-3xl font-bold text-gray-900 hidden lg:block">Gestion des utilisateurs</h1>
              <p className="text-gray-600 lg:hidden">Gérez les comptes utilisateurs</p>
            </div>
          </div>
          <button
            onClick={handleAddUser}
            className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors w-full sm:w-auto justify-center touch-manipulation font-medium"
          >
            <Plus className="w-4 h-4" />
            Ajouter un utilisateur
          </button>
        </div>

        {/* Search */}
        <div className="relative">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
          <input
            type="text"
            placeholder="Rechercher des utilisateurs..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full pl-10 pr-4 py-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base touch-manipulation"
          />
        </div>

        {/* Users Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
          {filteredUsers.map((user) => (
            <div
              key={user.id}
              className="bg-white rounded-lg shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow"
            >
              <div className="flex items-start justify-between mb-4">
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-2">
                    <h3 className="text-lg font-semibold text-gray-900 truncate">
                      {user.full_name}
                    </h3>
                    {user.role === 'admin' && (
                      <Shield className="w-4 h-4 text-orange-500" title="Administrateur" />
                    )}
                  </div>
                  <div className="flex items-center gap-2 text-sm text-gray-600 mb-2">
                    <Mail className="w-4 h-4 flex-shrink-0" />
                    <span className="truncate">{user.email}</span>
                  </div>
                  <div className="flex items-center gap-2 text-sm text-gray-600">
                    <Calendar className="w-4 h-4 flex-shrink-0" />
                    <span>Créé le {formatDate(user.created_at)}</span>
                  </div>
                </div>
                <div className="flex gap-1 ml-2">
                  <button
                    onClick={() => handleEditUser(user)}
                    className="p-3 text-gray-400 hover:text-blue-600 hover:bg-blue-50 active:bg-blue-100 rounded-lg transition-colors touch-manipulation"
                  >
                    <Edit className="w-4 h-4" />
                  </button>
                  <button
                    onClick={() => handleDeleteUser(user.id)}
                    className="p-3 text-gray-400 hover:text-red-600 hover:bg-red-50 active:bg-red-100 rounded-lg transition-colors touch-manipulation"
                  >
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              </div>

              <div className="pt-3 border-t border-gray-100">
                <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                  user.role === 'admin' 
                    ? 'bg-orange-100 text-orange-800' 
                    : 'bg-blue-100 text-blue-800'
                }`}>
                  {user.role === 'admin' ? 'Administrateur' : 'Utilisateur'}
                </span>
              </div>
            </div>
          ))}
        </div>

        {filteredUsers.length === 0 && (
          <div className="text-center py-8 sm:py-12">
            <div className="text-gray-400 mb-4">
              <User className="w-12 h-12 mx-auto" />
            </div>
            <h3 className="text-lg font-medium text-gray-900 mb-2">Aucun utilisateur trouvé</h3>
            <p className="text-gray-600 mb-4">
              {searchTerm ? 'Essayez d\'ajuster vos termes de recherche' : 'Commencez par ajouter votre premier utilisateur'}
            </p>
            {!searchTerm && (
              <button
                onClick={handleAddUser}
                className="inline-flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors touch-manipulation font-medium"
              >
                <Plus className="w-4 h-4" />
                Ajouter un utilisateur
              </button>
            )}
          </div>
        )}

        {/* Modal */}
        {isModalOpen && (
          <UserModal
            user={editingUser}
            onSave={handleSaveUser}
            onClose={() => {
              setIsModalOpen(false);
              setEditingUser(null);
            }}
          />
        )}
      </div>
    </div>
  );
};

export default UserManagement;
</file>

<file path="src/components/Users/UserModal.tsx">
import React, { useState, useEffect } from 'react';
import { X, User, Mail, Shield, Lock } from 'lucide-react';
import { UserProfile } from '../../types';

interface UserModalProps {
  user?: UserProfile | null;
  onSave: (user: { email: string; full_name: string; role: 'admin' | 'user'; password?: string }) => void;
  onClose: () => void;
}

const UserModal: React.FC<UserModalProps> = ({ user, onSave, onClose }) => {
  const [formData, setFormData] = useState({
    email: '',
    full_name: '',
    role: 'user' as 'admin' | 'user',
    password: '',
    confirmPassword: ''
  });
  const [errors, setErrors] = useState<Record<string, string>>({});

  useEffect(() => {
    if (user) {
      setFormData({
        email: user.email,
        full_name: user.full_name,
        role: user.role,
        password: '',
        confirmPassword: ''
      });
    }
  }, [user]);

  const validateForm = () => {
    const newErrors: Record<string, string> = {};

    if (!formData.email.trim()) {
      newErrors.email = 'L\'email est requis';
    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
      newErrors.email = 'Format d\'email invalide';
    }

    if (!formData.full_name.trim()) {
      newErrors.full_name = 'Le nom complet est requis';
    }

    if (!user) { // New user
      if (!formData.password) {
        newErrors.password = 'Le mot de passe est requis';
      } else if (formData.password.length < 6) {
        newErrors.password = 'Le mot de passe doit contenir au moins 6 caractères';
      }

      if (formData.password !== formData.confirmPassword) {
        newErrors.confirmPassword = 'Les mots de passe ne correspondent pas';
      }
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!validateForm()) {
      return;
    }

    const userData = {
      email: formData.email.trim(),
      full_name: formData.full_name.trim(),
      role: formData.role,
      ...(formData.password && { password: formData.password })
    };

    onSave(userData);
  };

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
    
    // Clear error when user starts typing
    if (errors[name]) {
      setErrors(prev => ({ ...prev, [name]: '' }));
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50 p-0 sm:p-4">
      <div className="bg-white rounded-t-2xl sm:rounded-lg shadow-xl w-full sm:max-w-md sm:w-full max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between p-6 border-b border-gray-200">
          <h2 className="text-lg sm:text-xl font-semibold text-gray-900">
            {user ? 'Modifier l\'utilisateur' : 'Ajouter un nouvel utilisateur'}
          </h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition-colors touch-manipulation"
          >
            <X className="h-6 w-6" />
          </button>
        </div>

        <form onSubmit={handleSubmit} className="p-4 sm:p-6 space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
              <Mail className="h-4 w-4 inline mr-2" />
              Adresse email
            </label>
            <input
              type="email"
              name="email"
              value={formData.email}
              onChange={handleChange}
              disabled={!!user} // Disable email editing for existing users
              className={`w-full border rounded-lg px-4 py-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation ${
                user ? 'bg-gray-100 cursor-not-allowed' : ''
              } ${errors.email ? 'border-red-500' : 'border-gray-300'}`}
              placeholder="Entrez l'adresse email"
              required
            />
            {errors.email && (
              <p className="mt-1 text-sm text-red-600">{errors.email}</p>
            )}
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
              <User className="h-4 w-4 inline mr-2" />
              Nom complet
            </label>
            <input
              type="text"
              name="full_name"
              value={formData.full_name}
              onChange={handleChange}
              className={`w-full border rounded-lg px-4 py-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation ${
                errors.full_name ? 'border-red-500' : 'border-gray-300'
              }`}
              placeholder="Entrez le nom complet"
              required
            />
            {errors.full_name && (
              <p className="mt-1 text-sm text-red-600">{errors.full_name}</p>
            )}
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
              <Shield className="h-4 w-4 inline mr-2" />
              Rôle
            </label>
            <select
              name="role"
              value={formData.role}
              onChange={handleChange}
              className="w-full border border-gray-300 rounded-lg px-4 py-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation"
              required
            >
              <option value="user">Utilisateur</option>
              <option value="admin">Administrateur</option>
            </select>
          </div>

          {!user && (
            <>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                  <Lock className="h-4 w-4 inline mr-2" />
                  Mot de passe
                </label>
                <input
                  type="password"
                  name="password"
                  value={formData.password}
                  onChange={handleChange}
                  className={`w-full border rounded-lg px-4 py-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation ${
                    errors.password ? 'border-red-500' : 'border-gray-300'
                  }`}
                  placeholder="Entrez le mot de passe"
                  required
                />
                {errors.password && (
                  <p className="mt-1 text-sm text-red-600">{errors.password}</p>
                )}
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                  <Lock className="h-4 w-4 inline mr-2" />
                  Confirmer le mot de passe
                </label>
                <input
                  type="password"
                  name="confirmPassword"
                  value={formData.confirmPassword}
                  onChange={handleChange}
                  className={`w-full border rounded-lg px-4 py-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation ${
                    errors.confirmPassword ? 'border-red-500' : 'border-gray-300'
                  }`}
                  placeholder="Confirmez le mot de passe"
                  required
                />
                {errors.confirmPassword && (
                  <p className="mt-1 text-sm text-red-600">{errors.confirmPassword}</p>
                )}
              </div>
            </>
          )}

          <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 pt-4">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 px-6 py-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors touch-manipulation font-medium"
            >
              Annuler
            </button>
            <button
              type="submit"
              className="flex-1 px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors touch-manipulation font-medium"
            >
              {user ? 'Modifier' : 'Créer'} l'utilisateur
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default UserModal;
</file>

<file path="src/components/LoginForm.tsx">
import React, { useState } from 'react';
import { Lock, Mail, Eye, EyeOff, User, AlertCircle } from 'lucide-react';

interface LoginFormProps {
  onLogin: (email: string, password: string) => Promise<boolean>;
  onRegister?: (
    email: string,
    password: string,
    fullName: string
  ) => Promise<boolean>;
  loading?: boolean;
}

const LoginForm: React.FC<LoginFormProps> = ({
  onLogin,
  onRegister,
  loading,
}) => {
  const [isRegistering, setIsRegistering] = useState(false);

  const [email, setEmail] = useState('');
  const [fullName, setFullName] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');

  const [showPassword, setShowPassword] = useState(false);
  const [error, setError] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const isLoading = isSubmitting || loading;

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setIsSubmitting(true);

    try {
      if (isRegistering) {
        // --- LOGIQUE D'INSCRIPTION ---
        if (password !== confirmPassword) {
          throw new Error('Les mots de passe ne correspondent pas.');
        }
        if (!fullName.trim()) {
          throw new Error('Le nom complet est requis.');
        }
        if (password.length < 6) {
          throw new Error(
            'Le mot de passe doit contenir au moins 6 caractères.'
          );
        }

        if (onRegister) {
          try {
            const success = await onRegister(email, password, fullName);
            if (!success) {
              throw new Error(
                "Impossible de créer le compte. L'email existe peut-être déjà."
              );
            }
          } catch (regError: any) {
            // Capturer l'erreur lancée par useAuth
            throw regError;
          }
        } else {
          throw new Error("La fonction d'inscription n'est pas disponible.");
        }
      } else {
        // --- LOGIQUE DE CONNEXION ---
        const success = await onLogin(email, password);
        if (!success) {
          throw new Error(
            'Email ou mot de passe incorrect. Veuillez réessayer.'
          );
        }
      }
    } catch (err: any) {
      // Amélioration des messages d'erreur Supabase
      let errorMessage = err.message;

      // Erreurs Supabase courantes
      if (err.message?.includes('Invalid login credentials')) {
        errorMessage = 'Email ou mot de passe incorrect.';
      } else if (err.message?.includes('Email not confirmed')) {
        errorMessage =
          'Veuillez confirmer votre email avant de vous connecter.';
      } else if (err.message?.includes('User already registered')) {
        errorMessage = 'Cet email est déjà utilisé. Essayez de vous connecter.';
      } else if (err.message?.includes('Password should be at least')) {
        errorMessage = 'Le mot de passe doit contenir au moins 6 caractères.';
      } else if (err.message?.includes('Unable to validate email')) {
        errorMessage = "Format d'email invalide.";
      }

      setError(errorMessage);
    } finally {
      setIsSubmitting(false);
    }
  };

  const toggleMode = () => {
    setIsRegistering(!isRegistering);
    setError('');
    setPassword('');
    setConfirmPassword('');
    setFullName('');
  };

  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8">
        <div>
          <div className="mx-auto h-12 w-12 bg-blue-600 rounded-lg flex items-center justify-center">
            <Lock className="h-6 w-6 text-white" />
          </div>
          <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
            {isRegistering ? 'Créer un compte' : 'Connexion aux Outils'}
          </h2>
          <p className="mt-2 text-center text-sm text-gray-600">
            {isRegistering
              ? 'Rejoignez la plateforme de gestion'
              : 'Accédez à votre espace sécurisé'}
          </p>
        </div>

        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          <div className="space-y-4">
            {/* Champ Nom Complet */}
            {isRegistering && (
              <div className="animate-fade-in">
                <label
                  htmlFor="fullName"
                  className="block text-sm font-medium text-gray-700"
                >
                  Nom complet
                </label>
                <div className="mt-1 relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <User className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    id="fullName"
                    name="fullName"
                    type="text"
                    required={isRegistering}
                    value={fullName}
                    onChange={(e) => setFullName(e.target.value)}
                    disabled={isLoading}
                    className="pl-10 block w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
                    placeholder="Jean Dupont"
                  />
                </div>
              </div>
            )}

            {/* Email */}
            <div>
              <label
                htmlFor="email"
                className="block text-sm font-medium text-gray-700"
              >
                Adresse e-mail
              </label>
              <div className="mt-1 relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Mail className="h-5 w-5 text-gray-400" />
                </div>
                <input
                  id="email"
                  name="email"
                  type="email"
                  autoComplete="email"
                  required
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  disabled={isLoading}
                  className="pl-10 block w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
                  placeholder="nom@exemple.com"
                />
              </div>
            </div>

            {/* Mot de passe */}
            <div>
              <label
                htmlFor="password"
                className="block text-sm font-medium text-gray-700"
              >
                Mot de passe{' '}
                {isRegistering && (
                  <span className="text-gray-500 text-xs">
                    (min. 6 caractères)
                  </span>
                )}
              </label>
              <div className="mt-1 relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Lock className="h-5 w-5 text-gray-400" />
                </div>
                <input
                  id="password"
                  name="password"
                  type={showPassword ? 'text' : 'password'}
                  autoComplete={
                    isRegistering ? 'new-password' : 'current-password'
                  }
                  required
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  disabled={isLoading}
                  className="pl-10 pr-10 block w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
                  placeholder="••••••••"
                />
                <button
                  type="button"
                  className="absolute inset-y-0 right-0 pr-3 flex items-center"
                  onClick={() => setShowPassword(!showPassword)}
                  disabled={isLoading}
                >
                  {showPassword ? (
                    <EyeOff className="h-5 w-5 text-gray-400 hover:text-gray-600" />
                  ) : (
                    <Eye className="h-5 w-5 text-gray-400 hover:text-gray-600" />
                  )}
                </button>
              </div>
            </div>

            {/* Confirmation */}
            {isRegistering && (
              <div className="animate-fade-in">
                <label
                  htmlFor="confirmPassword"
                  className="block text-sm font-medium text-gray-700"
                >
                  Confirmer le mot de passe
                </label>
                <div className="mt-1 relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Lock className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    id="confirmPassword"
                    name="confirmPassword"
                    type="password"
                    required={isRegistering}
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                    disabled={isLoading}
                    className="pl-10 block w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
                    placeholder="••••••••"
                  />
                </div>
              </div>
            )}
          </div>

          {/* Message d'erreur amélioré */}
          {error && (
            <div className="animate-fade-in bg-red-50 border border-red-200 rounded-lg p-4">
              <div className="flex items-start">
                <AlertCircle className="h-5 w-5 text-red-600 mt-0.5 mr-3 flex-shrink-0" />
                <div>
                  <h3 className="text-sm font-medium text-red-800">Erreur</h3>
                  <p className="text-sm text-red-700 mt-1">{error}</p>
                </div>
              </div>
            </div>
          )}

          <div className="flex flex-col gap-4">
            <button
              type="submit"
              disabled={isLoading}
              className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              {isLoading ? (
                <div className="flex items-center">
                  <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
                  Chargement...
                </div>
              ) : isRegistering ? (
                "S'inscrire"
              ) : (
                'Se connecter'
              )}
            </button>

            <div className="text-center">
              <button
                type="button"
                onClick={toggleMode}
                disabled={isLoading}
                className="text-sm text-blue-600 hover:text-blue-500 font-medium disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isRegistering
                  ? 'Déjà un compte ? Se connecter'
                  : 'Pas encore de compte ? Créer un compte'}
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  );
};

export default LoginForm;
</file>

<file path="src/hooks/useActivityLogs.ts">
import { useState, useEffect } from 'react';
import { supabase } from '../lib/supabase';

export interface ActivityLog {
  id: string;
  actionType: 'client_added' | 'client_updated' | 'client_deleted' | 'appointment_added' | 'appointment_updated' | 'appointment_deleted' | 'appointment_completed';
  entityType: 'client' | 'appointment';
  entityId: string;
  entityName: string;
  description: string;
  createdAt: string;
}

export const useActivityLogs = () => {
  const [activities, setActivities] = useState<ActivityLog[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const loadActivityLogs = async () => {
    try {
      setLoading(true);
      setError(null);

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        setActivities([]);
        return;
      }

      const { data, error } = await supabase
        .from('activity_logs')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false })
        .limit(10);

      if (error) throw error;

      const formattedActivities: ActivityLog[] = data.map(log => ({
        id: log.id,
        actionType: log.action_type,
        entityType: log.entity_type,
        entityId: log.entity_id,
        entityName: log.entity_name,
        description: log.description,
        createdAt: log.created_at
      }));

      setActivities(formattedActivities);
    } catch (err) {
      console.error('Error loading activity logs:', err);
      setError(err instanceof Error ? err.message : 'Erreur lors du chargement des activités');
      setActivities([]);
    } finally {
      setLoading(false);
    }
  };

  const logActivity = async (
    actionType: ActivityLog['actionType'],
    entityType: ActivityLog['entityType'],
    entityId: string,
    entityName: string,
    description: string
  ): Promise<boolean> => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return false;

      const { error } = await supabase
        .from('activity_logs')
        .insert([{
          user_id: user.id,
          action_type: actionType,
          entity_type: entityType,
          entity_id: entityId,
          entity_name: entityName,
          description: description
        }]);

      if (error) throw error;

      await loadActivityLogs();
      return true;
    } catch (err) {
      console.error('Error logging activity:', err);
      return false;
    }
  };

  useEffect(() => {
    loadActivityLogs();
  }, []);

  return {
    activities,
    loading,
    error,
    logActivity,
    refreshActivityLogs: loadActivityLogs
  };
};
</file>

<file path="src/hooks/useAppointments.ts">
import { useState, useEffect, useCallback, useRef } from 'react';
import { supabase } from '../lib/supabase';
import { Appointment } from '../types';
import { RealtimeChannel } from '@supabase/supabase-js';
import { useAuth } from './useAuth';

export const useAppointments = () => {
  const { user } = useAuth();
  const [appointments, setAppointments] = useState<Appointment[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // ✅ Ref pour éviter les re-subscriptions multiples
  const channelRef = useRef<RealtimeChannel | null>(null);
  const isSubscribedRef = useRef(false);

  // ✅ Load appointments avec useCallback pour stabiliser la référence
  const loadAppointments = useCallback(async () => {
    try {
      console.log('useAppointments: Loading appointments...');
      setError(null);

      // Check if user is authenticated
      const {
        data: { user },
        error: authError,
      } = await supabase.auth.getUser();

      if (authError) {
        console.error('useAppointments: Auth error:', authError);
        setError('Non authentifié');
        setAppointments([]);
        setLoading(false);
        return;
      }

      if (!user) {
        console.log('useAppointments: No user, clearing appointments');
        setAppointments([]);
        setLoading(false);
        return;
      }

      console.log('useAppointments: Loading for user:', user.id);

      const { data, error: fetchError } = await supabase
        .from('appointments')
        .select(
          `
          *,
          clients!inner(name),
          services(name)
        `
        )
        .eq('user_id', user.id)
        .order('date', { ascending: true })
        .order('time', { ascending: true });

      if (fetchError) {
        console.error('useAppointments: Error loading:', fetchError);
        throw fetchError;
      }

      console.log('useAppointments: Loaded', data?.length || 0, 'appointments');

      const formattedAppointments: Appointment[] = (data || []).map(
        (appointment) => ({
          id: appointment.id,
          clientId: appointment.client_id,
          clientName: appointment.clients.name,
          service: appointment.services?.name || 'Service supprimé',
          notes: appointment.notes || '',
          date: appointment.date,
          time: appointment.time,
          duration: appointment.duration,
          status: appointment.status,
          price: appointment.price ? parseFloat(appointment.price) : undefined,
        })
      );

      setAppointments(formattedAppointments);
      setError(null);
    } catch (err) {
      console.error('useAppointments: Fatal error:', err);
      setError(
        err instanceof Error
          ? err.message
          : 'Erreur lors du chargement des rendez-vous'
      );
      setAppointments([]);
    } finally {
      setLoading(false);
    }
  }, []);

  // Add a new appointment
  const addAppointment = async (
    appointmentData: Omit<Appointment, 'id'>
  ): Promise<boolean> => {
    try {
      const {
        data: { user },
        error: authError,
      } = await supabase.auth.getUser();

      if (authError || !user) {
        console.error('useAppointments: Not authenticated');
        setError('Non authentifié');
        return false;
      }

      console.log('useAppointments: Adding appointment:', appointmentData);

      // Get service ID by name
      const { data: serviceData, error: serviceError } = await supabase
        .from('services')
        .select('id')
        .eq('name', appointmentData.service)
        .maybeSingle();

      if (serviceError) {
        console.error('useAppointments: Error finding service:', serviceError);
      }

      const { data, error: insertError } = await supabase
        .from('appointments')
        .insert([
          {
            user_id: user.id,
            client_id: appointmentData.clientId,
            service_id: serviceData?.id,
            date: appointmentData.date,
            time: appointmentData.time,
            duration: appointmentData.duration,
            status: appointmentData.status,
            notes: appointmentData.notes,
            price: appointmentData.price,
          },
        ])
        .select(
          `
          *,
          clients!inner(name),
          services(name)
        `
        )
        .single();

      if (insertError) {
        console.error(
          'useAppointments: Error adding appointment:',
          insertError
        );
        throw insertError;
      }

      console.log('useAppointments: Appointment added successfully:', data.id);

      // Log activity (sans bloquer - fire and forget)
      supabase
        .from('activity_logs')
        .insert([
          {
            user_id: user.id,
            action_type: 'appointment_added',
            entity_type: 'appointment',
            entity_id: data.id,
            entity_name: appointmentData.service,
            description: `Rendez-vous "${appointmentData.service}" avec ${data.clients.name} ajouté`,
          },
        ])
        .then(() => console.log('Activity logged'))
        .catch((err: Error) => console.error('Failed to log activity:', err));

      // ⚠️ Realtime va recharger automatiquement, pas besoin de reload manuel
      setError(null);
      return true;
    } catch (err) {
      console.error('useAppointments: Error in addAppointment:', err);
      setError(
        err instanceof Error
          ? err.message
          : "Erreur lors de l'ajout du rendez-vous"
      );
      return false;
    }
  };

  // Update an appointment
  const updateAppointment = async (
    id: string,
    appointmentData: Partial<Appointment>
  ): Promise<boolean> => {
    try {
      const {
        data: { user },
        error: authError,
      } = await supabase.auth.getUser();

      if (authError || !user) {
        console.error('useAppointments: Not authenticated');
        setError('Non authentifié');
        return false;
      }

      console.log('useAppointments: Updating appointment:', id);

      const updateData: any = {};

      if (appointmentData.clientId !== undefined)
        updateData.client_id = appointmentData.clientId;
      if (appointmentData.date !== undefined)
        updateData.date = appointmentData.date;
      if (appointmentData.time !== undefined)
        updateData.time = appointmentData.time;
      if (appointmentData.duration !== undefined)
        updateData.duration = appointmentData.duration;
      if (appointmentData.status !== undefined)
        updateData.status = appointmentData.status;
      if (appointmentData.notes !== undefined)
        updateData.notes = appointmentData.notes;
      if (appointmentData.price !== undefined)
        updateData.price = appointmentData.price;

      // Handle service update
      if (appointmentData.service !== undefined) {
        const { data: serviceData } = await supabase
          .from('services')
          .select('id')
          .eq('name', appointmentData.service)
          .maybeSingle();
        updateData.service_id = serviceData?.id;
      }

      const { error: updateError } = await supabase
        .from('appointments')
        .update(updateData)
        .eq('id', id)
        .eq('user_id', user.id);

      if (updateError) {
        console.error('useAppointments: Error updating:', updateError);
        throw updateError;
      }

      console.log('useAppointments: Appointment updated successfully');

      // Log activity (fire and forget)
      supabase
        .from('activity_logs')
        .insert([
          {
            user_id: user.id,
            action_type:
              appointmentData.status === 'completed'
                ? 'appointment_completed'
                : 'appointment_updated',
            entity_type: 'appointment',
            entity_id: id,
            entity_name: appointmentData.service || 'Rendez-vous',
            description:
              appointmentData.status === 'completed'
                ? `Rendez-vous "${
                    appointmentData.service || 'Rendez-vous'
                  }" marqué comme terminé`
                : `Rendez-vous "${
                    appointmentData.service || 'Rendez-vous'
                  }" modifié`,
          },
        ])
        .then(() => console.log('Activity logged'))
        .catch((err: Error) => console.error('Failed to log activity:', err));

      // ⚠️ Realtime va recharger automatiquement
      setError(null);
      return true;
    } catch (err) {
      console.error('useAppointments: Error in updateAppointment:', err);
      setError(
        err instanceof Error
          ? err.message
          : 'Erreur lors de la modification du rendez-vous'
      );
      return false;
    }
  };

  // Delete an appointment
  const deleteAppointment = async (id: string): Promise<boolean> => {
    try {
      const {
        data: { user },
        error: authError,
      } = await supabase.auth.getUser();

      if (authError || !user) {
        console.error('useAppointments: Not authenticated');
        setError('Non authentifié');
        return false;
      }

      const appointmentToDelete = appointments.find((a) => a.id === id);

      console.log('useAppointments: Deleting appointment:', id);

      const { error: deleteError } = await supabase
        .from('appointments')
        .delete()
        .eq('id', id)
        .eq('user_id', user.id);

      if (deleteError) {
        console.error('useAppointments: Error deleting:', deleteError);
        throw deleteError;
      }

      console.log('useAppointments: Appointment deleted successfully');

      // 🆕 MISE À JOUR OPTIMISTE - Retire l'appointment de l'état local
      setAppointments((prev) => prev.filter((apt) => apt.id !== id));

      // Log activity (fire and forget)
      if (appointmentToDelete) {
        supabase
          .from('activity_logs')
          .insert([
            {
              user_id: user.id,
              action_type: 'appointment_deleted',
              entity_type: 'appointment',
              entity_id: id,
              entity_name: appointmentToDelete.service,
              description: `Rendez-vous "${appointmentToDelete.service}" avec ${appointmentToDelete.clientName} supprimé`,
            },
          ])
          .then(() => console.log('Activity logged'))
          .catch((err: Error) => console.error('Failed to log activity:', err));
      }

      // Realtime va aussi recharger automatiquement en arrière-plan
      setError(null);
      return true;
    } catch (err) {
      console.error('useAppointments: Error in deleteAppointment:', err);
      setError(
        err instanceof Error
          ? err.message
          : 'Erreur lors de la suppression du rendez-vous'
      );
      return false;
    }
  };

  // ✅ useEffect avec cleanup PROPRE
  useEffect(() => {
    if (!user) {
      console.log('useAppointments: No user, skipping...');
      return;
    }
    console.log('useAppointments: Effect running...');

    // Éviter les doubles subscriptions (React StrictMode)
    if (isSubscribedRef.current) {
      console.log('useAppointments: Already subscribed, skipping');
      return;
    }

    let mounted = true;

    const setupSubscriptions = async () => {
      // Chargement initial
      if (mounted) {
        await loadAppointments();
      }

      // Vérifier l'auth
      const {
        data: { user },
      } = await supabase.auth.getUser();

      if (!user || !mounted) {
        console.log(
          'useAppointments: No user or unmounted, skipping subscription'
        );
        return;
      }

      // ✅ Configuration Realtime avec filter pour éviter les doublons
      console.log('useAppointments: Setting up Realtime subscription');

      channelRef.current = supabase
        .channel(`appointments-${user.id}`) // ⚠️ Channel unique par user
        .on(
          'postgres_changes',
          {
            event: '*',
            schema: 'public',
            table: 'appointments',
            filter: `user_id=eq.${user.id}`, // ⚠️ Filtrer par user_id
          },
          (payload) => {
            console.log('useAppointments: Realtime event:', payload.eventType);
            if (mounted) {
              loadAppointments();
            }
          }
        )
        .subscribe((status) => {
          console.log('useAppointments: Subscription status:', status);
          if (status === 'SUBSCRIBED') {
            isSubscribedRef.current = true;
          }
        });
    };

    setupSubscriptions();

    // ✅ CLEANUP CRUCIAL
    return () => {
      console.log('useAppointments: Cleaning up...');
      mounted = false;
      isSubscribedRef.current = false;

      if (channelRef.current) {
        console.log('useAppointments: Unsubscribing channel');
        supabase.removeChannel(channelRef.current);
        channelRef.current = null;
      }
    };
  }, [user, loadAppointments]); // ⚠️ Dépendances nécessaires

  // ✅ SEUL RETURN À LA FIN DU HOOK
  return {
    appointments,
    loading,
    error,
    addAppointment,
    updateAppointment,
    deleteAppointment,
    refreshAppointments: loadAppointments,
  };
};
</file>

<file path="src/hooks/useAuth.ts">
import { useState, useEffect } from 'react';
import { supabase, signInWithPassword, signOut, signUp } from '../lib/supabase';
import type { User } from '@supabase/supabase-js';

interface AuthUser {
  id: string;
  email: string;
  full_name: string;
  role: 'admin' | 'user';
  payment_status: 'active' | 'inactive' | 'suspended' | 'unpaid' | 'overdue';
}

interface UseAuthReturn {
  user: AuthUser | null;
  login: (email: string, password: string) => Promise<boolean>;
  logout: () => Promise<void>;
  register: (
    email: string,
    password: string,
    fullName: string
  ) => Promise<boolean>;
  loading: boolean;
}

// ✅ Mapping ultra-rapide - fallback immédiat si pas de profil
// ✅ Version sans AbortController (plus compatible)
const mapSupabaseUser = async (user: User): Promise<AuthUser> => {
  const fallback: AuthUser = {
    id: user.id,
    email: user.email || '',
    full_name:
      user.user_metadata?.full_name || user.email?.split('@')[0] || 'User',
    role:
      user.email === 'admin@cinfob.com' || user.email === 'Admin@cinfob.com'
        ? 'admin'
        : 'user',
    payment_status: 'inactive',
  };

  try {
    // Promesse avec timeout manuel
    const profilePromise = supabase
      .from('user_profiles')
      .select('*')
      .eq('id', user.id)
      .maybeSingle();

    const timeoutPromise = new Promise((_, reject) =>
      setTimeout(() => reject(new Error('timeout')), 2000)
    );

    const { data: profile } = (await Promise.race([
      profilePromise,
      timeoutPromise,
    ])) as any;

    if (profile) {
      return {
        id: profile.id,
        email: profile.email,
        full_name: profile.full_name || fallback.full_name,
        role: profile.role,
        payment_status: profile.payment_status || 'inactive',
      };
    }

    return fallback;
  } catch (err) {
    console.warn(err);
    return fallback;
  }
};

export const useAuth = (): UseAuthReturn => {
  const [user, setUser] = useState<AuthUser | null>(null);
  const [loading, setLoading] = useState(true);

  // ✅ Init ultra-rapide - pas de timeout, juste fallback
  useEffect(() => {
    let mounted = true;

    const initAuth = async () => {
      try {
        const {
          data: { session },
        } = await supabase.auth.getSession();

        if (mounted) {
          if (session?.user) {
            const mappedUser = await mapSupabaseUser(session.user);
            setUser(mappedUser);
          }
          setLoading(false);
        }
      } catch (error) {
        console.error('Auth init error:', error);
        if (mounted) {
          setUser(null);
          setLoading(false);
        }
      }
    };

    initAuth();

    // ✅ Auth listener - mapping rapide
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange(async (event, session) => {
      if (!mounted) return;

      if (event === 'SIGNED_OUT') {
        setUser(null);
        setLoading(false);
      } else if (event === 'SIGNED_IN' && session?.user) {
        const mappedUser = await mapSupabaseUser(session.user);
        setUser(mappedUser);
        setLoading(false);
      } else if (event === 'TOKEN_REFRESHED') {
        setLoading(false);
      } else if (session?.user) {
        const mappedUser = await mapSupabaseUser(session.user);
        setUser(mappedUser);
        setLoading(false);
      } else {
        setUser(null);
        setLoading(false);
      }
    });

    return () => {
      mounted = false;
      subscription.unsubscribe();
    };
  }, []);

  // ✅ Login rapide - ne pas attendre le profil complet
  const login = async (email: string, password: string): Promise<boolean> => {
    try {
      const { data, error } = await signInWithPassword(email, password);

      if (error || !data.user) {
        return false;
      }

      // ✅ Connexion immédiate avec fallback
      const mappedUser = await mapSupabaseUser(data.user);
      setUser(mappedUser);
      setLoading(false);

      return true;
    } catch (err) {
      console.error('Login failed:', err);
      setLoading(false);
      return false;
    }
  };

  const logout = async (): Promise<void> => {
    try {
      setLoading(true);
      await signOut();
      setUser(null);
      window.location.href = '/';
    } catch (err) {
      console.error('Logout failed:', err);
    } finally {
      setLoading(false);
    }
  };

  const register = async (
    email: string,
    password: string,
    fullName: string
  ): Promise<boolean> => {
    try {
      setLoading(true);

      const { error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: { full_name: fullName },
        },
      });

      if (error) {
        setLoading(false);
        return false;
      }

      return true;
    } catch (error) {
      setLoading(false);
      return false;
    }
  };

  return {
    user,
    login,
    logout,
    register,
    loading,
  };
};
</file>

<file path="src/hooks/useClients.ts">
import { useState, useEffect, useCallback, useRef } from 'react';
import { supabase } from '../lib/supabase';
import { Client } from '../types';
import { RealtimeChannel } from '@supabase/supabase-js';
import { useAuth } from './useAuth';

export const useClients = () => {
  const { user } = useAuth();
  const [clients, setClients] = useState<Client[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // ✅ Protection contre les re-subscriptions
  const channelRef = useRef<RealtimeChannel | null>(null);
  const isSubscribedRef = useRef(false);

  // ✅ Load clients avec useCallback pour référence stable
  const loadClients = useCallback(async () => {
    try {
      setError(null);

      // Check if user is authenticated
      const {
        data: { user },
        error: authError,
      } = await supabase.auth.getUser();

      if (authError) {
        console.error('useClients: Auth error:', authError);
        setError('Non authentifié');
        setClients([]);
        setLoading(false);
        return;
      }

      if (!user) {
        setClients([]);
        setLoading(false);
        return;
      }

      const { data, error: fetchError } = await supabase
        .from('clients')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });

      if (fetchError) {
        console.error('useClients: Error loading:', fetchError);
        throw fetchError;
      }

      console.log('useClients: Loaded', data?.length || 0, 'clients');

      const formattedClients: Client[] = (data || []).map((client) => ({
        id: client.id,
        name: client.name,
        phone: client.phone,
        address: client.address,
        contactPersonName: client.contact_person_name,
        contactPersonPhone: client.contact_person_phone,
        frequency: client.frequency,
        customFrequencyDays: client.custom_frequency_days,
        notes: client.notes || '',
        createdAt: client.created_at,
      }));

      setClients(formattedClients);
      setError(null);
    } catch (err) {
      console.error('useClients: Fatal error:', err);
      setError(
        err instanceof Error
          ? err.message
          : 'Erreur lors du chargement des clients'
      );
      setClients([]);
    } finally {
      setLoading(false);
    }
  }, []); // ⚠️ Pas de dépendances

  // Add a new client
  const addClient = async (
    clientData: Omit<Client, 'id' | 'createdAt'>
  ): Promise<boolean> => {
    try {
      const {
        data: { user },
        error: authError,
      } = await supabase.auth.getUser();

      if (authError || !user) {
        console.error('useClients: Not authenticated');
        setError('Non authentifié');
        return false;
      }

      console.log('useClients: Adding client:', clientData.name);

      const { data, error: insertError } = await supabase
        .from('clients')
        .insert([
          {
            user_id: user.id,
            name: clientData.name,
            phone: clientData.phone,
            address: clientData.address,
            contact_person_name: clientData.contactPersonName,
            contact_person_phone: clientData.contactPersonPhone,
            frequency: clientData.frequency,
            custom_frequency_days: clientData.customFrequencyDays,
            notes: clientData.notes,
          },
        ])
        .select()
        .single();

      if (insertError) {
        console.error('useClients: Error adding:', insertError);
        throw insertError;
      }

      console.log('useClients: Client added successfully:', data.id);

      // Log activity (fire and forget)
      supabase
        .from('activity_logs')
        .insert([
          {
            user_id: user.id,
            action_type: 'client_added',
            entity_type: 'client',
            entity_id: data.id,
            entity_name: data.name,
            description: `Nouveau client "${data.name}" ajouté`,
          },
        ])
        .then(() => console.log('Activity logged'))
        .catch((err) => console.error('Failed to log activity:', err));

      // ⚠️ Realtime va recharger automatiquement, pas de reload manuel
      setError(null);
      return true;
    } catch (err) {
      console.error('useClients: Error in addClient:', err);
      setError(
        err instanceof Error ? err.message : "Erreur lors de l'ajout du client"
      );
      return false;
    }
  };

  // Update a client
  const updateClient = async (
    id: string,
    clientData: Partial<Client>
  ): Promise<boolean> => {
    try {
      const {
        data: { user },
        error: authError,
      } = await supabase.auth.getUser();

      if (authError || !user) {
        console.error('useClients: Not authenticated');
        setError('Non authentifié');
        return false;
      }

      console.log('useClients: Updating client:', id);

      const updateData: any = {};

      if (clientData.name !== undefined) updateData.name = clientData.name;
      if (clientData.phone !== undefined) updateData.phone = clientData.phone;
      if (clientData.address !== undefined)
        updateData.address = clientData.address;
      if (clientData.contactPersonName !== undefined)
        updateData.contact_person_name = clientData.contactPersonName;
      if (clientData.contactPersonPhone !== undefined)
        updateData.contact_person_phone = clientData.contactPersonPhone;
      if (clientData.frequency !== undefined)
        updateData.frequency = clientData.frequency;
      if (clientData.customFrequencyDays !== undefined)
        updateData.custom_frequency_days = clientData.customFrequencyDays;
      if (clientData.notes !== undefined) updateData.notes = clientData.notes;

      const { error: updateError } = await supabase
        .from('clients')
        .update(updateData)
        .eq('id', id)
        .eq('user_id', user.id);

      if (updateError) {
        console.error('useClients: Error updating:', updateError);
        throw updateError;
      }

      console.log('useClients: Client updated successfully');

      // Log activity (fire and forget)
      supabase
        .from('activity_logs')
        .insert([
          {
            user_id: user.id,
            action_type: 'client_updated',
            entity_type: 'client',
            entity_id: id,
            entity_name: clientData.name || 'Client',
            description: `Client "${clientData.name || 'Client'}" modifié`,
          },
        ])
        .then(() => console.log('Activity logged'))
        .catch((err) => console.error('Failed to log activity:', err));

      // ⚠️ Realtime va recharger automatiquement
      setError(null);
      return true;
    } catch (err) {
      console.error('useClients: Error in updateClient:', err);
      setError(
        err instanceof Error
          ? err.message
          : 'Erreur lors de la modification du client'
      );
      return false;
    }
  };

  // Delete a client
  const deleteClient = async (id: string): Promise<boolean> => {
    try {
      const {
        data: { user },
        error: authError,
      } = await supabase.auth.getUser();

      if (authError || !user) {
        console.error('useClients: Not authenticated');
        setError('Non authentifié');
        return false;
      }

      const clientToDelete = clients.find((c) => c.id === id);

      console.log('useClients: Deleting client:', id);

      const { error: deleteError } = await supabase
        .from('clients')
        .delete()
        .eq('id', id)
        .eq('user_id', user.id);

      if (deleteError) {
        console.error('useClients: Error deleting:', deleteError);
        throw deleteError;
      }

      console.log('useClients: Client deleted successfully');

      // Log activity (fire and forget)
      if (clientToDelete) {
        supabase
          .from('activity_logs')
          .insert([
            {
              user_id: user.id,
              action_type: 'client_deleted',
              entity_type: 'client',
              entity_id: id,
              entity_name: clientToDelete.name,
              description: `Client "${clientToDelete.name}" supprimé`,
            },
          ])
          .then(() => console.log('Activity logged'))
          .catch((err) => console.error('Failed to log activity:', err));
      }

      // ⚠️ Realtime va recharger automatiquement
      setError(null);
      return true;
    } catch (err) {
      console.error('useClients: Error in deleteClient:', err);
      setError(
        err instanceof Error
          ? err.message
          : 'Erreur lors de la suppression du client'
      );
      return false;
    }
  };

  // ✅ useEffect avec cleanup PROPRE
  useEffect(() => {
    if (!user) {
      console.log('useClients :no user');
      return;
    }
    console.log('useClients: Effect running...');

    // Éviter les doubles subscriptions (React StrictMode)
    if (isSubscribedRef.current) {
      console.log('useClients: Already subscribed, skipping');
      return;
    }

    let mounted = true;

    const setupSubscriptions = async () => {
      // Chargement initial
      if (mounted) {
        await loadClients();
      }

      // Vérifier l'auth
      const {
        data: { user },
      } = await supabase.auth.getUser();

      if (!user || !mounted) {
        console.log('useClients: No user or unmounted, skipping subscription');
        return;
      }

      // ✅ Configuration Realtime avec filter
      console.log('useClients: Setting up Realtime subscription');

      channelRef.current = supabase
        .channel(`clients-${user.id}`) // Channel unique par user
        .on(
          'postgres_changes',
          {
            event: '*',
            schema: 'public',
            table: 'clients',
            filter: `user_id=eq.${user.id}`,
          },
          (payload) => {
            console.log('useClients: Realtime event:', payload.eventType);
            if (mounted) {
              loadClients();
            }
          }
        )
        .subscribe((status) => {
          console.log('useClients: Subscription status:', status);
          if (status === 'SUBSCRIBED') {
            isSubscribedRef.current = true;
          }
        });
    };

    setupSubscriptions();

    // ✅ CLEANUP CRUCIAL
    return () => {
      console.log('useClients: Cleaning up...');
      mounted = false;
      isSubscribedRef.current = false;

      if (channelRef.current) {
        console.log('useClients: Unsubscribing channel');
        supabase.removeChannel(channelRef.current);
        channelRef.current = null;
      }
    };
  }, [user]); // ⚠️ Tableau vide

  return {
    clients,
    loading,
    error,
    addClient,
    updateClient,
    deleteClient,
    refreshClients: loadClients,
  };
};
</file>

<file path="src/hooks/useExpenses.ts">
import { useState, useEffect } from 'react';
import { supabase } from '../lib/supabase';

export type ExpenseCategory =
  | 'supplies'
  | 'equipment'
  | 'transportation'
  | 'utilities'
  | 'services'
  | 'other';

export interface Expense {
  id: string;
  user_id: string;
  description: string;
  amount: number;
  category: ExpenseCategory;
  date: string;
  created_at: string;
  updated_at: string;
}

interface UseExpensesReturn {
  expenses: Expense[];
  loading: boolean;
  error: string | null;
  addExpense: (
    expense: Omit<Expense, 'id' | 'user_id' | 'created_at' | 'updated_at'>
  ) => Promise<boolean>;
  updateExpense: (
    id: string,
    updates: Partial<
      Omit<Expense, 'id' | 'user_id' | 'created_at' | 'updated_at'>
    >
  ) => Promise<boolean>;
  deleteExpense: (id: string) => Promise<boolean>;
  getTotalExpenses: (category?: ExpenseCategory) => number;
  getExpensesByCategory: () => Record<ExpenseCategory, number>;
}

export const useExpenses = (): UseExpensesReturn => {
  const [expenses, setExpenses] = useState<Expense[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const loadExpenses = async () => {
    try {
      setLoading(true);
      setError(null);

      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) {
        setExpenses([]);
        return;
      }

      const { data, error: queryError } = await supabase
        .from('expenses')
        .select('*')
        .eq('user_id', user.id)
        .order('date', { ascending: false });

      if (queryError) {
        setError(queryError.message);
      } else {
        setExpenses(data || []);
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Error loading expenses');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadExpenses();
  }, []);

  useEffect(() => {
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((event) => {
      if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
        loadExpenses();
      }
    });

    return () => {
      subscription.unsubscribe();
    };
  }, []);

  const addExpense = async (
    expense: Omit<Expense, 'id' | 'user_id' | 'created_at' | 'updated_at'>
  ): Promise<boolean> => {
    try {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) return false;

      const { error: insertError } = await supabase
        .from('expenses')
        .insert([{ ...expense, user_id: user.id }]);

      if (insertError) {
        setError(insertError.message);
        return false;
      }

      await loadExpenses();
      return true;
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Error adding expense');
      return false;
    }
  };

  const updateExpense = async (
    id: string,
    updates: Partial<
      Omit<Expense, 'id' | 'user_id' | 'created_at' | 'updated_at'>
    >
  ): Promise<boolean> => {
    try {
      const { error: updateError } = await supabase
        .from('expenses')
        .update(updates)
        .eq('id', id);

      if (updateError) {
        setError(updateError.message);
        return false;
      }

      await loadExpenses();
      return true;
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Error updating expense');
      return false;
    }
  };

  const deleteExpense = async (id: string): Promise<boolean> => {
    try {
      const {
        data: { user },
        error: authError,
      } = await supabase.auth.getUser();
      if (authError || !user) {
        setError('Non authentifié');
        return false;
      }

      const { error: deleteError } = await supabase
        .from('expenses')
        .delete()
        .eq('id', id)
        .eq('user_id', user.id);

      if (deleteError) throw deleteError;

      // 🆕 MISE À JOUR OPTIMISTE
      setExpenses((prev) => prev.filter((exp) => exp.id !== id));

      setError(null);
      return true;
    } catch (err) {
      console.error('Error deleting expense:', err);
      setError('Erreur lors de la suppression de la dépense');
      return false;
    }
  };

  const getTotalExpenses = (category?: ExpenseCategory): number => {
    return expenses
      .filter((exp) => !category || exp.category === category)
      .reduce((sum, exp) => sum + Number(exp.amount), 0);
  };

  const getExpensesByCategory = (): Record<ExpenseCategory, number> => {
    const categories: Record<ExpenseCategory, number> = {
      supplies: 0,
      equipment: 0,
      transportation: 0,
      utilities: 0,
      services: 0,
      other: 0,
    };

    expenses.forEach((exp) => {
      categories[exp.category] += Number(exp.amount);
    });

    return categories;
  };

  return {
    expenses,
    loading,
    error,
    addExpense,
    updateExpense,
    deleteExpense,
    getTotalExpenses,
    getExpensesByCategory,
  };
};
</file>

<file path="src/hooks/usePreferences.ts">
import { useState, useEffect } from 'react';
import { supabase } from '../lib/supabase';

export interface FrequencyOption {
  value: string;
  label: string;
  days: number;
}

export interface ExpenseCategory {
  value: string;
  label: string;
}

export interface UserPreferences {
  id: string;
  user_id: string;
  min_time_between_appointments: number;
  business_hours_start: string;
  business_hours_end: string;
  frequency_options: FrequencyOption[];
  expense_categories: ExpenseCategory[];
  notification_days_before: number;
  created_at: string;
  updated_at: string;
}

export const usePreferences = () => {
  const [preferences, setPreferences] = useState<UserPreferences | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Charger les paramètres
  const fetchSettings = async () => {
    try {
      setLoading(true);
      setError(null);

      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) throw new Error('Non authentifié');

      const { data, error: fetchError } = await supabase
        .from('user_settings')
        .select('*')
        .eq('user_id', user.id)
        .single();

      if (fetchError && fetchError.code !== 'PGRST116') {
        throw fetchError;
      }

      setPreferences(data);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Erreur de chargement');
    } finally {
      setLoading(false);
    }
  };

  // Créer les paramètres par défaut
  const createDefaultPreferences = async (): Promise<boolean> => {
    try {
      setError(null);

      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) throw new Error('Non authentifié');

      const defaultSettings = {
        user_id: user.id,
        min_time_between_appointments: 90,
        business_hours_start: '08:00:00',
        business_hours_end: '18:00:00',
        frequency_options: [
          { value: 'weekly', label: 'Hebdomadaire', days: 7 },
          { value: 'biweekly', label: 'Bi-hebdomadaire', days: 14 },
          { value: 'monthly', label: 'Mensuel', days: 30 },
          { value: 'quarterly', label: 'Trimestriel', days: 90 },
          { value: 'custom', label: 'Personnalisé', days: 0 },
        ],
        expense_categories: [
          { value: 'supplies', label: 'Fournitures' },
          { value: 'equipment', label: 'Équipement' },
          { value: 'transportation', label: 'Transport' },
          { value: 'utilities', label: 'Services' },
          { value: 'services', label: 'Prestataires' },
          { value: 'other', label: 'Autre' },
        ],
        notification_days_before: 7,
      };

      const { data, error: insertError } = await supabase
        .from('user_settings')
        .insert(defaultSettings)
        .select()
        .single();

      if (insertError) throw insertError;

      setPreferences(data);
      return true;
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Erreur de création');
      return false;
    }
  };

  // Mettre à jour les paramètres
  const updatePreferences = async (
    updates: Partial<
      Omit<UserPreferences, 'id' | 'user_id' | 'created_at' | 'updated_at'>
    >
  ): Promise<boolean> => {
    try {
      setError(null);

      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) throw new Error('Non authentifié');

      const { data, error: updateError } = await supabase
        .from('user_settings')
        .update(updates)
        .eq('user_id', user.id)
        .select()
        .single();

      if (updateError) throw updateError;

      setPreferences(data);
      return true;
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Erreur de mise à jour');
      return false;
    }
  };

  // Vérifier si les paramètres existent
  const preferencesExist = async (): Promise<boolean> => {
    try {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) return false;

      const { data, error: fetchError } = await supabase
        .from('user_settings')
        .select('id')
        .eq('user_id', user.id)
        .single();

      if (fetchError && fetchError.code !== 'PGRST116') {
        throw fetchError;
      }

      return !!data;
    } catch (err) {
      console.error('Erreur de vérification:', err);
      return false;
    }
  };

  useEffect(() => {
    fetchSettings();
  }, []);

  return {
    preferences,
    loading,
    error,
    fetchPreferences: fetchSettings,
    createDefaultPreferences,
    updatePreferences,
    preferencesExist,
  };
};
</file>

<file path="src/hooks/useServices.ts">
import { useState, useEffect } from 'react';
import { supabase } from '../lib/supabase';
import { Service } from '../types';

export const useServices = () => {
  const [services, setServices] = useState<Service[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Load services from Supabase
  const loadServices = async () => {
    try {
      setLoading(true);
      setError(null);
      const { data, error } = await supabase
        .from('services')
        .select('*')
        .order('created_at', { ascending: true });

      if (error) throw error;

      const formattedServices: Service[] = data.map(service => ({
        id: service.id,
        name: service.name,
        createdAt: service.created_at
      }));

      setServices(formattedServices);
    } catch (err) {
      console.error('Error loading services:', err);
      setError(err instanceof Error ? err.message : 'Erreur lors du chargement des services');
      setServices([]);
    } finally {
      setLoading(false);
    }
  };

  // Add a new service
  const addService = async (serviceName: string): Promise<boolean> => {
    try {
      const { data, error } = await supabase
        .from('services')
        .insert([{ name: serviceName.trim() }])
        .select()
        .single();

      if (error) {
        if (error.code === '23505') { // Unique constraint violation
          setError('Ce service existe déjà');
          return false;
        }
        throw error;
      }

      const newService: Service = {
        id: data.id,
        name: data.name,
        createdAt: data.created_at
      };

      setServices(prev => [...prev, newService]);
      setError(null);
      return true;
    } catch (err) {
      console.error('Error adding service:', err);
      setError(err instanceof Error ? err.message : 'Erreur lors de l\'ajout du service');
      return false;
    }
  };

  // Delete a service
  const deleteService = async (serviceId: string): Promise<boolean> => {
    try {
      const { error } = await supabase
        .from('services')
        .delete()
        .eq('id', serviceId);

      if (error) throw error;

      setServices(prev => prev.filter(service => service.id !== serviceId));
      setError(null);
      return true;
    } catch (err) {
      console.error('Error deleting service:', err);
      setError(err instanceof Error ? err.message : 'Erreur lors de la suppression du service');
      return false;
    }
  };

  // Update a service
  const updateService = async (serviceId: string, serviceName: string): Promise<boolean> => {
    try {
      const { error } = await supabase
        .from('services')
        .update({ 
          name: serviceName.trim(),
          updated_at: new Date().toISOString()
        })
        .eq('id', serviceId);

      if (error) {
        if (error.code === '23505') { // Unique constraint violation
          setError('Ce service existe déjà');
          return false;
        }
        throw error;
      }

      setServices(prev => prev.map(service => 
        service.id === serviceId 
          ? { ...service, name: serviceName.trim() }
          : service
      ));
      setError(null);
      return true;
    } catch (err) {
      console.error('Error updating service:', err);
      setError(err instanceof Error ? err.message : 'Erreur lors de la modification du service');
      return false;
    }
  };

  useEffect(() => {
    loadServices();
  }, []);

  return {
    services,
    loading,
    error,
    addService,
    deleteService,
    updateService,
    refreshServices: loadServices
  };
};
</file>

<file path="src/hooks/useToast.ts">
import { useState, useCallback } from 'react';
import { Toast, ToastType } from '../types/toast';

export const useToast = () => {
  const [toasts, setToasts] = useState<Toast[]>([]);

  const showToast = useCallback(
    (type: ToastType, message: string, duration: number = 4000) => {
      const id = `toast-${Date.now()}-${Math.random()}`;
      const newToast: Toast = { id, type, message, duration };

      setToasts((prev) => [...prev, newToast]);
    },
    []
  );

  const removeToast = useCallback((id: string) => {
    setToasts((prev) => prev.filter((toast) => toast.id !== id));
  }, []);

  return {
    toasts,
    showToast,
    removeToast,
  };
};
</file>

<file path="src/lib/supabase.ts">
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Missing Supabase environment variables');
}

// ✅ Configuration CORRIGÉE avec persistance de session
export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: true,        // ✅ Active la persistance
    autoRefreshToken: true,       // ✅ Rafraîchit automatiquement le token
    detectSessionInUrl: true,     // ✅ Détecte les sessions dans l'URL
    storage: localStorage,        // ✅ Utilise localStorage
    storageKey: 'supabase.auth.token', // Clé de stockage personnalisée (optionnel)
  },
});

// Authentication functions
export const signInWithPassword = async (email: string, password: string) => {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  });
  return { data, error };
};

export const signUp = async (email: string, password: string) => {
  const { data, error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      data: {
        full_name: email === 'admin@company.com' ? 'Admin User' : 'User',
      },
    },
  });
  return { data, error };
};

export const signOut = async () => {
  const { error } = await supabase.auth.signOut();
  
  // Nettoyer UNIQUEMENT le cache applicatif, pas tout le localStorage
  sessionStorage.clear();
  
  return { error };
};

export const getCurrentUser = async () => {
  const {
    data: { user },
    error,
  } = await supabase.auth.getUser();
  return { user, error };
};

export const getSession = async () => {
  const {
    data: { session },
    error,
  } = await supabase.auth.getSession();
  return { session, error };
};

// Helper function to create admin user
export const createUserWithEmailAndPassword = async (
  email: string,
  password: string
) => {
  return await signUp(email, password);
};

export type Database = {
  public: {
    Tables: {
      user_profiles: {
        Row: {
          id: string;
          email: string;
          full_name: string;
          role: 'admin' | 'user';
          created_at: string;
          updated_at: string;
        };
        Insert: {
          id: string;
          email: string;
          full_name: string;
          role?: 'admin' | 'user';
          created_at?: string;
          updated_at?: string;
        };
        Update: {
          id?: string;
          email?: string;
          full_name?: string;
          role?: 'admin' | 'user';
          created_at?: string;
          updated_at?: string;
        };
      };
      services: {
        Row: {
          id: string;
          name: string;
          created_at: string;
          updated_at: string;
        };
        Insert: {
          id?: string;
          name: string;
          created_at?: string;
          updated_at?: string;
        };
        Update: {
          id?: string;
          name?: string;
          created_at?: string;
          updated_at?: string;
        };
      };
      clients: {
        Row: {
          id: string;
          user_id: string;
          name: string;
          phone: string;
          address: string;
          contact_person_name: string;
          contact_person_phone: string;
          frequency: 'weekly' | 'biweekly' | 'monthly' | 'quarterly' | 'custom';
          custom_frequency_days: number | null;
          notes: string | null;
          created_at: string;
          updated_at: string;
        };
        Insert: {
          id?: string;
          user_id: string;
          name: string;
          phone: string;
          address: string;
          contact_person_name: string;
          contact_person_phone: string;
          frequency?: 'weekly' | 'biweekly' | 'monthly' | 'quarterly' | 'custom';
          custom_frequency_days?: number | null;
          notes?: string | null;
          created_at?: string;
          updated_at?: string;
        };
        Update: {
          id?: string;
          user_id?: string;
          name?: string;
          phone?: string;
          address?: string;
          contact_person_name?: string;
          contact_person_phone?: string;
          frequency?: 'weekly' | 'biweekly' | 'monthly' | 'quarterly' | 'custom';
          custom_frequency_days?: number | null;
          notes?: string | null;
          created_at?: string;
          updated_at?: string;
        };
      };
      appointments: {
        Row: {
          id: string;
          user_id: string;
          client_id: string;
          service_id: string | null;
          date: string;
          time: string;
          duration: number;
          status: 'scheduled' | 'completed' | 'cancelled';
          notes: string | null;
          price: number | null;
          created_at: string;
          updated_at: string;
        };
        Insert: {
          id?: string;
          user_id: string;
          client_id: string;
          service_id?: string | null;
          date: string;
          time: string;
          duration?: number;
          status?: 'scheduled' | 'completed' | 'cancelled';
          notes?: string | null;
          price?: number | null;
          created_at?: string;
          updated_at?: string;
        };
        Update: {
          id?: string;
          user_id?: string;
          client_id?: string;
          service_id?: string | null;
          date?: string;
          time?: string;
          duration?: number;
          status?: 'scheduled' | 'completed' | 'cancelled';
          notes?: string | null;
          price?: number | null;
          created_at?: string;
          updated_at?: string;
        };
      };
    };
  };
};
</file>

<file path="src/pages/loginPage.tsx">
import React from 'react';
import { Navigate } from 'react-router-dom';
import { useAuth } from '../hooks/useAuth';
import LoginForm from '../components/LoginForm';

const LoginPage: React.FC = () => {
  // Assurez-vous que votre useAuth retourne bien une fonction 'register'
  // Sinon, voir l'étape 3 ci-dessous
  const { user, login, register, loading } = useAuth();

  // Si l'utilisateur est déjà connecté, redirection vers le dashboard
  if (user) {
    return <Navigate to="/dashboard" replace />;
  }

  return <LoginForm onLogin={login} onRegister={register} loading={loading} />;
};

export default LoginPage;
</file>

<file path="src/types/index.ts">
export interface User {
  id: string;
  email: string;
  full_name: string;
  role: string;
}

export interface UserProfile {
  id: string;
  email: string;
  full_name?: string;
  role: 'admin' | 'user';
  payment_status: 'active' | 'inactive' | 'suspended' | 'unpaid' | 'overdue';
  subscription_status: 'basic' | 'pro' | 'enterprise';
  created_at: string;
  updated_at: string;
}

export interface Passkey {
  id: string;
  user_id: string;
  name: string;
  credential_id: string;
  public_key: string;
  created_at: string;
}

export interface Client {
  id: string;
  name: string;
  phone: string;
  address: string;
  contactPersonName: string;
  contactPersonPhone: string;
  frequency: 'weekly' | 'biweekly' | 'monthly' | 'quarterly' | 'custom';
  customFrequencyDays?: number;
  createdAt: string;
  notes?: string;
}

export interface Appointment {
  id: string;
  clientId: string;
  clientName: string;
  service: string;
  notes: string;
  date: string;
  time: string;
  duration: number;
  status: 'scheduled' | 'completed' | 'cancelled';
  price?: number;
}

export interface Service {
  id: string;
  name: string;
  createdAt: string;
}

export interface NotificationItem {
  id: string;
  clientId: string;
  clientName: string;
  type: 'monthly_reminder';
  message: string;
  lastAppointment: string;
  createdAt: string;
  read: boolean;
  isFirstAppointmentReminder: boolean;
}

export interface ClientListProps {
  clients: Client[];
  appointments: Appointment[];
  onAddClient: (client: Omit<Client, 'id' | 'createdAt'>) => void;
  onUpdateClient: (id: string, client: Partial<Client>) => void;
  onDeleteClient: (id: string) => void;
}
</file>

<file path="src/types/toast.ts">
export type ToastType = 'success' | 'error' | 'warning' | 'info';

export interface Toast {
  id: string;
  type: ToastType;
  message: string;
  duration?: number;
}

export type ShowToastFunction = (
  type: ToastType,
  message: string,
  duration?: number
) => void;
</file>

<file path="src/utils/statistics.ts">
import { Appointment } from '../types';

export interface DashboardStats {
  totalClients: number;
  todayAppointments: number;
  weekAppointments: number;
  totalRevenue: number;
  clientsChange: number;
  appointmentsChange: number;
  weekChange: number;
  revenueChange: number;
}

export const calculateDashboardStats = (
  clientsCount: number,
  todayAppointments: number,
  thisWeekAppointments: number,
  appointments: Appointment[]
): DashboardStats => {
  const completedAppointments = appointments.filter(apt => apt.status === 'completed');
  const totalRevenue = completedAppointments.reduce((sum, apt) => sum + (apt.price || 0), 0);

  const today = new Date();
  const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());

  const lastMonthAppointments = completedAppointments.filter(apt => {
    const aptDate = new Date(apt.date);
    return aptDate >= lastMonth && aptDate <= today;
  });

  const lastMonthRevenue = lastMonthAppointments.reduce((sum, apt) => sum + (apt.price || 0), 0);

  const calculateChange = (current: number, previous: number): number => {
    if (previous === 0) return current > 0 ? 100 : 0;
    return Math.round(((current - previous) / previous) * 100);
  };

  const previousMonthStart = new Date(lastMonth.getFullYear(), lastMonth.getMonth() - 1, lastMonth.getDate());
  const previousMonthAppointments = completedAppointments.filter(apt => {
    const aptDate = new Date(apt.date);
    return aptDate >= previousMonthStart && aptDate < lastMonth;
  });

  const appointmentsChange = calculateChange(
    lastMonthAppointments.length,
    previousMonthAppointments.length
  );

  const previousMonthRevenue = previousMonthAppointments.reduce((sum, apt) => sum + (apt.price || 0), 0);
  const revenueChange = calculateChange(lastMonthRevenue, previousMonthRevenue);

  const lastMonthClients = appointments.filter(apt => {
    const aptDate = new Date(apt.date);
    return aptDate >= lastMonth && aptDate <= today;
  }).length;

  const previousMonthClients = appointments.filter(apt => {
    const aptDate = new Date(apt.date);
    return aptDate >= previousMonthStart && aptDate < lastMonth;
  }).length;

  const clientsChange = calculateChange(lastMonthClients, previousMonthClients);
  const weekChange = calculateChange(thisWeekAppointments, Math.ceil(thisWeekAppointments * 0.8));

  return {
    totalClients: clientsCount,
    todayAppointments,
    weekAppointments: thisWeekAppointments,
    totalRevenue,
    clientsChange: clientsChange > 0 ? clientsChange : Math.abs(clientsChange),
    appointmentsChange: appointmentsChange > 0 ? appointmentsChange : Math.abs(appointmentsChange),
    weekChange: weekChange > 0 ? weekChange : Math.abs(weekChange),
    revenueChange: revenueChange > 0 ? revenueChange : Math.abs(revenueChange),
  };
};

export const formatCurrency = (value: number): string => {
  return new Intl.NumberFormat('fr-FR', {
    style: 'currency',
    currency: 'EUR',
  }).format(value);
};
</file>

<file path="src/App.tsx">
import React, { useState, useEffect } from 'react';

// --- IMPORTS DES HOOKS ---
import { useAuth } from './hooks/useAuth';
import { useClients } from './hooks/useClients';
import { useAppointments } from './hooks/useAppointments';
import { usePreferences } from './hooks/usePreferences';

// --- IMPORTS DES COMPOSANTS ---
import LoginForm from './components/LoginForm';
import Sidebar from './components/Layout/Sidebar';
import Dashboard from './components/Dashboard/Dashboard';
import MyDay from './components/MyDay/MyDay';
import Calendar from './components/Calendar/Calendar';
import ClientList from './components/Clients/ClientList';
import Notifications from './components/Notifications/Notifications';
import UserManagement from './components/Users/UserManagement';
import Settings from './components/Settings/Settings';
import Preferences from './components/Preferences/Preferences';
import { Expenses } from './components/Expenses/Expenses';
import Analytics from './components/Analytics/Analytics';
import AdminDashboard from './components/Admin/AdminDashboard';
import PaymentWarningModal from './components/Payment/PaymentWarningModal';
import { useToast } from './hooks/useToast';
import ToastContainer from './components/Toast/ToastContainer';
import { ShowToastFunction } from './types/toast';
import { useNotificationGenerator } from './hooks/useNotificationGenerator';

// --- TYPES ---
type ViewType =
  | 'dashboard'
  | 'myday'
  | 'notifications'
  | 'calendar'
  | 'clients'
  | 'expenses'
  | 'analytics'
  | 'users'
  | 'settings'
  | 'preferences'
  | 'admin-payments';

function App() {
  // 1. Authentification & Préférences
  const { user, login, logout, register, loading: authLoading } = useAuth();
  const { preferencesExist } = usePreferences();
  const [appReady, setAppReady] = useState(false);

  // 2. Données métier - ✅ TOUJOURS APPELER LES HOOKS
  const { clients, addClient, updateClient, deleteClient, refreshClients, loading: clientsLoading } =
    useClients();
  const { appointments, addAppointment, updateAppointment, deleteAppointment, loading: appointmentsLoading } =
    useAppointments();

  const isDataLoading = (clientsLoading || appointmentsLoading) || (clients.length > 0 && appointments.length === 0);

  // 4. On passe "isDataLoading" au générateur
  useNotificationGenerator(appointments, clients, isDataLoading);
  
  // 3. États de l'interface
  const [currentView, setCurrentView] = useState<ViewType>('dashboard');
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);

  const { toasts, showToast, removeToast } = useToast();

  // --- LOGIQUE : AUTO-REFRESH (Visibility API) ---
  useEffect(() => {
    const checkReload = () => {
      const needsReload = sessionStorage.getItem('needs_refresh');
      if (needsReload === 'true') {
        sessionStorage.removeItem('needs_refresh');
        window.location.reload();
      }
    };
    const markAsLeft = () => sessionStorage.setItem('needs_refresh', 'true');

    const handleVisibilityChange = () => {
      document.visibilityState === 'hidden' ? markAsLeft() : checkReload();
    };

    window.addEventListener('blur', markAsLeft);
    window.addEventListener('focus', checkReload);
    document.addEventListener('visibilitychange', handleVisibilityChange);

    return () => {
      window.removeEventListener('blur', markAsLeft);
      window.removeEventListener('focus', checkReload);
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, []);

  // --- LOGIQUE : VÉRIFICATION DES PRÉFÉRENCES (CORRIGÉE) ---
  // ✅ REMPLACER PAR :
  useEffect(() => {
    console.log('🔍 Preferences check START', { hasUser: !!user });

    const checkUserPreferences = async () => {
      if (!user) {
        console.log('✅ No user, app ready');
        setAppReady(true);
        return;
      }

      if (user.role === 'admin') {
        console.log('✅ Admin user, app ready');
        setAppReady(true);
        if (window.location.pathname === '/') {
          window.history.pushState({}, '', '/dashboard');
        }
        return;
      }

      console.log('🔍 Checking preferences for user...');
      // ... reste du code

      setAppReady(true);
      console.log('✅ App ready after preferences check');
    };

    checkUserPreferences();
  }, [user, preferencesExist]);

  const toggleMenu = () => setIsSidebarOpen(!isSidebarOpen);

  const handleTabChange = (view: string) => {
    if (view === 'clients') refreshClients();
    setCurrentView(view as ViewType);
    if (window.innerWidth < 1024) setIsSidebarOpen(false);
  };

  // --- RENDU : CHARGEMENT ---
  if (authLoading || !appReady) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center">
        <div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
      </div>
    );
  }

  // --- RENDU : LOGIN ---
  if (!user) {
    return (
      <LoginForm onLogin={login} onRegister={register} loading={authLoading} />
    );
  }

  // --- RENDU : BLOCAGE PAIEMENT ---
  if (
    user.role !== 'admin' &&
    ['unpaid', 'overdue', 'suspended', 'inactive'].includes(
      user.payment_status || ''
    )
  ) {
    return (
      <PaymentWarningModal
        isOpen={true}
        onClose={() => {}}
        userStatus={user.payment_status as any}
        daysRemaining={0}
        onUpgrade={(plan) => console.log('Upgrade requested:', plan)}
        userName={user.full_name || user.email}
        onLogout={logout}
      />
    );
  }

  // --- ROUTAGE DU CONTENU ---
  const renderMainContent = () => {
    const commonProps = { onMenuToggle: toggleMenu, showToast };
    const dataProps = { clients, appointments };

    switch (currentView) {
      case 'dashboard':
        return (
          <Dashboard
            user={user}
            {...dataProps}
            onNavigate={setCurrentView}
            {...commonProps}
          />
        );
      case 'myday':
        return (
          <MyDay
            {...dataProps}
            {...commonProps}
            onUpdateAppointment={updateAppointment}
          />
        );
      case 'calendar':
        return (
          <Calendar
            {...dataProps}
            onAddAppointment={addAppointment}
            onUpdateAppointment={updateAppointment}
            onDeleteAppointment={deleteAppointment}
            {...commonProps}
          />
        );
      case 'clients':
        return (
          <ClientList
            {...dataProps}
            onAddClient={addClient}
            onUpdateClient={updateClient}
            onDeleteClient={deleteClient}
            {...commonProps}
          />
        );
      case 'notifications':
        return (
          <Notifications
            {...dataProps}
            onAddAppointment={addAppointment}
            {...commonProps}
          />
        );
      case 'expenses':
        return <Expenses {...commonProps} />;
      case 'analytics':
        return <Analytics {...commonProps} />;
      case 'preferences':
        return <Preferences />;
      case 'admin-payments':
        return user.role === 'admin' ? (
          <AdminDashboard onLogout={logout} />
        ) : (
          <Dashboard user={user} {...dataProps} {...commonProps} />
        );
      case 'users':
        return user.role === 'admin' ? (
          <UserManagement {...commonProps} />
        ) : (
          <Dashboard user={user} {...dataProps} {...commonProps} />
        );
      case 'settings':
  return <Settings {...commonProps} onNavigate={(view) => setCurrentView(view as ViewType)} />;
      
      default:
        return <Dashboard user={user} {...dataProps} {...commonProps} />;
    }
  };

  return (
    <div className="flex min-h-screen bg-gray-100 relative overflow-hidden">
      <ToastContainer toasts={toasts} onRemove={removeToast} />
      {currentView !== 'preferences' && (
        <Sidebar
          activeTab={currentView}
          onTabChange={handleTabChange}
          onLogout={logout}
          userName={user.full_name || user.email}
          userRole={user.role || 'user'}
          isOpen={isSidebarOpen}
          onToggle={toggleMenu}
        />
      )}

      <main
        className={`flex-1 flex flex-col min-w-0 h-screen overflow-hidden relative ${
          currentView === 'preferences' ? 'w-full' : ''
        }`}
      >
        <div className="flex-1 overflow-auto bg-gray-50">
          {renderMainContent()}
        </div>
      </main>
    </div>
  );
}

export default App;
</file>

<file path="src/index.css">
@tailwind base;
@tailwind components;
@tailwind utilities;
</file>

<file path="src/index.tsx">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Application Web d'Outils Internes</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
</file>

<file path="src/main.tsx">
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import './index.css';

const rootElement = document.getElementById('root');
if (rootElement) {
  const root = ReactDOM.createRoot(rootElement);
  root.render(
    <React.StrictMode>
      <App />
    </React.StrictMode>
  );
}
</file>

<file path="src/vite-env.d.ts">
/// <reference types="vite/client" />
</file>

<file path="supabase/migrations/20250803171015_misty_cliff.sql">
/*
  # Create services table with proper RLS policies

  1. New Tables
    - `services`
      - `id` (uuid, primary key)
      - `name` (text, unique)
      - `created_at` (timestamp)
      - `updated_at` (timestamp)

  2. Security
    - Enable RLS on `services` table
    - Add policies for anonymous users to perform CRUD operations
    - This allows the app to work without requiring Supabase authentication

  3. Initial Data
    - Insert default services in French
*/

-- Create the services table
CREATE TABLE IF NOT EXISTS services (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text UNIQUE NOT NULL,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- Enable Row Level Security
ALTER TABLE services ENABLE ROW LEVEL SECURITY;

-- Create policies for anonymous users (for demo purposes)
-- In production, you would typically require authentication

-- Allow anonymous users to read all services
CREATE POLICY "Allow anonymous users to read services"
  ON services
  FOR SELECT
  TO anon
  USING (true);

-- Allow anonymous users to insert services
CREATE POLICY "Allow anonymous users to insert services"
  ON services
  FOR INSERT
  TO anon
  WITH CHECK (true);

-- Allow anonymous users to update services
CREATE POLICY "Allow anonymous users to update services"
  ON services
  FOR UPDATE
  TO anon
  USING (true)
  WITH CHECK (true);

-- Allow anonymous users to delete services
CREATE POLICY "Allow anonymous users to delete services"
  ON services
  FOR DELETE
  TO anon
  USING (true);

-- Insert default services in French
INSERT INTO services (name) VALUES
  ('Consultation'),
  ('Réunion de suivi'),
  ('Révision de projet'),
  ('Session de stratégie'),
  ('Session de formation')
ON CONFLICT (name) DO NOTHING;
</file>

<file path="supabase/migrations/20250907175927_broad_heart.sql">
/*
  # Complete Application Schema Setup

  1. New Tables
    - `user_profiles` - User information with roles and metadata
    - `clients` - Client information with contact details and service frequency
    - `appointments` - Appointment scheduling with client and service relationships

  2. Security
    - Enable RLS on all tables
    - Add policies for user data isolation
    - Admin users can access all data
    - Regular users can only access their own data

  3. Relationships
    - appointments.client_id → clients.id
    - appointments.service_id → services.id
    - appointments.user_id → user_profiles.id
    - clients.user_id → user_profiles.id

  4. Triggers
    - Auto-create user profile on auth signup
    - Auto-update timestamps
*/

-- Create user_profiles table
CREATE TABLE IF NOT EXISTS user_profiles (
  id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email text UNIQUE NOT NULL,
  full_name text NOT NULL DEFAULT '',
  role text NOT NULL DEFAULT 'user' CHECK (role IN ('admin', 'user')),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- Create clients table
CREATE TABLE IF NOT EXISTS clients (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  name text NOT NULL,
  phone text NOT NULL,
  address text NOT NULL,
  contact_person_name text NOT NULL,
  contact_person_phone text NOT NULL,
  frequency text NOT NULL DEFAULT 'monthly' CHECK (frequency IN ('weekly', 'biweekly', 'monthly', 'quarterly', 'custom')),
  custom_frequency_days integer,
  notes text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- Create appointments table
CREATE TABLE IF NOT EXISTS appointments (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  client_id uuid NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  service_id uuid REFERENCES services(id) ON DELETE SET NULL,
  date date NOT NULL,
  time time NOT NULL,
  duration integer NOT NULL DEFAULT 60,
  status text NOT NULL DEFAULT 'scheduled' CHECK (status IN ('scheduled', 'completed', 'cancelled')),
  notes text,
  price decimal(10,2),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- Enable RLS on all tables
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE clients ENABLE ROW LEVEL SECURITY;
ALTER TABLE appointments ENABLE ROW LEVEL SECURITY;

-- User profiles policies
CREATE POLICY "Users can read own profile"
  ON user_profiles
  FOR SELECT
  TO authenticated
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON user_profiles
  FOR UPDATE
  TO authenticated
  USING (auth.uid() = id);

CREATE POLICY "Admins can read all profiles"
  ON user_profiles
  FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

CREATE POLICY "Admins can update all profiles"
  ON user_profiles
  FOR UPDATE
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

CREATE POLICY "Allow profile creation"
  ON user_profiles
  FOR INSERT
  TO authenticated
  WITH CHECK (auth.uid() = id);

-- Clients policies
CREATE POLICY "Users can read own clients"
  ON clients
  FOR SELECT
  TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own clients"
  ON clients
  FOR INSERT
  TO authenticated
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own clients"
  ON clients
  FOR UPDATE
  TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own clients"
  ON clients
  FOR DELETE
  TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Admins can read all clients"
  ON clients
  FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

CREATE POLICY "Admins can manage all clients"
  ON clients
  FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

-- Appointments policies
CREATE POLICY "Users can read own appointments"
  ON appointments
  FOR SELECT
  TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own appointments"
  ON appointments
  FOR INSERT
  TO authenticated
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own appointments"
  ON appointments
  FOR UPDATE
  TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own appointments"
  ON appointments
  FOR DELETE
  TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Admins can read all appointments"
  ON appointments
  FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

CREATE POLICY "Admins can manage all appointments"
  ON appointments
  FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

-- Function to handle user profile creation
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO user_profiles (id, email, full_name, role)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'full_name', NEW.email),
    CASE 
      WHEN NEW.email = 'admin@company.com' THEN 'admin'
      ELSE 'user'
    END
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger to create user profile on signup
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION handle_new_user();

-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS trigger AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Triggers for updated_at
CREATE TRIGGER update_user_profiles_updated_at
  BEFORE UPDATE ON user_profiles
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_clients_updated_at
  BEFORE UPDATE ON clients
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_appointments_updated_at
  BEFORE UPDATE ON appointments
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Create indexes for better performance
CREATE INDEX IF NOT EXISTS idx_clients_user_id ON clients(user_id);
CREATE INDEX IF NOT EXISTS idx_appointments_user_id ON appointments(user_id);
CREATE INDEX IF NOT EXISTS idx_appointments_client_id ON appointments(client_id);
CREATE INDEX IF NOT EXISTS idx_appointments_date ON appointments(date);
CREATE INDEX IF NOT EXISTS idx_appointments_status ON appointments(status);
</file>

<file path="supabase/migrations/20251116030201_20250802123729_dusty_water.sql">
/*
  # Create services table

  1. New Tables
    - `services`
      - `id` (uuid, primary key)
      - `name` (text, unique)
      - `created_at` (timestamp)
      - `updated_at` (timestamp)

  2. Security
    - Enable RLS on `services` table
    - Add policy for authenticated users to read all services
    - Add policy for authenticated users to insert services
    - Add policy for authenticated users to update services
    - Add policy for authenticated users to delete services

  3. Initial Data
    - Insert default services in French
*/

CREATE TABLE IF NOT EXISTS services (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text UNIQUE NOT NULL,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

ALTER TABLE services ENABLE ROW LEVEL SECURITY;

-- Policies for services
CREATE POLICY "Users can read all services"
  ON services
  FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "Users can insert services"
  ON services
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

CREATE POLICY "Users can update services"
  ON services
  FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

CREATE POLICY "Users can delete services"
  ON services
  FOR DELETE
  TO authenticated
  USING (true);

-- Insert default services
INSERT INTO services (name) VALUES
  ('Consultation'),
  ('Réunion de suivi'),
  ('Révision de projet'),
  ('Session de stratégie'),
  ('Session de formation')
ON CONFLICT (name) DO NOTHING;
</file>

<file path="supabase/migrations/20251116030215_20250907175927_broad_heart.sql">
/*
  # Complete Application Schema Setup

  1. New Tables
    - `user_profiles` - User information with roles and metadata
    - `clients` - Client information with contact details and service frequency
    - `appointments` - Appointment scheduling with client and service relationships

  2. Security
    - Enable RLS on all tables
    - Add policies for user data isolation
    - Admin users can access all data
    - Regular users can only access their own data

  3. Relationships
    - appointments.client_id → clients.id
    - appointments.service_id → services.id
    - appointments.user_id → user_profiles.id
    - clients.user_id → user_profiles.id

  4. Triggers
    - Auto-create user profile on auth signup
    - Auto-update timestamps
*/

-- Create user_profiles table
CREATE TABLE IF NOT EXISTS user_profiles (
  id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email text UNIQUE NOT NULL,
  full_name text NOT NULL DEFAULT '',
  role text NOT NULL DEFAULT 'user' CHECK (role IN ('admin', 'user')),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- Create clients table
CREATE TABLE IF NOT EXISTS clients (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  name text NOT NULL,
  phone text NOT NULL,
  address text NOT NULL,
  contact_person_name text NOT NULL,
  contact_person_phone text NOT NULL,
  frequency text NOT NULL DEFAULT 'monthly' CHECK (frequency IN ('weekly', 'biweekly', 'monthly', 'quarterly', 'custom')),
  custom_frequency_days integer,
  notes text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- Create appointments table
CREATE TABLE IF NOT EXISTS appointments (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  client_id uuid NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  service_id uuid REFERENCES services(id) ON DELETE SET NULL,
  date date NOT NULL,
  time time NOT NULL,
  duration integer NOT NULL DEFAULT 60,
  status text NOT NULL DEFAULT 'scheduled' CHECK (status IN ('scheduled', 'completed', 'cancelled')),
  notes text,
  price decimal(10,2),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- Enable RLS on all tables
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE clients ENABLE ROW LEVEL SECURITY;
ALTER TABLE appointments ENABLE ROW LEVEL SECURITY;

-- User profiles policies
CREATE POLICY "Users can read own profile"
  ON user_profiles
  FOR SELECT
  TO authenticated
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON user_profiles
  FOR UPDATE
  TO authenticated
  USING (auth.uid() = id);

CREATE POLICY "Admins can read all profiles"
  ON user_profiles
  FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

CREATE POLICY "Admins can update all profiles"
  ON user_profiles
  FOR UPDATE
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

CREATE POLICY "Allow profile creation"
  ON user_profiles
  FOR INSERT
  TO authenticated
  WITH CHECK (auth.uid() = id);

-- Clients policies
CREATE POLICY "Users can read own clients"
  ON clients
  FOR SELECT
  TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own clients"
  ON clients
  FOR INSERT
  TO authenticated
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own clients"
  ON clients
  FOR UPDATE
  TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own clients"
  ON clients
  FOR DELETE
  TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Admins can read all clients"
  ON clients
  FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

CREATE POLICY "Admins can manage all clients"
  ON clients
  FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

-- Appointments policies
CREATE POLICY "Users can read own appointments"
  ON appointments
  FOR SELECT
  TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own appointments"
  ON appointments
  FOR INSERT
  TO authenticated
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own appointments"
  ON appointments
  FOR UPDATE
  TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own appointments"
  ON appointments
  FOR DELETE
  TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Admins can read all appointments"
  ON appointments
  FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

CREATE POLICY "Admins can manage all appointments"
  ON appointments
  FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

-- Function to handle user profile creation
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO user_profiles (id, email, full_name, role)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'full_name', NEW.email),
    CASE 
      WHEN NEW.email = 'admin@company.com' THEN 'admin'
      ELSE 'user'
    END
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger to create user profile on signup
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION handle_new_user();

-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS trigger AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Triggers for updated_at
CREATE TRIGGER update_user_profiles_updated_at
  BEFORE UPDATE ON user_profiles
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_clients_updated_at
  BEFORE UPDATE ON clients
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_appointments_updated_at
  BEFORE UPDATE ON appointments
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Create indexes for better performance
CREATE INDEX IF NOT EXISTS idx_clients_user_id ON clients(user_id);
CREATE INDEX IF NOT EXISTS idx_appointments_user_id ON appointments(user_id);
CREATE INDEX IF NOT EXISTS idx_appointments_client_id ON appointments(client_id);
CREATE INDEX IF NOT EXISTS idx_appointments_date ON appointments(date);
CREATE INDEX IF NOT EXISTS idx_appointments_status ON appointments(status);
</file>

<file path="supabase/migrations/20251116030222_create_activity_logs_table.sql">
/*
  # Create Activity Logs Table

  1. New Tables
    - `activity_logs`
      - `id` (uuid, primary key)
      - `user_id` (uuid, foreign key to auth.users)
      - `action_type` (text: 'client_added', 'client_updated', 'client_deleted', 'appointment_added', 'appointment_updated', 'appointment_deleted', 'appointment_completed')
      - `entity_type` (text: 'client', 'appointment')
      - `entity_id` (uuid)
      - `entity_name` (text - name of the client or service)
      - `description` (text - human readable description)
      - `created_at` (timestamp)

  2. Security
    - Enable RLS on `activity_logs` table
    - Users can only see their own activity logs
    - Admins can see all activity logs

  3. Indexes
    - Index on user_id for faster queries
    - Index on created_at for sorting
    - Composite index on user_id and created_at
*/

CREATE TABLE IF NOT EXISTS activity_logs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  action_type text NOT NULL CHECK (action_type IN ('client_added', 'client_updated', 'client_deleted', 'appointment_added', 'appointment_updated', 'appointment_deleted', 'appointment_completed')),
  entity_type text NOT NULL CHECK (entity_type IN ('client', 'appointment')),
  entity_id uuid NOT NULL,
  entity_name text NOT NULL,
  description text NOT NULL,
  created_at timestamptz DEFAULT now()
);

ALTER TABLE activity_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can read own activity logs"
  ON activity_logs
  FOR SELECT
  TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Admins can read all activity logs"
  ON activity_logs
  FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

CREATE POLICY "System can insert activity logs"
  ON activity_logs
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

CREATE INDEX IF NOT EXISTS idx_activity_logs_user_id ON activity_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_activity_logs_created_at ON activity_logs(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_activity_logs_user_created ON activity_logs(user_id, created_at DESC);
</file>

<file path="supabase/migrations/20260104032659_create_expenses_table.sql">
/*
  # Create Expenses Table

  1. New Tables
    - `expenses`
      - `id` (uuid, primary key)
      - `user_id` (uuid, foreign key to auth.users)
      - `description` (text)
      - `amount` (decimal)
      - `category` (text: 'supplies', 'equipment', 'transportation', 'utilities', 'services', 'other')
      - `date` (date)
      - `created_at` (timestamp)
      - `updated_at` (timestamp)

  2. Security
    - Enable RLS on `expenses` table
    - Users can only see and manage their own expenses
    - Admins can see all expenses

  3. Indexes
    - Index on user_id for faster queries
    - Index on date for sorting
    - Index on category for filtering
*/

CREATE TABLE IF NOT EXISTS expenses (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  description text NOT NULL,
  amount numeric(10,2) NOT NULL,
  category text NOT NULL CHECK (category IN ('supplies', 'equipment', 'transportation', 'utilities', 'services', 'other')),
  date date NOT NULL,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

ALTER TABLE expenses ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can read own expenses"
  ON expenses
  FOR SELECT
  TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own expenses"
  ON expenses
  FOR INSERT
  TO authenticated
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own expenses"
  ON expenses
  FOR UPDATE
  TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own expenses"
  ON expenses
  FOR DELETE
  TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Admins can read all expenses"
  ON expenses
  FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

CREATE POLICY "Admins can manage all expenses"
  ON expenses
  FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

CREATE INDEX IF NOT EXISTS idx_expenses_user_id ON expenses(user_id);
CREATE INDEX IF NOT EXISTS idx_expenses_date ON expenses(date);
CREATE INDEX IF NOT EXISTS idx_expenses_category ON expenses(category);
CREATE INDEX IF NOT EXISTS idx_expenses_user_date ON expenses(user_id, date DESC);
</file>

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
.env
</file>

<file path="eslint.config.js">
import js from '@eslint/js';
import globals from 'globals';
import reactHooks from 'eslint-plugin-react-hooks';
import reactRefresh from 'eslint-plugin-react-refresh';
import tseslint from 'typescript-eslint';

export default tseslint.config(
  { ignores: ['dist'] },
  {
    extends: [js.configs.recommended, ...tseslint.configs.recommended],
    files: ['**/*.{ts,tsx}'],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
    plugins: {
      'react-hooks': reactHooks,
      'react-refresh': reactRefresh,
    },
    rules: {
      ...reactHooks.configs.recommended.rules,
      'react-refresh/only-export-components': [
        'warn',
        { allowConstantExport: true },
      ],
    },
  }
);
</file>

<file path="index.html">
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Application Web d'Outils Internes</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
</file>

<file path="package.json">
{
  "name": "vite-react-typescript-starter",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.53.0",
    "lucide-react": "^0.344.0",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^7.8.2"
  },
  "devDependencies": {
    "@eslint/js": "^9.9.1",
    "@types/react": "^18.3.5",
    "@types/react-dom": "^18.3.0",
    "@types/react-router-dom": "^5.3.3",
    "@vitejs/plugin-react": "^4.3.1",
    "autoprefixer": "^10.4.18",
    "eslint": "^9.9.1",
    "eslint-plugin-react-hooks": "^5.1.0-rc.0",
    "eslint-plugin-react-refresh": "^0.4.11",
    "globals": "^15.9.0",
    "postcss": "^8.4.35",
    "tailwindcss": "^3.4.1",
    "typescript": "^5.5.3",
    "typescript-eslint": "^8.3.0",
    "vite": "^7.3.1"
  }
}
</file>

<file path="postcss.config.js">
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
export default {
  content: ['./index.html', './src/**/*.{js,ts,jsx,tsx}'],
  theme: {
    extend: {},
  },
  plugins: [],
};
</file>

<file path="tsconfig.app.json">
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["src"]
}
</file>

<file path="tsconfig.json">
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
</file>

<file path="tsconfig.node.json">
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["ES2023"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="vite.config.ts">
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  optimizeDeps: {
    exclude: ['lucide-react'],
  },
});
</file>

<file path="vite.config.ts.timestamp-1768313357344-fd5005d808a2a8.mjs">
// vite.config.ts
import { defineConfig } from "file:///home/project/node_modules/vite/dist/node/index.js";
import react from "file:///home/project/node_modules/@vitejs/plugin-react/dist/index.mjs";
var vite_config_default = defineConfig({
  plugins: [react()],
  optimizeDeps: {
    exclude: ["lucide-react"]
  }
});
export {
  vite_config_default as default
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsidml0ZS5jb25maWcudHMiXSwKICAic291cmNlc0NvbnRlbnQiOiBbImNvbnN0IF9fdml0ZV9pbmplY3RlZF9vcmlnaW5hbF9kaXJuYW1lID0gXCIvaG9tZS9wcm9qZWN0XCI7Y29uc3QgX192aXRlX2luamVjdGVkX29yaWdpbmFsX2ZpbGVuYW1lID0gXCIvaG9tZS9wcm9qZWN0L3ZpdGUuY29uZmlnLnRzXCI7Y29uc3QgX192aXRlX2luamVjdGVkX29yaWdpbmFsX2ltcG9ydF9tZXRhX3VybCA9IFwiZmlsZTovLy9ob21lL3Byb2plY3Qvdml0ZS5jb25maWcudHNcIjtpbXBvcnQgeyBkZWZpbmVDb25maWcgfSBmcm9tICd2aXRlJztcbmltcG9ydCByZWFjdCBmcm9tICdAdml0ZWpzL3BsdWdpbi1yZWFjdCc7XG5cbi8vIGh0dHBzOi8vdml0ZWpzLmRldi9jb25maWcvXG5leHBvcnQgZGVmYXVsdCBkZWZpbmVDb25maWcoe1xuICBwbHVnaW5zOiBbcmVhY3QoKV0sXG4gIG9wdGltaXplRGVwczoge1xuICAgIGV4Y2x1ZGU6IFsnbHVjaWRlLXJlYWN0J10sXG4gIH0sXG59KTtcbiJdLAogICJtYXBwaW5ncyI6ICI7QUFBeU4sU0FBUyxvQkFBb0I7QUFDdFAsT0FBTyxXQUFXO0FBR2xCLElBQU8sc0JBQVEsYUFBYTtBQUFBLEVBQzFCLFNBQVMsQ0FBQyxNQUFNLENBQUM7QUFBQSxFQUNqQixjQUFjO0FBQUEsSUFDWixTQUFTLENBQUMsY0FBYztBQUFBLEVBQzFCO0FBQ0YsQ0FBQzsiLAogICJuYW1lcyI6IFtdCn0K
</file>

<file path=".github/workflows/main.yml">
name: Backup Supabase Live

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Installer PostgreSQL 17
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg2
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17

      - name: Run dump
        run: |
          /usr/lib/postgresql/17/bin/pg_dump "${{ secrets.DB_URL }}" --no-owner --no-privileges > backup.sql

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: mon-backup-db
          path: backup.sql
          retention-days: 30
</file>

</files>
